<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[LoÃ¯c Faugeron]]></title>
    <link href="/feed/atom.xml" rel="self"/>
    <link href="/"/>
    <updated>2025-11-19T06:39:53+00:00</updated>
    <id>http://gnugat.github.com</id>
            <author>
            <name><![CDATA[LoÃ¯c Faugeron]]></name>            <email><![CDATA[faugeron.loic@gmail.com]]></email>        </author>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 6: From PHP 5 to PHP 8]]></title>
            <link href="/2025/11/19/xl-6-php-8.html"/>
            <updated>2025-11-19T00:00:00+00:00</updated>
            <id>/2025/11/19/xl-6-php-8.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ğŸ¤˜ The Migration Warlord breaks the rusted shackles of PHP 5.6,
  leading the great exodus through the valleys of breaking changes,
  into the promised land of PHP 8.4 where type hints
  and constructor property promotion await in glory! ğŸ”¥</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">ğŸ‹ got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">ğŸ’¨ written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">ğŸ¯ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">ğŸ§¹ created and applied Coding Standards</a></li>
<li><a href="/2025/10/22/xl-5-pdo.html">â›ƒ migrated to PDO</a></li>
</ol>

<p>This means we can run it locally (http://localhost:43000/),
and have some level of automated tests.</p>

<p>But it's still stuck in the past with PHP 5.6,
so let's upgrade it to PHP 8.4!</p>

<ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#rector">Rector</a></li>
<li><a href="#php-cs-fixer">PHP CS Fixer</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="docker">Docker</h2>

<p>With the migration from the deprecated MySQL extension to PDO,
BisouLand's codebase is technically compatible with the latest PHP version.</p>

<p>At least that's what Claude tells me.</p>

<p>If that's true, then upgrading it is as simple as modifying the monolith's Dockerfile:</p>

<pre><code class="diff">- # Uses PHP 5.6 with PDO MySQL driver
+ # Uses PHP 8.4 with PDO MySQL driver

- FROM php:5.6-apache
- 
- # Update sources.list to use archive repositories for Debian Stretch
- RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list \
-     &amp;&amp; sed -i 's/security.debian.org/archive.debian.org/g' /etc/apt/sources.list \
-     &amp;&amp; sed -i '/stretch-updates/d' /etc/apt/sources.list
+ FROM php:8.4-apache
</code></pre>

<p>We can now build the new image:</p>

<pre><code class="console">cd apps/monolith
make app-init # docker down, docker build, docker up 
</code></pre>

<p>And that's it, welcome to the future!</p>

<h2 id="rector">Rector</h2>

<p>Your eXtreme Legacy application might not be as lucky as BisouLand,
and might require more work for an upgrade.</p>

<p>One way to do so is to use <a href="https://getrector.com/">Rector</a>,
an automated refactoring tool that uses the power of AST to make sure the
changes it makes are safe (i.e. non breaking) to do. Let's install it:</p>

<pre><code class="console">cd apps/qa
make composer arg='require --dev rector/rector'
</code></pre>

<p>We then need to configure it by creating the <code>rector.php</code> file:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

use Rector\Caching\ValueObject\Storage\FileCacheStorage;
use Rector\Config\RectorConfig;
use Rector\Set\ValueObject\SetList;

return RectorConfig::configure()
    -&gt;withCache(
        // CI compatible temporary paths for cach
        cacheDirectory: '/tmp/rector',
        cacheClass: FileCacheStorage::class,
    )
    -&gt;withPaths([
        __DIR__,
        __DIR__.'/../monolith',
    ])
    -&gt;withSkip([
        // â€”â€” Excluded paths â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        // [qa]
        __DIR__.'/vendor',
        // [monolith]
        __DIR__.'/../monolith/vendor',
    ])
    -&gt;withSets([
        // â€”â€” PHP â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        SetList::PHP_56,
    ]);
</code></pre>

<p>We can then run it as follow:</p>

<pre><code class="console">make rector # ./vendor/bin/rector
</code></pre>

<p>This initial run will ensure both the Monolith and QA apps are PHP 5.6 compliant,
which they are so no changes done.</p>

<p>We can be bold and brave and change Rector's config straight from <code>SetList::PHP_56</code>
to <code>SetList::PHP_84</code>, which will then make all the necessary upgrades from PHP 5.6 to 8.4,
but incremental steps are safer so we'll start with PHP 7.0:</p>

<pre><code class="console">sed -i -e 's/PHP_56/PHP_70/g' ./rector.php
# ğŸ On Mac: sed -i '' -e 's/PHP_56/PHP_70/g' ./rector.php
</code></pre>

<p>Running it (<code>make rector</code>) will spot one change that needs to be done:
replace <code>rand()</code> with <code>random_int()</code>:</p>

<pre><code class="diff">              // Si les bisous du dÃ©fenseurs sont prÃ©sent, donc qu'il n'attaque pas.
              if (0 == $DefBloque) {
-                 $DefSmack = floor($DefSmack * (1 - 1 / rand(2, 10)));
-                 $DefBaiser = floor($DefBaiser * (1 - 1 / rand(2, 10)));
-                 $DefPelle = floor($DefPelle * (1 - 1 / rand(2, 10)));
+                 $DefSmack = floor($DefSmack * (1 - 1 / random_int(2, 10)));
+                 $DefBaiser = floor($DefBaiser * (1 - 1 / random_int(2, 10)));
+                 $DefPelle = floor($DefPelle * (1 - 1 / random_int(2, 10)));
              }
</code></pre>

<p>Technically <code>rand</code> is still supported in PHP 8,
but it does not generate cryptographically secure digits,
so <code>random_int</code> is recommended instead.</p>

<p>Next step is to upgrade to PHP 7.1, which detects no changes,
so we're safe to upgrade to PHP 7.2, which detects no changes,
so we're safe to upgrade to PHP 7.3, which detects some changes!</p>

<p>The function <code>setcookie</code> can take an array of options as a third parameter
(and yes, we store the password in the cookie. This will need to be fixed later):</p>

<pre><code class="diff">                      if (isset($_POST['auto'])) {
                          $timestamp_expire = time() + 30 * 24 * 3600;
-                         setcookie('pseudo', $pseudo, $timestamp_expire);
-                         setcookie('mdp', $mdp, $timestamp_expire);
+                         setcookie('pseudo', $pseudo, ['expires' =&gt; $timestamp_expire]);
+                         setcookie('mdp', $mdp, ['expires' =&gt; $timestamp_expire]);
                      }
</code></pre>

<p>Next step is to upgrade to PHP 7.4, which detects no changes,
so we're safe to upgrade to PHP 8.0, which detects no changes,
so we're safe to upgrade to PHP 8.1, which detects some changes!</p>

<p>This is an interesting one, as it enforces the type of variables for function
calls that expect for example a string but might receive <code>null</code>:</p>

<pre><code class="diff">      $pdo = bd_connect();
      if (isset($_POST['action'])) {
          $cout = 0;
-         $nuageCible = htmlentities($_POST['nuage']);
-         $positionCible = htmlentities($_POST['position']);
+         $nuageCible = htmlentities((string) $_POST['nuage']);
+         $positionCible = htmlentities((string) $_POST['position']);
</code></pre>

<p>Next step is to upgrade to PHP 8.1, which detects no changes,
so we're safe to upgrade to PHP 8.2, which detects no changes,
so we're safe to upgrade to PHP 8.3, which detects no changes,
so we're safe to upgrade to PHP 8.4, which detects some changes!</p>

<p>This one is for the QA app, it removes the now unnecessary parenthesis around
object instantiation:</p>

<pre><code class="diff">-         (new Dotenv())-&gt;load(__DIR__.'/../../../monolith/.env');
+         new Dotenv()-&gt;load(__DIR__.'/../../../monolith/.env');
</code></pre>

<p>And that's it.</p>

<h2 id="php-cs-fixer">PHP CS Fixer</h2>

<p>With the latest version of PHP,
we can change or Coding Style in <code>.php-cc-fixer.dist.php</code>
to take into account new changes:</p>

<pre><code class="diff">-         // â€”â€” Disabed rules due to PHP version compatibility â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
- 
-         // [PER-CS2.0] Partially disabled due to PHP version constraints.
-         'trailing_comma_in_multiline' =&gt; [
-             'after_heredoc' =&gt; true,
-             'elements' =&gt; [
-                 // 'arguments', For PHP 7.3+
-                 // 'array_destructuring', For PHP 7.1+
-                 'arrays',
-                 // 'match', For PHP 8.0+
-                 // 'parameters', For PHP 8.0+
-             ],
-         ],
+         // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
+ 
+         // [Symfony] Adding `['elements']['parameters']` (Symfony doesn't have it)
+         'trailing_comma_in_multiline' =&gt; [
+             'after_heredoc' =&gt; true,
+             'elements' =&gt; [
+                 'arguments',
+                 'array_destructuring',
+                 'arrays',
+                 'match',
+                 'parameters',
+             ],
+         ] ,
</code></pre>

<p>But that's not all. PHP CS Fixer also has rule set to help us migrate the style
from old PHP versions to new ones, which we'll do incrementally.</p>

<p>First we enable the rule sets:</p>

<pre><code class="diff">          // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          '@Symfony' =&gt; true,
          '@Symfony:risky' =&gt; true,
+         '@PHP7x0Migration' =&gt; true,
+         '@PHP7x0Migration:risky' =&gt; true,
</code></pre>

<p>And we run it with <code>make cs-fix</code>. It's detected some changes:
replacing <code>mt_rand</code> which is also not cryptographically secure with <code>random_int</code>:</p>

<pre><code class="diff">          // On choisi une valeur au hasard.

-         $FinalPos = $FreePos[mt_rand(0, $nbLibre - 1)];
+         $FinalPos = $FreePos[random_int(0, $nbLibre - 1)];
</code></pre>

<p>Next step we upgrade the rule set to PHP 7.1</p>

<pre><code class="console">sed -i -e 's/PHP7x0/PHP7x1/g' ./.php-cs-fixer.dist.php
# ğŸ On Mac: sed -i '' -e 's/PHP7x0/PHP7x1/g' ./php-cs-fixer.dist.php
</code></pre>

<p>Running it, we get <code>void</code> return type hints:</p>

<pre><code class="diff">- function GiveNewPosition($idJoueur)
+ function GiveNewPosition($idJoueur): void
  {
      $pdo = bd_connect();
      $sql_info = $pdo-&gt;query('SELECT nombre FROM nuage WHERE id=1');
</code></pre>

<p>Next step is to upgrade to PHP 7.2, which detects no changes,
so we're safe to upgrade to PHP 7.3, which detects some changes!</p>

<p>This one is related to HEREDOC indentation.</p>

<p>I'm gonna be brief now, as after that, upgrading all the way to PHP 8.4,
there were no changes.</p>

<h2 id="conclusion">Conclusion</h2>

<p>With a modern version of PHP, not only do we get security patches,
exciting new feature (typed code, constructor property promotion, readonly final classes, etc),
as well as access to many modern tools and libraries (composer, Symfony components, etc),
but we also get a boost in performance.</p>

<p>Let's back up that last claim by running some vanity benchmarks as follow:</p>

<ol>
<li>start a fresh Monolith container</li>
<li>sign up and log in a temporary account</li>
<li>test load the homepage, as a visitor (not logged in)</li>
<li>test load the Brain page (logged in)</li>
</ol>

<pre><code class="console"># Start fresh
cd apps/monolith
make app-init

BENCH_USER="BisouTest_bench"
BENCH_PASS="SuperSecret123"

# Sign up
curl -X POST 'http://localhost:43000/inscription.html' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "Ipseudo=${BENCH_USER}&amp;Imdp=${BENCH_PASS}&amp;Imdp2=${BENCH_PASS}&amp;inscription=S%27inscrire"

# Log in
BENCH_COOKIE=$(curl -X POST 'http://localhost:43000/redirect.php' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "pseudo=${BENCH_USER}&amp;mdp=${BENCH_PASS}&amp;connexion=Se+connecter" \
  -i -s | grep -i 'set-cookie: PHPSESSID' | sed 's/.*PHPSESSID=\([^;]*\).*/\1/' | tr -d '\r')

# Test load homepage (not signed in)
ab -l -q -k -c 50 -n 10000 http://localhost:43000/ \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"

# Test load Brain page (signed in)
ab -l -q -k -c 50 -n 10000 -C "PHPSESSID=$BENCH_COOKIE" http://localhost:43000/cerveau.html \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"
</code></pre>

<p>On my MacBook M4 (with Docker), the results are as follow:</p>

<ul>
<li>Homepage: <code>+8.9%</code> improvement

<ul>
<li>Requests per second (mean):
from <code>545.67</code> to <code>594.49</code></li>
<li>Time per request (ms, mean, across all concurrent requests):
from <code>1.833</code> to <code>1.682</code></li>
</ul></li>
<li>Brain Page: <code>+30.2%</code> improvement

<ul>
<li>Requests per second (mean):
from <code>313.88</code> to <code>408.78</code></li>
<li>Time per request (ms, mean, across all concurrent requests):
from <code>3.186</code> to <code>2.446</code></li>
</ul></li>
</ul>

<p>Surely with such almighty gains we won't need to rewrite BisouLand in go / rust.</p>

<blockquote>
  <p>â‰ï¸ What do you mean, "the code is still unrefactorable"?</p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 5: PDO]]></title>
            <link href="/2025/10/22/xl-5-pdo.html"/>
            <updated>2025-10-22T00:00:00+01:00</updated>
            <id>/2025/10/22/xl-5-pdo.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ğŸ¤˜ The Parameter Paladin storms forth from the OWASP bastion,
  raising the impenetrable shield of Prepared Statements,
  against the shadow army of malicious injections,
  that seek to corrupt the sacred data temples! ğŸ”¥</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">ğŸ‹ got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">ğŸ’¨ written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">ğŸ¯ written End to End Tests</a></li>
<li><a href="/2025/10/01/xl-4-coding-standards.html">ğŸ§¹ created and applied Coding Standards</a></li>
</ol>

<p>This means we can run it locally (http://localhost:8080/),
and have some level of automated tests.</p>

<p>But it's currently riddled with deprecated calls to <code>mysql_query()</code>,
so let's upgrade the codebase to PDO!</p>

<ul>
<li><a href="#sql-injection-vulnerabilities">SQL Injection vulnerabilities</a></li>
<li><a href="#docker">Docker</a></li>
<li><a href="#connection">Connection</a></li>
<li><a href="#queries">Queries</a></li>
<li><a href="#fixes">Fixes</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="sql-injection-vulnerabilities">SQL Injection vulnerabilities</h2>

<p>Before we start, a note on security vulnerabilities.</p>

<p>The BisouLand SQL queries are full of input values directly concatenated
in the SQL queries, like here:</p>

<pre><code class="php">// SignUp form: inscription.php
$result = mysql_query(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ."VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
</code></pre>

<p>This would clearly be a SQL injection risk,
as someone could submit the following username:</p>

<pre><code>Eisenberg', '938c2cc0dcc05f2b68c4287040cfcf71', '1', 1759645024, 1759645024, '42000'); --
</code></pre>

<p>Which would create the user as expected,
but with 42k Love Points instead of the expected 300:</p>

<pre><code class="sql">INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)
VALUES ('Eisenberg', '938c2cc0dcc05f2b68c4287040cfcf71', '1', 1759645024, 1759645024, '42000');
-- ', '938c2cc0dcc05f2b68c4287040cfcf71', '1', 1759645024, 1759645024, '300')
</code></pre>

<p>However looking a bit closer at the code,
we can see that most of the time the user input is validated and sanitised,
for example in the sign-up form the username:</p>

<ul>
<li>cannot be too long</li>
<li>can only be alphanumerical characters</li>
<li><code>addslashes()</code> escapes <code>'</code>, <code>"</code>, <code>\</code> and NULL bytes</li>
<li><code>htmlentities()</code> escapes HTML characters like <code>&lt;</code>, <code>&gt;</code>, <code>'</code></li>
</ul>

<p>Which effectively prevents SQL Injection:</p>

<pre><code class="php">// SignUp form: inscription.php
$pseudo = htmlentities(addslashes($_POST['Ipseudo']));
$mdp = htmlentities(addslashes($_POST['Imdp']));

$taille = strlen(trim($_POST['Ipseudo']));
if ($taille &gt;= 4 &amp;&amp; $taille &lt;= 15) {
    // ...
    $result = mysql_query(
        'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
        ." VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
    );
}
</code></pre>

<p>Regardless, using PDO with prepared statements will make sure we don't accidentally
introduce SQL vulnerabilities.</p>

<h2 id="docker">Docker</h2>

<p>The first thing we're going to do is update the <code>apps/monolith/Dockerfile</code>,
as we'll now need the PDO extension and its MySQL companion,
instead of the MySQL solo extension:</p>

<pre><code class="Dockerfile"># ...

# Install system dependencies and PHP extensions in single layer
RUN docker-php-ext-install pdo pdo_mysql \
    &amp;&amp; a2enmod rewrite

# ...
</code></pre>

<p>This change will require us to update the container:</p>

<pre><code class="console"># in apps/monolith
make down
make build
make up
</code></pre>

<h2 id="connection">Connection</h2>

<p>Then we have to take care of the <code>mysql_pconnect</code>,
located in <code>apps/monolith/phpincludes/bd.php</code>:</p>

<pre><code class="php">&lt;?php

include __DIR__.'/../config/parameters.php';

function bd_connect()
{
    mysql_pconnect(
        DATABASE_HOST.':'.DATABASE_PORT,
        DATABASE_USER,
        DATABASE_PASSWORD
    );
    mysql_select_db(DATABASE_NAME);
}
</code></pre>

<p>This creates a persistent connection, for the current HTTP request.</p>

<p>We're going to replace it with PDO (PHP Data Object, what a weird name),
the out of the box Database Abstraction Layer:</p>

<pre><code class="php">&lt;?php

include __DIR__.'/../config/parameters.php';

function bd_connect()
{
    static $pdo = null;

    if (null === $pdo) {
        $dsn = 'mysql:host='.DATABASE_HOST.';port='.DATABASE_PORT.';dbname='.DATABASE_NAME.';charset=utf8mb4';
        $options = [
            // Throw exceptions on error
            PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION,
            // Return query results as associative arrays (column name =&gt; value)
            PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,
            // Use prepared statements at the database layer, for better security and performance
            PDO::ATTR_EMULATE_PREPARES =&gt; false,
        ];
        $pdo = new PDO($dsn, DATABASE_USER, DATABASE_PASSWORD, $options);
    }

    return $pdo;
}
</code></pre>

<p>We then need to change the usage of the function in the codebase:</p>

<ul>
<li>from <code>bd_connect()</code> to <code>$pdo = bd_connect()</code></li>
</ul>

<p>The <code>bd_connect</code> has been transformed into a Singleton,
it will always return the same instance of PDO (for the duration of the HTTP Request).</p>

<p>I'd normally frown at this but this is a temporary measure:
my intention is to later in the series introduce a Dependency Injection Container,
and instead of having those <code>$pdo = bd_connect()</code> statements,
we'll have <code>$pdo = $container-&gt;get(PDO::class);</code>.</p>

<h2 id="queries">Queries</h2>

<p>It's then a game of finding and replacing all <code>mysql_*</code> functions:</p>

<ul>
<li>from <code>mysql_query()</code> to <code>$pdo-&gt;prepare(); $pdo-&gt;execute()</code> or <code>$pdo-&gt;query()</code></li>
<li>from <code>mysql_fetch_assoc()</code> to <code>$pdo-&gt;fetch()</code></li>
<li>from <code>mysql_result()</code> to <code>$pdo-&gt;fetchColumn()</code></li>
<li>from <code>mysql_num_rows()</code> to <code>$pdo-&gt;rowCount()</code> or <code>$pdo-&gt;fetchColumn()</code></li>
<li>from <code>mysql_insert_id()</code> to <code>$pdo-&gt;lastInsertId()</code></li>
</ul>

<p>For example in <code>apps/monolith/web/phpincludes/inscription.php</code>:</p>

<pre><code class="php">$result = mysql_query(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ."VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
if (false === $result) {
    echo 'Error: '.mysql_error();
}
$id = mysql_insert_id();
</code></pre>

<p>Becomes:</p>

<pre><code class="php">$stmt = $pdo-&gt;prepare(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    .' VALUES (:pseudo, :mdp, :confirmation, :timestamp, :lastconnect, :amour)'
);
$stmt-&gt;execute([
    'pseudo' =&gt; $pseudo,
    'mdp' =&gt; $hmdp,
    'confirmation' =&gt; 1,
    'timestamp' =&gt; time(),
    'lastconnect' =&gt; time(),
    'amour' =&gt; 300,
]);
$id = $pdo-&gt;lastInsertId();
</code></pre>

<p>There were 25 PHP files with ~250+ of such calls, by the way.</p>

<p>And before we forget,
with prepared statements we no longer need calls to <code>addslashes()</code>,
so we can also removed them.</p>

<h2 id="fixes">Fixes</h2>

<p>We shouldn't stop there. There's an issue we've encountered in a previous article,
where the code was using <code>''</code> for the <code>id</code> column in <code>INSERT</code> statements.</p>

<p>This was relying on string to integer conversion,
which MySQL supported until version 5.7.</p>

<p>After a quick look, I've found 5 more instances of these, which I've now fixed.</p>

<p>And last but not least, still on the topic of string to integer conversion,
there are other integer fields that are receiving strings:</p>

<ol>
<li><code>web/phpincludes/inscription.php</code>:

<ul>
<li><code>'1'</code> is used for the confirmation field, should be <code>1</code> (TINYINT field)</li>
<li><code>'300'</code> is used for the amour field, should be <code>300</code> (INT field)</li>
</ul></li>
<li><code>web/phpincludes/lire.php</code>: <code>'1'</code> is used for status (INT field)</li>
<li><code>web/phpincludes/attaque.php</code>: <code>'0'</code> is used for finaller (INT field)</li>
<li><code>web/news/liste_news.php</code>: <code>'0'</code> is used for timestamp_modification (INT field)</li>
<li><code>web/phpincludes/cerveau.php</code>: <code>'1'</code> is used for confirmation (TINYINT field)</li>
<li><code>web/phpincludes/membres.php</code>: <code>'1'</code> is used for confirmation (TINYINT field)</li>
</ol>

<h2 id="conclusion">Conclusion</h2>

<p>This has been a lot of effort, and there's seemingly not a lot to show for it.</p>

<p>But by switching from the MySQL extension to PDO, we've unlocked something amazing:
we will be able to upgrade to the latest version of PHP,
which will provide a big performance boost as well as many security patches.</p>

<p>And we will be able to switch to PostgreSQL!</p>

<blockquote>
  <p>â‰ï¸ <em>What do you mean, "PHP is slow and we should use go / rust"?</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 4: Coding Standards]]></title>
            <link href="/2025/10/01/xl-4-coding-standards.html"/>
            <updated>2025-10-01T00:00:00+01:00</updated>
            <id>/2025/10/01/xl-4-coding-standards.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ğŸ¤˜ The Coding Standards Inquisitor rises from the sulphurous pits of Legacy Chaos,
  brandishing the iron scriptures of Style Guides,
  purging the realm of inconsistent formatting with flames of automated linting! ğŸ”¥</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">ğŸ‹ got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">ğŸ’¨ written Smoke Tests</a></li>
<li><a href="/2025/09/24/xl-3-end-to-end-tests.html">ğŸ¯ written End to End Tests</a></li>
</ol>

<p>This means we can run it locally (http://localhost:8080/),
and have some level of automated tests.</p>

<p>But the code is ugly!</p>

<p>So we're going to establish beautiful Coding Standards,
which will be today's fourth article focus,
and enforce them automatically using PHP CS Fixer.</p>

<ul>
<li><a href="#level-0%3A-setup">Level 0: setup</a></li>
<li><a href="#level-1%3A-psr-1">Level 1: PSR-1</a></li>
<li><a href="#level-2%3A-psr-2">Level 2: PSR-2</a></li>
<li><a href="#level-3%3A-psr-12">Level 3: PSR-12</a></li>
<li><a href="#level-4%3A-per-cs-2.0">Level 4: PER-CS 2.0</a></li>
<li><a href="#level-5%3A-symfony">Level 5: Symfony</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="level-0%3A-setup">Level 0: setup</h2>

<p>We will not start with the highest quality standard,
as this would make it too difficult to track the changes.</p>

<p>Instead we'll:</p>

<ul>
<li>start with an empty configuration, run the tool, check the changes</li>
<li>then add the smallest set of CS rule we can think of, run again and check</li>
<li>iterate by adding more and more rules</li>
</ul>

<p>Ideally, teams should discuss and agree on a select list of rules to follow,
but <a href="https://cs.symfony.com/doc/rules/index.html">the list of possible rules is too overwhelming</a>.</p>

<p>So instead of picking rules one by one,
we can rely on <a href="https://cs.symfony.com/doc/ruleSets/index.html">rule sets</a>.</p>

<p>My humble opinion is that the <a href="https://cs.symfony.com/doc/ruleSets/Symfony.html">Symfony CS</a>
are the best, but that'd be too many rules to add in one go.</p>

<p>If we check the Symfony rule set doc, at the top we can see <code>@PER-CS3x0</code>.</p>

<p>Rules that start with <code>@</code> are actually rulesets,
so Symfony depends on other smaller rulesets,
and those smaller rulesets also depend on other smaller rulesets.</p>

<p>It's a tedious task,
but we can navigate the documentation website,
construct the tree of rule sets used,
and then start with the smaller one:</p>

<ol>
<li><a href="https://www.php-fig.org/psr/psr-1/">PSR-1: Basic Coding Standard</a></li>
<li><a href="https://www.php-fig.org/psr/psr-2/">PSR-2: Coding Style Guide - deprecated</a></li>
<li><a href="https://www.php-fig.org/psr/psr-12/">PSR-12: Extended Coding Style</a></li>
<li><a href="https://www.php-fig.org/per/coding-style/">PER-CS 2.0: Coding Style</a>
(turns out there's a PER-CS 3.0 since July 2025!)</li>
</ol>

<p>For each rule set, we then check if anything is breaking,
and if so we exclude the specific rule.</p>

<p>Let's start with an empty configuration in <code>apps/qa/.php-cs-fixer.php.dist</code>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Running it will not report any problems:</p>

<pre><code class="console">&gt; make cs-check // equivalent to: ./vendor/bin/php-cs-fixer check --verbose
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%


Found 0 of 43 files that can be fixed in 0.105 seconds, 18.00 MB memory used
</code></pre>

<h2 id="level-1%3A-psr-1">Level 1: PSR-1</h2>

<p>Let's add the <a href="https://cs.symfony.com/doc/ruleSets/PSR1.html">PSR-1 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        '@PSR1' =&gt; true,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>This will make sure we use:</p>

<ul>
<li><a href="https://cs.symfony.com/doc/rules/php_tag/full_opening_tag.html">full opening tag</a>
(not <code>&lt;?</code> but <code>&lt;?php</code>)</li>
<li><a href="https://cs.symfony.com/doc/rules/basic/encoding.html">encoding</a>
(not BOM, UTF-8)</li>
</ul>

<p>Let's run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

   1) ../monolith/web/news/chemin.php (full_opening_tag)

Found 1 of 43 files that can be fixed in 0.103 seconds, 18.00 MB memory used
</code></pre>

<p>There's one file that uses <code>&lt;?</code>, to automatically fix it we run:</p>

<pre><code class="console">&gt; make cs-fix // equivalent to: ./vendor/bin/php-cs-fixer fix --verbose
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

   1) ../monolith/web/news/chemin.php (full_opening_tag)

Fixed 1 of 43 files in 0.107 seconds, 18.00 MB memory used
</code></pre>

<p>And that's PSR-1 done and dusted.</p>

<h2 id="level-2%3A-psr-2">Level 2: PSR-2</h2>

<p>Time for the <a href="https://cs.symfony.com/doc/ruleSets/PSR2.html">PSR-2 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        '@PSR2' =&gt; true,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>It adds about 30 new rules,
mainly regarding brace placement and indentation formatting.</p>

<p>Let's run a check:</p>

<pre><code class="console">&gt; make cs-check
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

   1) ../monolith/web/calcul.php (no_closing_tag, no_trailing_whitespace, single_blank_line_at_eof)
   2) ../monolith/web/redirect.php (indentation_type, single_space_around_construct, method_argument_space, no_closing_tag, braces_position, statement_indentation, single_blank_line_at_eof)
   3) ../monolith/web/checkConnect.php (indentation_type, elseif, single_space_around_construct, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation,single_blank_line_at_eof)
   4) ../monolith/web/phpincludes/fctIndex.php (indentation_type, single_space_around_construct, method_argument_space, spaces_inside_parentheses, control_structure_braces, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation, single_blank_line_at_eof)
   5) ../monolith/web/phpincludes/topten.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position, statement_indentation)
   6) ../monolith/web/phpincludes/pages.php (indentation_type, no_closing_tag, statement_indentation, single_blank_line_at_eof)
   7) ../monolith/web/config/parameters.php (single_blank_line_at_eof)
   8) ../monolith/web/deconnexion.php (indentation_type, single_space_around_construct, no_closing_tag, braces_position, single_blank_line_at_eof)
   9) ../monolith/web/news/rediger_news.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position, statement_indentation)
  10) ../monolith/web/news/chemin.php (no_closing_tag, single_blank_line_at_eof)
  11) ../monolith/web/news/liste_news.php (indentation_type, single_space_around_construct, lowercase_keywords, braces_position, statement_indentation)
  12) ../monolith/web/phpincludes/evo.php (indentation_type, single_space_around_construct, method_argument_space, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation, single_blank_line_at_eof)
  13) ../monolith/web/phpincludes/stats.php (indentation_type, method_argument_space, statement_indentation)
  14) ../monolith/web/phpincludes/infos.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  15) ../monolith/web/phpincludes/yeux.php (indentation_type, single_space_around_construct, method_argument_space, no_trailing_whitespace, braces_position, statement_indentation)
  16) ../monolith/web/phpincludes/inscription.php (indentation_type, single_space_around_construct, method_argument_space, spaces_inside_parentheses, braces_position, statement_indentation)
  17) ../monolith/web/phpincludes/faq.php (indentation_type, braces_position, statement_indentation)
  18) ../monolith/web/phpincludes/construction.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, braces_position, statement_indentation)
  19) ../monolith/web/phpincludes/recherche.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position)
  20) ../monolith/web/phpincludes/bd.php (braces_position, statement_indentation)
  21) ../monolith/web/phpincludes/accueil.php (indentation_type, no_trailing_whitespace, braces_position, statement_indentation)
  22) ../monolith/web/phpincludes/lire.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  23) ../monolith/web/phpincludes/membres.php (indentation_type, single_space_around_construct, method_argument_space, no_trailing_whitespace, braces_position, statement_indentation)
  24) ../monolith/web/phpincludes/nuage.php (indentation_type, single_space_around_construct, method_argument_space, no_trailing_whitespace, braces_position, statement_indentation)
  25) ../monolith/web/phpincludes/attaque.php (indentation_type, single_space_around_construct, method_argument_space, no_closing_tag, no_trailing_whitespace, no_trailing_whitespace_in_comment, no_multiple_statements_per_line, braces_position, statement_indentation, single_blank_line_at_eof)
  26) ../monolith/web/phpincludes/confirmation.php (indentation_type, single_space_around_construct, method_argument_space, spaces_inside_parentheses, no_closing_tag, no_trailing_whitespace, braces_position, statement_indentation, single_blank_line_at_eof)
  27) ../monolith/web/phpincludes/changepass.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, spaces_inside_parenthes, no_trailing_whitespace, braces_position, statement_indentation)
  28) ../monolith/web/phpincludes/techno.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, braces_position, statement_indentation)
  29) ../monolith/web/phpincludes/newpass.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, spaces_inside_parentheses,no_trailing_whitespace, braces_position, statement_indentation)
  30) ../monolith/web/makeBan.php (indentation_type, single_space_around_construct, method_argument_space, no_spaces_after_function_name, spaces_inside_parentheses, no_closing_tag, braces_position, statement_indentation, single_blank_line_at_eof)
  31) ../monolith/web/index.php (indentation_type, single_space_around_construct, method_argument_space, control_structure_braces, no_trailing_whitespace, no_trailing_whitespace_in_comment, braces_position, statement_indentation)
  32) ../monolith/web/phpincludes/livreor.php (indentation_type, single_space_around_construct, no_trailing_whitespace, braces_position, statement_indentation)
  33) ../monolith/web/phpincludes/connexion.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  34) ../monolith/web/phpincludes/boite.php (indentation_type, single_space_around_construct, method_argument_space, control_structure_braces, lowercase_keywords, no_trailing_whitespace, braces_position, statement_indentation)
  35) ../monolith/web/phpincludes/connected.php (indentation_type, single_space_around_construct, braces_position, statement_indentation)
  36) ../monolith/web/phpincludes/envoi.php (indentation_type, single_space_around_construct, method_argument_space, braces_position, statement_indentation)
  37) ../monolith/web/phpincludes/action.php (indentation_type, single_space_around_construct, method_argument_space, braces_position, statement_indentation)

Found 37 of 43 files that can be fixed in 0.207 seconds, 18.00 MB memory used

Files that were not fixed due to errors reported during linting after fixing:
   1) /apps/qa/../monolith/web/phpincludes/cerveau.php
   2) /apps/qa/../monolith/web/phpincludes/bisous.php
</code></pre>

<p>We have lots of changes,
but what I'd like to focus more on is the two errors at the end.</p>

<p>To find out what specific rules are concerned,
we can replaced <code>PSR2</code> with <a href="https://cs.symfony.com/doc/ruleSets/PSR2.html">all the individual rules it includes</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // '@PSR2' =&gt; true,
        '@PSR1' =&gt; true,

        'blank_line_after_namespace' =&gt; true,
        'braces_position' =&gt; true,
        'class_definition' =&gt; true,
        'constant_case' =&gt; true,
        'control_structure_braces' =&gt; true,
        'control_structure_continuation_position' =&gt; true,
        'elseif' =&gt; true,
        'function_declaration' =&gt; ['closure_fn_spacing' =&gt; 'one'],
        'indentation_type' =&gt; true,
        'line_ending' =&gt; true,
        'lowercase_keywords' =&gt; true,
        'method_argument_space' =&gt; ['after_heredoc' =&gt; false, 'attribute_placement' =&gt; 'ignore', 'on_multiline' =&gt; 'ensure_fully_multiline'],
        'modifier_keywords' ['elements' =&gt; ['method', 'property']],
        'no_break_comment' =&gt; true,
        'no_closing_tag' =&gt; true,
        'no_multiple_statements_per_line' =&gt; true,
        'no_space_around_double_colon' =&gt; true,
        'no_spaces_after_function_name' =&gt; true,
        'no_trailing_whitespace' =&gt; true,
        'no_trailing_whitespace_in_comment' =&gt; true,
        'single_blank_line_at_eof' =&gt; true,
        'single_class_element_per_statement' =&gt; ['elements' =&gt; ['property']],
        'single_import_per_statement' =&gt; true,
        'single_line_after_imports' =&gt; true,
        'single_space_around_construct' =&gt; ['constructs_followed_by_a_single_space' =&gt; ['abstract', 'as', 'case', 'catch', 'class', 'do', 'else', 'elseif', 'final', 'for', 'foreach', 'function', 'if', 'interface', 'namespace', 'private', 'protected', 'public', 'static', 'switch', 'trait', 'try', 'use_lambda', 'while'], 'constructs_preceded_by_a_single_space' =&gt; ['as', 'else', 'elseif', 'use_lambda']],
        'spaces_inside_parentheses' =&gt; true,
        'statement_indentation' =&gt; true,
        'switch_case_semicolon_to_colon' =&gt; true,
        'switch_case_space' =&gt; true,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Then we eliminate one rule, run the check,
and see if the error is still there, then eliminate the next rule, etc.</p>

<p>Doing so, I've identified the following rule as being the offender:</p>

<ul>
<li><a href="https://cs.symfony.com/doc/rules/whitespace/statement_indentation.html">statement_indentation</a></li>
</ul>

<p>Looking at <code>apps/monolith/web/phpincludes/cerveau.php</code>,
we can see a mix of HTML and PHP (the following is a condensed example):</p>

<pre><code class="php">  &lt;h1&gt;Cerveau&lt;/h1&gt;
  &lt;?php
  if ($_SESSION['logged'] == true)
  {
  $production = calculerGenAmour(0,3600,$nbE[0][0],$nbE[1][0],$nbE[1][1],$nbE[1][2]);
  ?&gt;
  Score : &lt;strong&gt;&lt;?php echo formaterNombre($score); ?&gt;&lt;/strong&gt; Point&lt;?php echo pluriel($score);?&gt;&lt;br /&gt;
  &lt;?php
        if ($donnees_info = mysql_fetch_assoc($sql_info))
        {
                $pseudoCible = $donnees_info2['pseudo'];
  ?&gt;
  Tu vas tenter d'embrasser &lt;strong&gt;&lt;?php echo $pseudoCible; ?&gt;&lt;/strong&gt;
  &lt;?php
        }
  }
  ?&gt;
</code></pre>

<p>This is <a href="https://github.com/PHP-CS-Fixer/PHP-CS-Fixer/issues/3702#issuecomment-396717120">a known issue</a>,
and currently PHP CS Fixer doesn't support these kind of files,
so all we can do is restore <code>PSR2</code> and then disable that one specific rule:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        '@PSR2' =&gt; true,

        // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Now we can fix the files running <code>make cs-fix</code>.</p>

<h2 id="level-3%3A-psr-12">Level 3: PSR-12</h2>

<p>Let's now upgrade to <a href="https://cs.symfony.com/doc/ruleSets/PSR12.html">PSR-12 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        '@PSR12' =&gt; true,

        // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>PSR-12 extends PSR-2 with rules for modern PHP syntax,
specifically how to format newer language features like:</p>

<ul>
<li>type declarations</li>
<li>arrow functions</li>
<li>anonymous classes</li>
<li>trait usage</li>
</ul>

<p>As well as other PHP 7+ constructs that didn't exist when PSR-2 was written
(in 2012, when PHP 5.4 got released).</p>

<p>Let's run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.85.1 Alexander by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

   1) ../monolith/web/calcul.php (binary_operator_spaces)
   2) ../monolith/web/redirect.php (blank_line_after_opening_tag, binary_operator_spaces, no_whitespace_in_blank_line)
   3) ../monolith/web/checkConnect.php (binary_operator_spaces, no_whitespace_in_blank_line)
   4) ../monolith/web/phpincludes/fctIndex.php (blank_line_after_opening_tag, binary_operator_spaces, no_whitespace_in_blank_line)
   5) ../monolith/web/phpincludes/topten.php (binary_operator_spaces, no_whitespace_in_blank_line)
   6) ../monolith/web/phpincludes/pages.php (blank_line_after_opening_tag)
   7) ../monolith/web/deconnexion.php (blank_line_after_opening_tag, binary_operator_spaces)
   8) ../monolith/web/news/rediger_news.php (no_whitespace_in_blank_line)
   9) ../monolith/web/news/chemin.php (blank_line_after_opening_tag)
  10) ../monolith/web/phpincludes/evo.php (binary_operator_spaces, no_whitespace_in_blank_line)
  11) ../monolith/web/phpincludes/stats.php (binary_operator_spaces, no_whitespace_in_blank_line)
  12) ../monolith/web/phpincludes/infos.php (binary_operator_spaces)
  13) ../monolith/web/phpincludes/cerveau.php (binary_operator_spaces, no_whitespace_in_blank_line)
  14) ../monolith/web/phpincludes/yeux.php (binary_operator_spaces, no_whitespace_in_blank_line)
  15) ../monolith/web/phpincludes/inscription.php (binary_operator_spaces, no_whitespace_in_blank_line)
  16) ../monolith/web/phpincludes/faq.php (binary_operator_spaces, no_whitespace_in_blank_line)
  17) ../monolith/web/phpincludes/construction.php (binary_operator_spaces)
  18) ../monolith/web/phpincludes/recherche.php (binary_operator_spaces)
  19) ../monolith/web/makeBan.php (binary_operator_spaces, no_whitespace_in_blank_line)
  20) ../monolith/web/index.php (binary_operator_spaces, no_whitespace_in_blank_line)
  21) ../monolith/web/phpincludes/livreor.php (binary_operator_spaces, no_whitespace_in_blank_line)
  22) ../monolith/web/phpincludes/bisous.php (binary_operator_spaces, no_whitespace_in_blank_line)
  23) ../monolith/web/phpincludes/boite.php (indentation_type, binary_operator_spaces, no_whitespace_in_blank_line)
  24) ../monolith/web/phpincludes/connected.php (indentation_type, binary_operator_spaces, no_whitespace_in_blank_line)
  25) ../monolith/web/phpincludes/envoi.php (binary_operator_spaces, no_whitespace_in_blank_line)
  26) ../monolith/web/phpincludes/action.php (binary_operator_spaces, no_whitespace_in_blank_line)
  27) ../monolith/web/phpincludes/accueil.php (binary_operator_spaces, no_whitespace_in_blank_line)
  28) ../monolith/web/phpincludes/lire.php (binary_operator_spaces, no_whitespace_in_blank_line)
  29) ../monolith/web/phpincludes/membres.php (binary_operator_spaces)
  30) ../monolith/web/phpincludes/nuage.php (binary_operator_spaces, no_whitespace_in_blank_line)
  31) ../monolith/web/phpincludes/attaque.php (blank_line_after_opening_tag, binary_operator_spaces, no_whitespace_in_blank_line)
  32) ../monolith/web/phpincludes/confirmation.php (binary_operator_spaces, no_whitespace_in_blank_line)
  33) ../monolith/web/phpincludes/changepass.php (binary_operator_spaces, no_whitespace_in_blank_line)
  34) ../monolith/web/phpincludes/techno.php (binary_operator_spaces)
  35) ../monolith/web/phpincludes/newpass.php (binary_operator_spaces, no_whitespace_in_blank_line)

Found 35 of 43 files that can be fixed in 0.207 seconds, 18.00 MB memory used
</code></pre>

<p>So far so good, let's apply the changes: <code>make cs-fix</code>.</p>

<p>But we are not finished here, it's time to introduce <strong>risky</strong> rules:
these are rules that once applied can potentially change the logic and behaviour of your code.</p>

<p>For example the rule <a href="https://cs.symfony.com/doc/rules/function_notation/no_unreachable_default_argument_value.html">no_unreachable_default_argument_value</a>,
will remove default values for arguments,
that come before other arguments without default values.</p>

<p>Here's the new configuration:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        '@PSR12' =&gt; true,
        '@PSR12:risky' =&gt; true,

        // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Running <code>make cs-check</code> will show that all is fine,
so we apply the change through <code>make cs-fix</code>,
and then we have a look at the changes made,
and test around to make sure nothing is broken.</p>

<h2 id="level-4%3A-per-cs-2.0">Level 4: PER CS 2.0</h2>

<p>Next is the <a href="https://cs.symfony.com/doc/ruleSets/PERCS2x0.html">PER CS 2.0 ruleset</a>:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        '@PER-CS2x0' =&gt; true,
        '@PER-CS2x0:risky' =&gt; true,

        // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>As the PHP language evolves it gets new features,
which then requires the coding standards PSRs to be updated.</p>

<p>However the PSRs process where not suitable for updates,
so PER (PHP Evolving Recommendation) was created.</p>

<p>PER CS 1.0, released in 2022, is intentionally strictly equivalent to PSR-12.</p>

<p>In 2023, PER CS 2.0 was released, to cover PHP 8 new features, such as:</p>

<ul>
<li>Type declarations for properties</li>
<li>Constructor property promotion</li>
<li>Match expressions</li>
<li>Named arguments</li>
<li>Attributes</li>
<li>Readonly properties and classes</li>
<li>Enum declarations</li>
</ul>

<p>Because it is targeted at new PHP versions,
some of its rule won't be compatible with our version of PHP (5.6):</p>

<ul>
<li><a href="https://cs.symfony.com/doc/rules/control_structure/trailing_comma_in_multiline.html">trailing_comma_in_multiline</a></li>
</ul>

<p>In PHP 5.6, trailing commas are only supported with arrays,
so we need to change our configuration slightly:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        '@PER-CS2x0' =&gt; true,
        '@PER-CS2x0:risky' =&gt; true,

        // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,

        // [PER-CS2.0] Partially disabled due to PHP version constraints.
        'trailing_comma_in_multiline' =&gt; [
            'after_heredoc' =&gt; true,
            'elements' =&gt; [
                // 'arguments', For PHP 7.3+
                // 'array_destructuring', For PHP 7.1+
                'arrays',
                // 'match', For PHP 8.0+
                // 'parameters', For PHP 8.0+
            ],
        ],
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>If we run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.88.2 Folding Bike by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

   1) ../monolith/web/calcul.php (concat_space, binary_operator_spaces)
   2) ../monolith/web/redirect.php (blank_line_after_opening_tag, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
   3) ../monolith/web/checkConnect.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
   4) ../monolith/web/phpincludes/fctIndex.php (array_syntax, array_indentation, blank_line_after_opening_tag, concat_space, trailing_comma_in_multiline, binary_operator_spaces,no_whitespace_in_blank_line)
   5) ../monolith/web/phpincludes/topten.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
   6) ../monolith/web/phpincludes/pages.php (array_syntax, blank_line_after_opening_tag, trailing_comma_in_multiline)
   7) ../monolith/web/deconnexion.php (blank_line_after_opening_tag, concat_space, binary_operator_spaces)
   8) ../monolith/web/news/rediger_news.php (no_whitespace_in_blank_line)
   9) ../monolith/web/news/chemin.php (blank_line_after_opening_tag)
  10) ../monolith/web/news/liste_news.php (concat_space)
  11) ../monolith/web/phpincludes/evo.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  12) ../monolith/web/phpincludes/stats.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  13) ../monolith/web/phpincludes/infos.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces)
  14) ../monolith/web/phpincludes/cerveau.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  15) ../monolith/web/phpincludes/yeux.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  16) ../monolith/web/phpincludes/inscription.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  17) ../monolith/web/phpincludes/faq.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces, no_whitespace_in_blank_line)
  18) ../monolith/web/phpincludes/construction.php (concat_space, binary_operator_spaces)
  19) ../monolith/web/phpincludes/recherche.php (concat_space, binary_operator_spaces)
  20) ../monolith/web/phpincludes/bd.php (concat_space)
  21) ../monolith/web/makeBan.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  22) ../monolith/web/index.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces, no_whitespace_in_blank_line)
  23) ../monolith/web/phpincludes/livreor.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  24) ../monolith/web/phpincludes/bisous.php (array_syntax, concat_space, trailing_comma_in_multiline, binary_operator_spaces, no_whitespace_in_blank_line)
  25) ../monolith/web/phpincludes/boite.php (indentation_type, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  26) ../monolith/web/phpincludes/connected.php (indentation_type, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  27) ../monolith/web/phpincludes/envoi.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  28) ../monolith/web/phpincludes/action.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  29) ../monolith/web/phpincludes/accueil.php (array_syntax, array_indentation, binary_operator_spaces, no_whitespace_in_blank_line)
  30) ../monolith/web/phpincludes/lire.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  31) ../monolith/web/phpincludes/membres.php (concat_space, binary_operator_spaces)
  32) ../monolith/web/phpincludes/nuage.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  33) ../monolith/web/phpincludes/attaque.php (blank_line_after_opening_tag, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  34) ../monolith/web/phpincludes/confirmation.php (array_syntax, concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  35) ../monolith/web/phpincludes/changepass.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)
  36) ../monolith/web/phpincludes/techno.php (concat_space, binary_operator_spaces)
  37) ../monolith/web/phpincludes/newpass.php (concat_space, binary_operator_spaces, no_whitespace_in_blank_line)

Found 37 of 43 files that can be fixed in 0.210 seconds, 16.00 MB memory used
</code></pre>

<p>Once again, no issues there, so we can apply the fixes: <code>make-cs fix</code>.</p>

<h2 id="level-5%3A-symfony">Level 5: Symfony</h2>

<p>Time for the final boss, the Coding Standards used in the Symfony project.</p>

<p>See <a href="https://cs.symfony.com/doc/ruleSets/Symfony.html">Symfony ruleset here</a>,
and <a href="https://cs.symfony.com/doc/ruleSets/SymfonyRisky.html">Symfony:risky ruleset there</a>.</p>

<p>Those are by no means meant to be used in Symfony projects (or any projects),
it's just what the Symfony developers use internally to build the framework.</p>

<p>But these 41 rules provide:</p>

<ul>
<li>Stricter PHPDoc requirements</li>
<li>Import (<code>use</code> statements) organisation and formatting</li>
<li>More opinionated whitespace and formatting rules</li>
<li>Type handling - Specific rules about how types are ordered and formatted</li>
</ul>

<p>The 34 risky rules also add performance optimisations
(e.g. native function invocation with leading backslash to by pass autoloading lookup).</p>

<p>So let's adopt them here:</p>

<pre><code class="php">&lt;?php

use PhpCsFixer\Runner\Parallel\ParallelConfigFactory;

$finder = (new PhpCsFixer\Finder())
    -&gt;in(__DIR__.'/../monolith/web')
    -&gt;exclude('ban')
    -&gt;exclude('images')
    -&gt;exclude('includes')
    -&gt;exclude('polices')
    -&gt;exclude('smileys')
;

return (new PhpCsFixer\Config())
    -&gt;setRules([
        // â€”â€” CS Rule Sets â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        '@Symfony' =&gt; true,
        '@Symfony:risky' =&gt; true,

        // â€”â€” Overriden rules â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        // [PSR2] Disabled as the fixes break the following files:
        // 1) ../monolith/web/phpincludes/bisous.php
        // 2) ../monolith/web/phpincludes/cerveau.php
        'statement_indentation' =&gt; false,

        // [PER-CS2.0] Partially disabled due to PHP version constraints.
        'trailing_comma_in_multiline' =&gt; [
            'after_heredoc' =&gt; true,
            'elements' =&gt; [
                // 'arguments', For PHP 7.3+
                // 'array_destructuring', For PHP 7.1+
                'arrays',
                // 'match', For PHP 8.0+
                // 'parameters', For PHP 8.0+
            ],
        ],
    ])
    -&gt;setRiskyAllowed(true)
    -&gt;setParallelConfig(ParallelConfigFactory::detect())
    -&gt;setUsingCache(true)
    -&gt;setFinder($finder)
;
</code></pre>

<p>Let's run the checks:</p>

<pre><code class="console">&gt; make cs-check
PHP CS Fixer 3.88.2 Folding Bike by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Running analysis on 15 cores with 10 files per process.
Parallel runner is an experimental feature and may be unstable, use it at your own risk. Feedback highly appreciated!
Loaded config default from "/apps/qa/.php-cs-fixer.dist.php".
Using cache file ".php-cs-fixer.cache".
 43/43 [â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“] 100%

   1) ../monolith/web/calcul.php (concat_space, no_extra_blank_lines)
   2) ../monolith/web/redirect.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
   3) ../monolith/web/checkConnect.php (increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
   4) ../monolith/web/phpincludes/fctIndex.php (single_space_around_construct, no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines, blank_line_before_statement)
   5) ../monolith/web/phpincludes/topten.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
   6) ../monolith/web/phpincludes/pages.php (single_quote, single_line_comment_spacing)
   7) ../monolith/web/deconnexion.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
   8) ../monolith/web/news/rediger_news.php (concat_space, no_extra_blank_lines)
   9) ../monolith/web/news/chemin.php (blank_line_after_opening_tag)
  10) ../monolith/web/news/liste_news.php (single_line_comment_spacing, concat_space, yoda_style, logical_operators, no_extra_blank_lines)
  11) ../monolith/web/reductionNuages.php (single_line_comment_spacing)
  12) ../monolith/web/phpincludes/evo.php (increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines, blank_line_before_statement)
  13) ../monolith/web/phpincludes/stats.php (single_space_around_construct, single_quote, semicolon_after_instruction, concat_space, space_after_semicolon)
  14) ../monolith/web/phpincludes/infos.php (increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon)
  15) ../monolith/web/phpincludes/cerveau.php (single_space_around_construct, no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  16) ../monolith/web/phpincludes/yeux.php (no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  17) ../monolith/web/phpincludes/inscription.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  18) ../monolith/web/phpincludes/faq.php (single_quote, single_line_comment_spacing, concat_space, no_extra_blank_lines)
  19) ../monolith/web/phpincludes/construction.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  20) ../monolith/web/phpincludes/recherche.php (single_quote, concat_space, yoda_style)
  21) ../monolith/web/phpincludes/bd.php (concat_space)
  22) ../monolith/web/phpincludes/accueil.php (single_quote, whitespace_after_comma_in_array, yoda_style, space_after_semicolon, no_extra_blank_lines)
  23) ../monolith/web/phpincludes/lire.php (single_space_around_construct, single_quote, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  24) ../monolith/web/phpincludes/membres.php (modernize_types_casting, no_unneeded_control_parentheses, increment_style, single_quote, concat_space, no_singleline_whitespace_before_semicolons, yoda_style, no_extra_blank_lines, binary_operator_spaces)
  25) ../monolith/web/phpincludes/nuage.php (single_space_around_construct, increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  26) ../monolith/web/phpincludes/attaque.php (no_empty_statement, no_unneeded_control_parentheses, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
  27) ../monolith/web/phpincludes/confirmation.php (no_unneeded_control_parentheses, increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  28) ../monolith/web/phpincludes/changepass.php (single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon)
  29) ../monolith/web/phpincludes/techno.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  30) ../monolith/web/phpincludes/newpass.php (single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  31) ../monolith/web/makeBan.php (increment_style, single_quote, single_line_comment_spacing, concat_space, space_after_semicolon)
  32) ../monolith/web/index.php (single_space_around_construct, increment_style, single_quote, no_spaces_after_function_name, single_line_comment_spacing, concat_space, include,no_singleline_whitespace_before_semicolons, yoda_style, space_after_semicolon, no_extra_blank_lines)
  33) ../monolith/web/phpincludes/livreor.php (modernize_types_casting, no_unneeded_control_parentheses, increment_style, single_quote, semicolon_after_instruction, single_line_comment_spacing, native_constant_invocation, concat_space, no_singleline_whitespace_before_semicolons, yoda_style, no_extra_blank_lines, binary_operator_spaces)
  34) ../monolith/web/phpincludes/bisous.php (single_space_around_construct, no_unneeded_control_parentheses, increment_style, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  35) ../monolith/web/phpincludes/connexion.php (yoda_style, no_extra_blank_lines)
  36) ../monolith/web/phpincludes/boite.php (indentation_type, single_space_around_construct, increment_style, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  37) ../monolith/web/phpincludes/connected.php (indentation_type, single_quote, single_line_comment_spacing, concat_space, yoda_style, no_extra_blank_lines)
  38) ../monolith/web/phpincludes/envoi.php (single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines)
  39) ../monolith/web/phpincludes/action.php (no_unneeded_braces, single_quote, single_line_comment_spacing, concat_space, yoda_style, space_after_semicolon, no_extra_blank_lines, no_whitespace_in_blank_line)

Found 39 of 43 files that can be fixed in 0.212 seconds, 16.00 MB memory used
</code></pre>

<p>All safe it'd seem, let's apply those then: <code>make cs-fix</code></p>

<h2 id="conclusion">Conclusion</h2>

<p>By progressively applying PHP CS Fixer rule sets,
we've transformed BisouLand's chaotic 2005 code into something that follows modern standards.</p>

<p>The key insight here is <strong>incrementalism</strong>,
we didn't jump straight to the strictest rule set,
but instead built up gradually:</p>

<ol>
<li>PSR-1: Basic formatting (opening tags, encoding)</li>
<li>PSR-2: Braces and indentation</li>
<li>PSR-12: Modern PHP syntax support</li>
<li>PER-CS 2.0: PHP 8 features (adjusted for PHP 5.6 compatibility)</li>
<li>Symfony: Stricter PHPDoc, imports, and performance optimisations</li>
</ol>

<p>Along the way we:</p>

<ul>
<li><strong>Identified problematic rules</strong> (<code>statement_indentation</code> breaks mixed HTML/PHP files)</li>
<li><strong>Adapted for PHP version constraints</strong> (trailing commas only for arrays in PHP 5.6)</li>
<li><strong>Applied changes incrementally</strong> (check, fix, test, repeat)</li>
</ul>

<p>The final configuration gives us automated formatting that makes the code more
readable and maintainable, without breaking functionality.</p>

<p>Now, before we move on, here's a super secret PHP CS Fixer tip:
you can run <code>php-cs-fixer describe &lt;rule/ruleset&gt;</code>,
which serves as a local documentation:</p>

<pre><code class="console">&gt; docker compose exec app php vendor/bin/php-cs-fixer describe trailing_comma_in_multiline
PHP CS Fixer 3.88.2 Folding Bike by Fabien Potencier, Dariusz Ruminski and contributors.
PHP runtime: 8.4.12
Description of the `trailing_comma_in_multiline` rule.

Arguments lists, array destructuring lists, arrays that are multi-line, `match`-lines and parameters lists must have a trailing comma.

Fixer is configurable using following options:
* after_heredoc (bool): whether a trailing comma should also be placed after heredoc end; defaults to false
* elements (a subset of ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']): where to fix multiline trailing comma (PHP &gt;= 8.0 for `parameters` and `match`); defaults to ['arrays']

Fixing examples:
 * Example #1. Fixing with the default configuration.
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,5 +1,5 @@
    &lt;?php
    array(
        1,
   -    2
   +    2,
    );

   ----------- end diff -----------

 * Example #2. Fixing with configuration: ['after_heredoc' =&gt; true].
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,7 +1,7 @@
    &lt;?php
        $x = [
            'foo',
            &lt;&lt;&lt;EOD
                bar
   -            EOD
   +            EOD,
        ];

   ----------- end diff -----------

 * Example #3. Fixing with configuration: ['elements' =&gt; ['arguments']].
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,5 +1,5 @@
    &lt;?php
    foo(
        1,
   -    2
   +    2,
    );

   ----------- end diff -----------

 * Example #4. Fixing with configuration: ['elements' =&gt; ['parameters']].
   ---------- begin diff ----------
   --- Original
   +++ New
   @@ -1,7 +1,7 @@
    &lt;?php
    function foo(
        $x,
   -    $y
   +    $y,
    )
    {
    }

   ----------- end diff -----------

The fixer is part of the following rule sets:
* @PER *(deprecated)* with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS2.0 *(deprecated)* with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS2x0 with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS3.0 *(deprecated)* with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PER-CS3x0 with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['arguments', 'array_destructuring', 'arrays', 'match', 'parameters']]
* @PHP73Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP74Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP7x3Migration with config: ['after_heredoc' =&gt; true]
* @PHP7x4Migration with config: ['after_heredoc' =&gt; true]
* @PHP80Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP81Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP82Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP83Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP84Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP85Migration *(deprecated)* with config: ['after_heredoc' =&gt; true]
* @PHP8x0Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x1Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x2Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x3Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x4Migration with config: ['after_heredoc' =&gt; true]
* @PHP8x5Migration with config: ['after_heredoc' =&gt; true]
* @PhpCsFixer with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['array_destructuring', 'arrays']]
* @Symfony with config: ['after_heredoc' =&gt; true, 'elements' =&gt; ['array_destructuring', 'arrays', 'match', 'parameters']]
</code></pre>

<blockquote>
  <p>â‰ï¸ <em>Hold on, what about those <strong>SQL injection vulnerabilities</strong>?</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 3: End to End Tests]]></title>
            <link href="/2025/09/24/xl-3-end-to-end-tests.html"/>
            <updated>2025-09-24T00:00:00+01:00</updated>
            <id>/2025/09/24/xl-3-end-to-end-tests.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ğŸ¤˜ The Beta Destroyer breaks free from the crypts of Manual Testing,
  forging unbreakable chains of End to End test scenarios,
  binding every component in the unholy covenant of automations! ğŸ”¥</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">ğŸ‹ got it to run in a local container</a></li>
<li><a href="/2025/09/17/xl-2-smoke-tests.html">ğŸ’¨ written Smoke Tests</a></li>
</ol>

<p>This means we can run it locally (http://localhost:8080/),
and have some level of automated tests.</p>

<p>But currently the tests are failing!</p>

<p>So, we'll inspect the issue, identify it,
write End to End tests which will be today's third article focus,
and finally we'll fix the bug.</p>

<p><img
    alt="The plan: we find the bug. We fix the bug. Now there are two bugs. Now there are three bugs"
    src="/images/xl-3-the-plan.jpg"
    width="100%" /></p>

<ul>
<li><a href="#identifying-the-issue">Identifying the issue</a></li>
<li><a href="#writing-the-test">Writing the test</a></li>
<li><a href="#test-data-cleanup">Test data cleanup</a></li>
<li><a href="#custom-assertion">Custom Assertion</a></li>
<li><a href="#fixing-the-bug">Fixing the bug</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="identifying-the-issue">Identifying the issue</h2>

<p>Let's run the tests to see the failure messages:</p>

<pre><code class="console">make test arg='--testdox --filter PlayerPages'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

FFFFFFFFFFFF............                                          24 / 24 (100%)

Time: 00:00.081, Memory: 18.00 MB

Player Pages (Bl\Qa\Tests\Smoke\PlayerPages)
 âœ˜ it loads account page (`/connected.html`) for logged in players
   â”
   â”œ Failed asserting that Page loads for logged in players
   â”‚
   â”‚ /apps/qa/tests/Smoke/Assertion/Assert.php:41
   â”‚ /apps/qa/tests/Smoke/PlayerPagesTest.php:45
   â”´
[...]
FAILURES!
Tests: 24, Assertions: 24, Failures: 12.
</code></pre>

<p>The player cannot log in... Let's try manually,
first we need to sign-up a new player:</p>

<p><img alt="BisouLand signup attempt screenshot" src="/images/xl-3-signup-attempt-screenshot.png" width="100%" /></p>

<p>It worked:</p>

<p><img alt="BisouLand signup errot screenshot" src="/images/xl-3-signup-success-screenshot.png" width="100%" /></p>

<p>Now let's log in:</p>

<p><img alt="BisouLand signup attempt screenshot" src="/images/xl-3-login-attempt-screenshot.png" width="100%" /></p>

<p>But it fails! The error says the username doesn't exist:</p>

<p><img alt="BisouLand signup errot screenshot" src="/images/xl-3-login-failure-screenshot.png" width="100%" /></p>

<p>Inspecting the database shows that the player data wasn't inserted.</p>

<p>The Smoke Tests didn't catch directly the login error,
because it's an error printed inside the HTML,
and our tests only check for status code <code>200</code>.</p>

<p>So this highlights the limits of Smoke Tests
(though we have to recognise that they did indirectly catch the issue,
with players being unable to login).</p>

<p>The code handling signing up is located in <code>./apps/monolith/web/phpincludes/inscription.php</code>,
and hold on to your socks because it looks like this:</p>

<pre><code class="php">&lt;?php
if (false == $_SESSION['logged']) {
    $send = 0;
    $pseudo = '';
    $mdp = '';
    if (isset($_POST['inscription'])) {
        // Mesure de securite.
        $pseudo = htmlentities(addslashes($_POST['Ipseudo']));
        $mdp = htmlentities(addslashes($_POST['Imdp']));
        $mdp2 = htmlentities(addslashes($_POST['Imdp2']));
        // Prevoir empecher de prendre un pseudo deje existant
        // Si les variables contenant le pseudo, le mot de passe existent et contiennent quelque chose.
        if (isset($_POST['Ipseudo'], $_POST['Imdp'], $_POST['Imdp2']) &amp;&amp; !empty($_POST['Ipseudo']) &amp;&amp; !empty($_POST['Imdp']) &amp;&amp; !empty($_POST['Imdp2'])) {
            if ($mdp == $mdp2) {
                // Si le pseudo est superieur e 3 caracteres et inferieur e 35 caracteres.
                $taille = strlen(trim($_POST['Ipseudo']));
                if ($taille &gt;= 4 &amp;&amp; $taille &lt;= 15) {
                    /* //Mesure de securite.
                    $pseudo = htmlentities(addslashes($_POST['pseudo']));
                    $mdp = htmlentities(addslashes($_POST['mdp']));*/

                    // La requete qui compte le nombre de pseudos
                    $sql = mysql_query("SELECT COUNT(*) AS nb_pseudo FROM membres WHERE pseudo='".$pseudo."'");

                    // Verifie si le pseudo n'est pas deje pris.
                    if (0 == mysql_result($sql, 0, 'nb_pseudo') &amp;&amp; 'BisouLand' != $pseudo) {
                        // Verifie que le pseudo est correct.
                        if (preg_match("!^\w+$!", $pseudo)) {
                            if (preg_match("!^\w+$!", $mdp)) {
                                // Si le mot de passe est superieur e 4 caracteres.
                                $taille = strlen(trim($_POST['Imdp']));
                                if ($taille &gt;= 5 &amp;&amp; $taille &lt;= 15) {
                                    // On execute la requete qui enregistre un nouveau membre.

                                    // Hashage du mot de passe avec md5().
                                    $hmdp = md5($mdp);

                                    mysql_query("INSERT INTO membres (id, pseudo, mdp, confirmation, lastconnect) VALUES ('', '".$pseudo."', '".$hmdp."', '1', ".time().')');

                                    echo 'Ton inscription est confirmÃ©e ! Tu peux maintenant te connecter.&lt;br /&gt;';
                                    $send = 1;
                                } else {
                                    echo 'Erreur : le mot de passe est soit trop court, soit trop long !';
                                }
                            } else {
                                echo 'Erreur : le mot de passe n\'est pas valide !';
                            }
                        } else {
                            echo 'Erreur : le pseudo n\'est pas valide !';
                        }
                    } else {
                        echo 'Erreur : pseudo deje pris !';
                    }
                } else {
                    echo 'Erreur : le pseudo est soit trop court, soit trop long !';
                }
            } else {
                echo 'Erreur : Tu n\'as pas rentre deux fois le meme mot de passe !';
            }
        } else {
            echo 'Erreur : Pense e remplir tous les champs !';
        }
    }
    if (0 == $send) {
        ?&gt;
&lt;form method="post" class="formul" action="inscription.html"&gt;
    &lt;label&gt;Pseudo :&lt;br /&gt;&lt;span class="petit"&gt;(Entre 4 et 15 caracteres)&lt;/span&gt;&lt;br /&gt;&lt;input type="text" name="Ipseudo" tabindex="10" size="15" maxlength="15" value="&lt;?php echo stripslashes($pseudo); ?&gt;"/&gt;&lt;/label&gt;&lt;br /&gt;
    &lt;label&gt;Mot de passe : &lt;br /&gt;&lt;span class="petit"&gt;(Entre 5 et 15 caracteres)&lt;/span&gt;&lt;br /&gt;&lt;input type="password" name="Imdp" tabindex="20" size="15" maxlength="15" value=""/&gt;&lt;/label&gt;&lt;br /&gt;
    &lt;label&gt;Reecris le mot de passe : &lt;br /&gt;&lt;input type="password" name="Imdp2" tabindex="30" size="15" maxlength="15" value=""/&gt;&lt;/label&gt;&lt;br /&gt;
    &lt;input type="submit" name="inscription" value="S'inscrire" /&gt;
&lt;/form&gt;
&lt;?php
    }
} else {
    echo 'Pfiou t\'es dja connected toi !!';
}
?&gt;
</code></pre>

<p>Now, that's eXtreme Legacy!!!</p>

<p>Let's focus on the problematic line,
which is supposed to save the player's data in the database
(I've reformatted it a bit for readability):</p>

<pre><code class="php">mysql_query(
    'INSERT INTO membres (id, pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ." VALUES ('', '{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
</code></pre>

<p>There are many problems here (deprecated function, SQL injection vulnerability,
use of cryptologically broken md5 for password hashing etc),
but what jumps to my attention is the use of <code>''</code> for the ID value.</p>

<p>After some research it turns out this code worked fine in older MySQL versions,
because MySQL would silently convert the empty string to <code>0</code>,
and since the id field is an <code>AUTO_INCREMENT</code> integer,
MySQL would then treat that <code>0</code> as a signal to generate the next sequence value.</p>

<p>However MySQL 5.7 (which is the version we picked!), released in October 2015,
introduced a significant change: <code>STRICT_TRANS_TABLES</code> became enabled by default.
This means MySQL now rejects data type error like this one.</p>

<p>So to fix the issue we can change the MySQL version,
but the end goal is to upgrade the versions to the most recent, not to downgrade,
so let's instead just fix the code.</p>

<p>But first, we need to write a test: Test Driven Development, or no tests at all! ğŸ¤˜</p>

<h2 id="writing-the-test">Writing the test</h2>

<p>There are two kinds of tests that I hate: Smoke Tests, and End to End Tests.</p>

<p>End to End tests usually are about navigating the application, which is slow,
and checking for the content of the response, which is brittle.</p>

<p>However in this scenario, there are no alternative to test the features:
there are no HTTP framework, or handler / controller / services classes used
to allow us to write Functional / Integration / System tests.</p>

<p>To test our sign-up, all we can do is:</p>

<ul>
<li>issue a POST request to simulate the form being submitted</li>
<li>check in the database if the expected record has been persisted</li>
</ul>

<p>So let's just do that:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\EndToEnd;

use Bl\Qa\Tests\EndToEnd\Assertion\Assert;
use Bl\Qa\Tests\Infrastructure\Scenario\SignUpNewPlayer;
use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use PHPUnit\Framework\Attributes\CoversNothing;
use PHPUnit\Framework\Attributes\DataProvider;
use PHPUnit\Framework\Attributes\Large;
use PHPUnit\Framework\Attributes\TestDox;
use PHPUnit\Framework\TestCase;

#[CoversNothing]
#[Large]
final class SignUpTest extends TestCase
{
    public function test_it_allows_visitors_to_become_players(): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $player = SignUpNewPlayer::run(
            'BisouTest',
            'password',
            'password',
        );

        Assert::signedUpCount($player-&gt;username, 1);
    }

    #[DataProvider('invalidCredentialsProvider')]
    #[TestDox('It prevents invalid credentials: $description')]
    public function test_it_prevents_invalid_credentials(string $username, string $password, string $description): void
    {
        SignUpNewPlayer::run(
            $username,
            $password,
            $password,
        );

        Assert::signedUpCount($username, 0);
    }

    /**
     * [string $username, string $password, string $description][].
     *
     * @return array&lt;array{string, string, string}&gt;
     */
    public static function invalidCredentialsProvider(): array
    {
        return [
            ['usr', 'password', 'username too short (&lt; 4 characters)'],
            ['test_sign_up02__', 'password', 'username too long (&gt; 15 characters)'],
            ['test_sign_up03!', 'password', 'username contains special characters (non alpha-numerical, not an underscore (`_`))'],
            ['test_sign_up05', 'pass', 'password too short (&lt; 5 characters)'],
            ['test_sign_up06', 'passwordthatistoolong', 'password too long (&gt; 15 characters)'],
            ['test_sign_up07', 'password!', 'password contains special characters (non alpha-numerical, not an underscore (`_`))'],
            ['BisouLand', 'password', 'system account, for notifications'],
        ];
    }

    #[TestDox('It prevents usernames that are already used')]
    public function test_it_prevents_usernames_that_are_already_used(): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $username = 'BisouTest_';
        $password = 'password';
        $passwordConfirmation = $password;

        // First registration should succeed
        SignUpNewPlayer::run(
            $username,
            $password,
            $passwordConfirmation,
        );
        // Second registration should fail
        SignUpNewPlayer::run(
            $username,
            $password,
            $passwordConfirmation,
        );

        Assert::signedUpCount($username, 1);
    }

    public function test_it_prevents_passwords_that_do_not_match_confirmation(): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $username = 'BisouTest';
        $password = 'password';
        $passwordConfirmation = 'different';

        SignUpNewPlayer::run(
            $username,
            $password,
            $passwordConfirmation
        );

        Assert::signedUpCount($username, 0);
    }
}
</code></pre>

<p>If I've read the long and nested if statements correctly,
this should cover all the different sign-up scenarios,
including username and password checking.</p>

<p>For now let's just run the "happy scenario" test to make sure it fails:</p>

<pre><code class="console">make test arg='--testdox --filter test_it_allows_visitors_to_become_players'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

F                                                                   1 / 1 (100%)

Time: 00:00.032, Memory: 18.00 MB

Sign Up (Bl\Qa\Tests\EndToEnd\SignUp)
 âœ˜ It allows visitors to become players
   â”
   â”œ Failed asserting that Signed Up Count 0 is 1
   â”‚
   â”‚ /apps/qa/tests/EndToEnd/Assertion/Assert.php:114
   â”‚ /apps/qa/tests/EndToEnd/SignUpTest.php:30
   â”´

FAILURES!
Tests: 1, Assertions: 1, Failures: 1.
</code></pre>

<p>Brilliant! Before we fix it, I'll dive a bit more in the test details.</p>

<h2 id="test-data-cleanup">Test data cleanup</h2>

<p>I was surprised to find out that the username <code>BisouLand</code> was forbidden,
turns out it is used to send system notifications
(though I note that the checks are case sensitive only).</p>

<p>This is actually what inspired me to use <code>BisouTest</code> as a special test username,
if you remember correctly in the <code>SignUpNewPlayer</code> scenario,
which we've reused from the Smoke Tests as we would have done the exact same logic,
we have the following:</p>

<pre><code class="php">        if ('BisouTest' === $username) {
            $username = substr('BisouTest_'.uniqid(), 0, 15);
        }
</code></pre>

<p>This makes sure that there will be no username duplicates.</p>

<p>One thing I didn't mention in my previous article was that I've setup a way
to cleanup the test data with the <code>DeleteAllTestPlayers</code> scenario:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;

final readonly class DeleteAllTestPlayers
{
    public static function run(): void
    {
        $pdo = TestKernelSingleton::get()-&gt;pdo();

        $pdo-&gt;query("DELETE FROM membres WHERE pseudo LIKE 'BisouTest%'");
    }
}
</code></pre>

<p>This is called by a PHPUnit subscriber for the <code>TestRunner\Finished</code> event:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Subscriber;

use Bl\Qa\Tests\Infrastructure\Scenario\DeleteAllTestPlayers;
use PHPUnit\Event\TestRunner\Finished;
use PHPUnit\Event\TestRunner\FinishedSubscriber;

final readonly class TestCleanupSubscriber implements FinishedSubscriber
{
    public function notify(Finished $event): void
    {
        DeleteAllTestPlayers::run();
    }
}
</code></pre>

<p>This will be called once the testsuite is finished executing,
but only if we register the subscriber in a PHPUnit Extension:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Subscriber;

use PHPUnit\Runner\Extension\Extension;
use PHPUnit\Runner\Extension\Facade;
use PHPUnit\Runner\Extension\ParameterCollection;
use PHPUnit\TextUI\Configuration\Configuration;

final readonly class TestCleanupExtension implements Extension
{
    public function bootstrap(Configuration $configuration, Facade $facade, ParameterCollection $parameters): void
    {
        $facade-&gt;registerSubscriber(new TestCleanupSubscriber());
    }
}
</code></pre>

<p>The extension also has to be registered in the <code>phpunit.xml</code> config:</p>

<pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!-- https://phpunit.readthedocs.io/en/latest/configuration.html --&gt;
&lt;phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         cacheDirectory=".phpunit.cache"
         executionOrder="depends,defects"
         shortenArraysForExportThreshold="10"
         requireCoverageMetadata="true"
         beStrictAboutCoverageMetadata="true"
         beStrictAboutOutputDuringTests="true"
         displayDetailsOnPhpunitDeprecations="true"
         colors="true"
         failOnPhpunitDeprecation="true"
         failOnRisky="true"
         failOnWarning="true"&gt;
    &lt;php&gt;
        &lt;ini name="display_errors" value="1" /&gt;
        &lt;ini name="error_reporting" value="-1" /&gt;
        &lt;env name="APP_ENV" value="test" force="true" /&gt;
        &lt;env name="SHELL_VERBOSITY" value="-1" /&gt;
    &lt;/php&gt;
    &lt;testsuites&gt;
        &lt;testsuite name="smoke"&gt;
            &lt;directory&gt;tests/Smoke&lt;/directory&gt;
        &lt;/testsuite&gt;
        &lt;testsuite name="end-to-end"&gt;
            &lt;directory&gt;tests/EndToEnd&lt;/directory&gt;
        &lt;/testsuite&gt;
    &lt;/testsuites&gt;

    &lt;extensions&gt;
        &lt;bootstrap class="Bl\Qa\Tests\Infrastructure\Subscriber\TestCleanupExtension"/&gt;
    &lt;/extensions&gt;

    &lt;source ignoreIndirectDeprecations="true" restrictNotices="true" restrictWarnings="true"&gt;
        &lt;include&gt;
            &lt;directory&gt;../monolith/web&lt;/directory&gt;
        &lt;/include&gt;
    &lt;/source&gt;
&lt;/phpunit&gt;
</code></pre>

<h2 id="custom-assertion">Custom Assertion</h2>

<p>I've created a <code>signedUpCount</code> custom assertion,
which will count in the database the number of records persisted for a given
username:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\EndToEnd\Assertion;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use PHPUnit\Framework\Assert as PHPUnitAssert;

final readonly class Assert
{
    public static function signedUpCount(string $username, int $expectedCount): void
    {
        $pdo = TestKernelSingleton::get()-&gt;pdo();

        $stmt = $pdo-&gt;prepare('SELECT COUNT(*) FROM membres WHERE pseudo = :username');
        $stmt-&gt;execute([
            'username' =&gt; $username,
        ]);
        $actualCount = (int) $stmt-&gt;fetchColumn();

        PHPUnitAssert::assertSame(
            $expectedCount,
            $actualCount,
            "Failed asserting that Signed Up Count {$actualCount} is {$expectedCount}",
        );
    }
}
</code></pre>

<p>I think there's an argument to have had made two assertions
(eg <code>signedUpSuccessful</code> count = 1, and <code>signedUpFailed</code> count = 0),
but for now I'm happy with this.</p>

<h2 id="fixing-the-bug">Fixing the bug</h2>

<p>We're going to fix that bug by removing the ID field from the query:</p>

<pre><code class="php">mysql_query(
    'INSERT INTO membres (pseudo, mdp, confirmation, timestamp, lastconnect, amour)'
    ." VALUES ('{$pseudo}', '{$hmdp}', '1', ".time().', '.time().", '300')"
);
</code></pre>

<p>Let's see if the bug is fixed by running the one test:</p>

<pre><code class="console">make test arg='--testdox --filter test_it_allows_visitors_to_become_players'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

.                                                                   1 / 1 (100%)

Time: 00:00.018, Memory: 18.00 MB

Sign Up (Bl\Qa\Tests\EndToEnd\SignUp)
 âœ” It allows visitors to become players

OK (1 test, 1 assertion)
</code></pre>

<p>So far so good, let's confirm by running all the tests:</p>

<pre><code class="console">make test
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12
Configuration: /apps/qa/phpunit.xml.dist

.................................................                 49 / 49 (100%)

Time: 00:00.162, Memory: 18.00 MB

OK (49 tests, 49 assertions)
</code></pre>

<p>Excellent! All fixed!</p>

<h2 id="conclusion">Conclusion</h2>

<p>I believe there will be many more instances of this,
and given the success of this fix we can assume it's safe to apply to all instances.</p>

<p>But I know these <code>mysql_query</code> calls will be removed very soon:</p>

<ul>
<li>they are deprecated</li>
<li>the query used is vulnerable to SQL Injection</li>
</ul>

<p>The End to End tests we've written also allow us to refactor the code,
instead of a nested list we can for example make use of early returns.</p>

<p>But if I have to refactor that code, I want to do it right,
by first writing unit tests which will make a design model emerge,
and by creating an API so we can also have integration tests.</p>

<p>Once we have these, both the Smoke Tests and End to End tests can be removed.</p>

<p>So I'm going to leave this as is for now.</p>

<blockquote>
  <p>â‰ï¸ <em>What do you mean, "the code is ugly"??</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 2: Smoke Tests]]></title>
            <link href="/2025/09/17/xl-2-smoke-tests.html"/>
            <updated>2025-09-17T00:00:00+01:00</updated>
            <id>/2025/09/17/xl-2-smoke-tests.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ğŸ¤˜ The Quality Avenger emerges from the burning forges of Coding Standards,
  smelting the ores of Static Analysis into the moulds of Automated Testing. ğŸ”¥</p>
</blockquote>

<p>In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:</p>

<ol>
<li><a href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html">ğŸ‹ got it to run in a local container</a></li>
</ol>

<p>This means we can access it (http://localhost:8080/) and manually check it.
Unfortunately looking at the <a href="https://github.com/pyricau/bisouland/tree/4.0.1">code</a>,
it's obvious we cannot launch it to production as is:</p>

<ul>
<li>Encoding Issues</li>
<li>Broken Authentication and Session Management</li>
<li>Cross-Site Scripting (XSS) Flaws</li>
<li>Injection Flaws, including SQL injection</li>
<li>Improper Error Handling</li>
<li>Non Compliance with GDPR requirements</li>
</ul>

<p>But how do we know we're not breaking anything when fixing these?
As things currently stand, we don't even know what features BisouLand has.</p>

<p>So, we're going to need to write tests, which will be today's second article focus.</p>

<ul>
<li><a href="#qa-app">QA app</a></li>
<li><a href="#smoke-tests">Smoke Tests</a></li>
<li><a href="#custom-assertions">Custom Assurance</a></li>
<li><a href="#scenarios">Scenarios</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="qa-app">QA app</h2>

<p>The first plan of action is to move the current app into the <code>./apps/monolith</code>
sub-folder, and to create a new QA one in <code>./apps/qa</code>.</p>

<p>This approach will allow us to isolate the legacy code from any tooling we might
need to bring it up to standards.</p>

<p>The QA application has the following tree directory:</p>

<pre><code>apps/qa/
â”œâ”€â”€ composer.json
â”œâ”€â”€ composer.lock
â”œâ”€â”€ compose.yaml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â”œâ”€â”€ phpstan-baseline.neon
â”œâ”€â”€ phpstan.neon.dist
â”œâ”€â”€ phpunit.xml.dist
â”œâ”€â”€ README.md
â””â”€â”€ tests/
</code></pre>

<p>As you can see, it has its own <code>Dockerfile</code>:</p>

<pre><code># syntax=docker/dockerfile:1

###
# PHP Dev Container
# Utility Tools: PHP, bash, Composer
###
FROM php:8.4-cli-alpine AS php_dev_container

# Composer environment variables:
# * default user is superuser (root), so allow them
# * put cache directory in a readable/writable location
# _Note_: When running `composer` in container, use `--no-cache` option
ENV COMPOSER_ALLOW_SUPERUSER=1 \
    COMPOSER_CACHE_DIR=/tmp/.composer/cache

# Install dependencies:
# * bash for shell access and scripting
# * zip for composer packages that use ZIP archives
# _Note (Alpine)_: `--no-cache` includes `--update` and keeps image size minimal
#
# Then install PHP extensions
#
# _Note (Hadolint)_: No version locking, since Alpine only ever provides one version
# hadolint ignore=DL3018
RUN apk add --update --no-cache \
        bash \
        libzip-dev \
        zip \
    &amp;&amp; docker-php-ext-install \
        bcmath \
        pdo \
        pdo_mysql \
        zip

# Copy Composer binary from composer image
# _Note (Hadolint)_: False positive as `COPY` works with images too
# See: https://github.com/hadolint/hadolint/issues/197#issuecomment-1016595425
# hadolint ignore=DL3022
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /apps/qa

# Caching `composer install`, as long as composer.{json,lock} don't change.
COPY composer.json composer.lock ./
RUN composer install \
    --no-cache \
    --no-interaction \
    --no-plugins \
    --no-scripts \
    --optimize-autoloader

# Copy the remaining application files (excluding those listed in .dockerignore)
COPY . .
</code></pre>

<p>And <code>compose.yaml</code>:</p>

<pre><code class="yaml">name: skyswoon-qa

services:
  app:
    build: .
    command: php -S 0.0.0.0:8081
    volumes:
      # Mount current directory into container for QA tools and configs
      - .:/apps/qa
      # Mount the monolith source code for analysis
      - ../monolith:/apps/monolith
    networks:
      - default
      - skyswoon-monolith_default

networks:
  skyswoon-monolith_default:
    external: true
</code></pre>

<p>This allows us to have QA in its own container (with PHP 8.4),
but it can still communicate with the monolith container,
so we can issue curl requets or query the MySQL database.</p>

<p>It also allows access to the monolith source files,
so we can run toolings on them like phpstan, rector, PHP CS Fixer, etc.</p>

<h2 id="smoke-tests">Smoke Tests</h2>

<p>There are two kinds of tests that I hate
(this is coming from a Test Driven Development practitioner, btw!)
and one of them is Smoke Tests.</p>

<p>Those basically issue a curl request,
and only check the bare minimum such as the status code is <code>200</code>.</p>

<p>I don't like these because they are slow (remote requests),
unreliable (errors like form validation, page not found, etc will still return <code>200</code>),
and overall don't provide much value at all.</p>

<p>However in this specific case I still think Smoke Tests can help us,
notably to make a list of what pages the website has,
and also differentiate the ones that are public,
and the ones that should only be accessed by logged in players.</p>

<p>This will be valuable knowledge,
and once we have better test coverage <strong>we can get rid of those</strong>.</p>

<p>After manually navigating the website, checking the <code>pages.php</code> file,
and overall getting familiar with the app,
I've documented my findings in a data provider in the following Smoke Test,
which checks if all private pages are accessible to logged in players,
but not for logged out visitors:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Smoke;

use Bl\Qa\Tests\Infrastructure\Scenario\GetLoggedInPlayer;
use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use Bl\Qa\Tests\Smoke\Assertion\Assert;
use PHPUnit\Framework\Attributes\CoversNothing;
use PHPUnit\Framework\Attributes\DataProvider;
use PHPUnit\Framework\Attributes\Large;
use PHPUnit\Framework\Attributes\TestDox;
use PHPUnit\Framework\TestCase;

#[CoversNothing]
#[Large]
final class PlayerPagesTest extends TestCase
{
    #[TestDox('it blocks $pageName page (`$url`) for visitors')]
    #[DataProvider('playerPagesProvider')]
    public function test_it_blocks_player_page_for_visitors(string $url, string $pageName): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $response = $httpClient-&gt;request('GET', $url);

        Assert::blocksPageForLoggedOutVisitors($response);
    }

    #[TestDox('it loads $pageName page (`$url`) for logged in players')]
    #[DataProvider('playerPagesProvider')]
    public function test_it_loads_player_page_for_logged_in_players(string $url, string $pageName): void
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        $loggedInPlayer = GetLoggedInPlayer::run();

        $response = $httpClient-&gt;request('GET', $url, [
            'headers' =&gt; [
                'Cookie' =&gt; $loggedInPlayer-&gt;sessionCookie,
            ],
        ]);

        Assert::loadsPageForLoggedInPlayers($response);
    }

    /**
     * @return array&lt;array{string, string}&gt;
     */
    public static function playerPagesProvider(): array
    {
        return [
            ['/connected.html', 'account'],
            ['/action.html', 'blow kisses'],
            ['/cerveau.html', 'brain'],
            ['/changepass.html', 'change password'],
            ['/nuage.html', 'clouds'],
            ['/yeux.html', 'eyes'],
            ['/boite.html', 'inbox'],
            ['/bisous.html', 'kisses'],
            ['/construction.html', 'organs'],
            ['/infos.html', 'reference'],
            ['/techno.html', 'techniques'],
            ['/lire.html', 'view message'],
        ];
    }
}
</code></pre>

<p>Running this test <em>should</em> output the following:</p>

<pre><code class="console">&gt; make test arg='--testdox --filter PlayerPages'
PHPUnit 12.3.2 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.11
Configuration: /apps/qa/phpunit.xml.dist

........................                                          24 / 24 (100%)

Time: 00:00.606, Memory: 18.00 MB

Player Pages (Bl\Qa\Tests\Smoke\PlayerPages)
 âœ” it blocks organs page (`/construction.html`) for visitors
 âœ” it blocks account page (`/connected.html`) for visitors
 âœ” it blocks reference page (`/infos.html`) for visitors
 âœ” it blocks kisses page (`/bisous.html`) for visitors
 âœ” it blocks brain page (`/cerveau.html`) for visitors
 âœ” it blocks changeÂ·password page (`/changepass.html`) for visitors
 âœ” it blocks eyes page (`/yeux.html`) for visitors
 âœ” it blocks viewÂ·message page (`/lire.html`) for visitors
 âœ” it blocks clouds page (`/nuage.html`) for visitors
 âœ” it blocks inbox page (`/boite.html`) for visitors
 âœ” it blocks techniques page (`/techno.html`) for visitors
 âœ” it blocks blowÂ·kisses page (`/action.html`) for visitors
 âœ” it loads viewÂ·message page (`/lire.html`) for logged in players
 âœ” it loads eyes page (`/yeux.html`) for logged in players
 âœ” it loads brain page (`/cerveau.html`) for logged in players
 âœ” it loads changeÂ·password page (`/changepass.html`) for logged in players
 âœ” it loads techniques page (`/techno.html`) for logged in players
 âœ” it loads account page (`/connected.html`) for logged in players
 âœ” it loads reference page (`/infos.html`) for logged in players
 âœ” it loads inbox page (`/boite.html`) for logged in players
 âœ” it loads kisses page (`/bisous.html`) for logged in players
 âœ” it loads organs page (`/construction.html`) for logged in players
 âœ” it loads clouds page (`/nuage.html`) for logged in players
 âœ” it loads blowÂ·kisses page (`/action.html`) for logged in players

OK (24 tests, 24 assertions)
</code></pre>

<blockquote>
  <p><em>ğŸ”— Check</em>: <a href="/2025/07/31/phpunit-best-practices.html">PHPUnit Best Practices</a></p>
</blockquote>

<p>The test is structured as follow:</p>

<ol>
<li>get an instance of HttpClient through TestKernelSingleton</li>
<li>optionally run some setup scenario such as <code>SignUpNewPlayer</code>, <code>LogInPlayer</code>, etc</li>
<li>send the remote request, and get the HTTP response</li>
<li>check that the HTTP Response satisfies our expectations</li>
</ol>

<h2 id="custom-assertions">Custom Assertions</h2>

<p>To be able to see if a page is blocked for a non logged in visitor,
we cannot just rely on the HTTP Status (it will always be 200),
so we have to instead check for error messages contained in the page.</p>

<p>Through my search, I've discovered that various messages get displayed when a
logged out visitor tries to access a private page,
I've documented this in the following custom assertion:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Smoke\Assertion;

use PHPUnit\Framework\Assert as PHPUnitAssert;
use Symfony\Contracts\HttpClient\ResponseInterface;

final readonly class Assert
{
    private const array NOT_LOGGED_IN_MESSAGES = [
        // Warning: side bar contains `Tu n'es pas connect&amp;eacute;.`
        'standard' =&gt; 'es pas connectÃ© !!',
        'variant 1 (inbox)' =&gt; 'es pas connect&amp;eacute; !!',
        'variant 2 (kisses, organs, techniques, account)' =&gt; 'Veuillez vous connecter.',
        'variant 3 (reference)' =&gt; 'Erreur... et vouaip !! :D',
    ];

    public static function blocksPageForLoggedOutVisitors(ResponseInterface $response): void
    {
        $content = (string) $response-&gt;getContent();

        foreach (self::NOT_LOGGED_IN_MESSAGES as $message) {
            if (str_contains($content, $message)) {
                PHPUnitAssert::assertSame(200, $response-&gt;getStatusCode(), $content);

                return;
            }
        }

        PHPUnitAssert::fail('Failed asserting that Page is blocked for logged out visitors');
    }

    public static function loadsPageForLoggedInPlayers(ResponseInterface $response): void
    {
        $content = (string) $response-&gt;getContent();

        foreach (self::NOT_LOGGED_IN_MESSAGES as $message) {
            if (str_contains($content, $message)) {
                PHPUnitAssert::fail('Failed asserting that Page loads for logged in players');
            }
        }

        PHPUnitAssert::assertSame(200, $response-&gt;getStatusCode(), $content);
    }
}
</code></pre>

<h2 id="scenarios">Scenarios</h2>

<p>For some of our tests, we need to have a visitor to first sign up as a player,
which I've done through the following "Scenario" class:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;

final readonly class SignUpNewPlayer
{
    public static function run(
        string $username = 'BisouTest',
        string $password = 'password',
        string $passwordConfirmation = 'password',
    ): Player {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        if ('BisouTest' === $username) {
            $username = substr('BisouTest_'.uniqid(), 0, 15);
        }

        $httpClient-&gt;request('POST', '/inscription.html', [
            'body' =&gt; [
                'Ipseudo' =&gt; $username,
                'Imdp' =&gt; $password,
                'Imdp2' =&gt; $passwordConfirmation,
                'inscription' =&gt; "S'inscrire",
            ],
            'headers' =&gt; [
                'Content-Type' =&gt; 'application/x-www-form-urlencoded',
            ],
        ]);

        return new Player($username, $password);
    }
}
</code></pre>

<p>Here we do an HTTP request that will simulate posting the HTML form,
alternatives for this would have been doing a SQL query to directly
create the player in the database, but we risk missing other insertions
that might be required.</p>

<p>The advantage of the current approach is that it also smoke tests the signup form.</p>

<p>We also need the player to be logged in:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

use Bl\Qa\Tests\Infrastructure\TestKernelSingleton;
use Symfony\Component\HttpClient\Exception\RedirectionException;

final readonly class LogInPlayer
{
    public static function run(Player $player): string
    {
        $httpClient = TestKernelSingleton::get()-&gt;httpClient();

        try {
            $response = $httpClient-&gt;request('POST', '/redirect.php', [
                'body' =&gt; [
                    'pseudo' =&gt; $player-&gt;username,
                    'mdp' =&gt; $player-&gt;password,
                    'connexion' =&gt; 'Se connecter',
                ],
                'headers' =&gt; [
                    'Content-Type' =&gt; 'application/x-www-form-urlencoded',
                ],
                'max_redirects' =&gt; 0,
            ]);
        } catch (RedirectionException $e) { // @phpstan-ignore catch.neverThrown
            // With max_redirects=0, HttpClient throws an exception when we get a 302
            // This is expected on successful login
            $response = $e-&gt;getResponse();
        }

        $headers = $response-&gt;getHeaders(false);
        $cookies = $headers['set-cookie'] ?? $headers['Set-Cookie'] ?? [];
        foreach ($cookies as $cookie) {
            if (str_starts_with($cookie, 'PHPSESSID=')) {
                return $cookie;
            }
        }

        $content = $response-&gt;getContent(false);
        $allCookies = implode(', ', $cookies);

        throw new \RuntimeException("Login failed: PHPSESSID cookie not found. Cookies: [{$allCookies}], Content: {$content}");
    }
}
</code></pre>

<p>Similarly to the <code>SignUpNewPlayer</code> scenario,
<code>LogInPlayer</code> posts a HTTP request that simulates the log in form.</p>

<p>To be abe to then act as the logged in player, we need their Session Cookie string,
so we make sure to return it.</p>

<p>Finally the <code>GetLoggedInPlayer</code> scenario will sign up and login a player once,
and always return it to save us some overhead in the test suite:</p>

<pre><code class="php">&lt;?php

declare(strict_types=1);

namespace Bl\Qa\Tests\Infrastructure\Scenario;

final class GetLoggedInPlayer
{
    private static ?LoggedInPlayer $loggedInPlayer = null;

    public static function run(): LoggedInPlayer
    {
        if (null === self::$loggedInPlayer) {
            $player = SignUpNewPlayer::run();
            $sessionCookie = LogInPlayer::run($player);

            self::$loggedInPlayer = new LoggedInPlayer($player-&gt;username, $player-&gt;password, $sessionCookie);
        }

        return self::$loggedInPlayer;
    }
}
</code></pre>

<p>These scenarios will come in handy when we start writing other kinds of tests.</p>

<h2 id="conclusion">Conclusion</h2>

<blockquote>
  <p>ğŸ’» <strong>Source code</strong>:</p>
  
  <ul>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.5">Before our changes</a></li>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.6">After Smoke Tests</a></li>
  </ul>
</blockquote>

<p>Now we can type:</p>

<pre><code class="console">make test arg='--testdox --filter PlayerPages'
</code></pre>

<p>And get the list of all public and private pages.</p>

<blockquote>
  <p>â‰ï¸ <em>What do you mean, "tests are failing"??</em></p>
</blockquote>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[eXtreme Legacy 1: Dockerizing a 2005 LAMP app]]></title>
            <link href="/2025/09/10/xl-1-dockerizing-2005-lamp-app.html"/>
            <updated>2025-09-10T00:00:00+01:00</updated>
            <id>/2025/09/10/xl-1-dockerizing-2005-lamp-app.html</id>
            <content type="html"><![CDATA[<blockquote>
  <p>ğŸ¤˜ From the abyssal depths of forgotten servers,
  Docker the Void-Walker awakens to drag ancient LAMP stack from their tombs,
  wrapping them in the obsidian chains of containerization! ğŸ”¥</p>
</blockquote>

<p>Back in 2005, I learned how to write Linux/Apache/MySQL/PHP websites thanks
to the Site du Zero (SdZ), which is now known as <a href="https://openclassrooms.com/en/">Open Classrooms</a>.</p>

<p>I also used to play a web-browser game, similar to <a href="https://fr.wikipedia.org/wiki/OGame">OGame</a>,
called BisouLand (SkySwoon). Turns out its creator also built it through SdZ tutorials!</p>

<p>Fast forward 20 years later (today),
I received a message on LinkedIn from a CTO asking me the following:</p>

<blockquote>
  <p>ğŸ’¬ "Are you willing to work with <strong>eXtreme Legacy</strong> code on occasion?"</p>
</blockquote>

<p>I wondered to myself: what is eXtreme Legacy code? And I immediately remembered BisouLand.</p>

<p>You see, back in 2011,
its creator had made it Open Source on github and made me code collaborator...</p>

<p>So I <em>do</em> have access to a 2005 LAMP stack website,
cobbled together by someone learning stuff on the go from the internet.</p>

<p>What would it take, in 2025, to get an eXtreme Legacy app up and running?</p>

<p>This is what we're going to find out in this series.</p>

<p>Today's first article is about getting it to run, at least locally.</p>

<ul>
<li><a href="#the-project">The Project</a></li>
<li><a href="#containerization">Containerisation</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="the-project">The Project</h2>

<p>The <a href="https://github.com/pyricau/bisouland/tree/v1">version 1</a> has the following tree directory:</p>

<pre><code>web/
â”œâ”€â”€ .htaccess
â”œâ”€â”€ checkConnect.php
â”œâ”€â”€ deconnexion.php
â”œâ”€â”€ favicon.ico
â”œâ”€â”€ images/
â”œâ”€â”€ includes/
â”‚Â Â  â”œâ”€â”€ bisouStyle2.css
â”‚Â Â  â”œâ”€â”€ compteur.js
â”‚Â Â  â”œâ”€â”€ newbisouStyle2.css
â”‚Â Â  â””â”€â”€ prev.js
â”œâ”€â”€ index.php
â”œâ”€â”€ phpincludes/
â”‚Â Â  â”œâ”€â”€ accueil.php
â”‚Â Â  â”œâ”€â”€ action.php
â”‚Â Â  â”œâ”€â”€ aide.php
â”‚Â Â  â”œâ”€â”€ attaque.php
â”‚Â Â  â”œâ”€â”€ bd.php
â”‚Â Â  â”œâ”€â”€ bisous.php
â”‚Â Â  â”œâ”€â”€ confirmation.php
â”‚Â Â  â”œâ”€â”€ connected.php
â”‚Â Â  â”œâ”€â”€ connexion.php
â”‚Â Â  â”œâ”€â”€ erreur404.php
â”‚Â Â  â”œâ”€â”€ evo.php
â”‚Â Â  â”œâ”€â”€ fctIndex.php
â”‚Â Â  â”œâ”€â”€ nuage.php
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â”œâ”€â”€ pages.php
â”‚Â Â  â””â”€â”€ yeux.php
â””â”€â”€ redirect.php
</code></pre>

<p>The <code>.htaccess</code> file contains URL rewrite rules for Apache:</p>

<pre><code>RewriteEngine on
RewriteRule (.+)\.confirmation\.html$ /index.php?page=confirmation&amp;id=$1
RewriteRule (.+)\.bisous\.html$ /index.php?page=bisous&amp;cancel=$1
RewriteRule (.+)\.(.+)\.nuage\.html$ /index.php?page=nuage&amp;saut=1&amp;sautnuage=$1&amp;sautposition=$2
RewriteRule (.+)\.nuage\.html$ /index.php?page=nuage&amp;nuage=$1
RewriteRule (.+)\.(.+)\.action\.html$ /index.php?page=action&amp;nuage=$1&amp;position=$2
RewriteRule (.+)\.(.+)\.yeux\.html$ /index.php?page=yeux&amp;Dnuage=$1&amp;Dpos=$2
RewriteRule (.+)\.html$ /index.php?page=$1
ErrorDocument 404 /erreur404.html
</code></pre>

<p>There are no Database schema, but a quick scan at the files will reveal the use
of MySQL, for example <code>web/phpincludes/bd.php</code>:</p>

<pre><code class="php">&lt;?php

function bd_connect() {
        mysql_pconnect("HOST", "USER", "PASSWORD");
        mysql_select_db("DATABASE");
}
</code></pre>

<p>As for the code architecture, the file <code>web/index.php</code> acts as a
front controller that displays the layout of the website, and then includes
a file from <code>web/phpincludes/</code> for the actual page content.</p>

<p>The HTML is mixed with the MySQL queries, session managemenet, game logic
and any other PHP code. Code and comments are written in French, and there are
several encoding issues.</p>

<p>Here's an extract from <code>web/index.php</code>:</p>

<pre><code class="php">&lt;?php

header('Content-type: text/html; charset=ISO-8859-1'); 

session_start();
ob_start();
include 'phpincludes/bd.php';
bd_connect();
include('phpincludes/fctIndex.php');

//Si la variable $_SESSION['logged'] n'existe pas, on la crÃ©Ã©e, et on l'initialise a false
if (!isset($_SESSION['logged'])) $_SESSION['logged'] = false;

//Si on est pas connectÃ©.
if ($_SESSION['logged'] == false)
{
  $id=0;
  //On rÃ©cupÃ¨re les cookies enregistrÃ©s chez l'utilisateurs, s'ils sont la.
  if (isset($_COOKIE['pseudo']) &amp;&amp; isset($_COOKIE['mdp']))
  {
    $pseudo = htmlentities(addslashes($_COOKIE['pseudo']));
    $mdp = htmlentities(addslashes($_COOKIE['mdp']));
    //La requÃªte qui compte le nombre de pseudos
    $sql = mysql_query("SELECT COUNT(*) AS nb_pseudo FROM membres WHERE pseudo='".$pseudo."'");
    if (mysql_result($sql,0,'nb_pseudo') != 0)
    {
      //SÃ©lection des informations.
      $sql_info = mysql_query("SELECT id, confirmation, mdp, nuage FROM membres WHERE pseudo='".$pseudo."'");
      $donnees_info = mysql_fetch_assoc($sql_info);
      //Si le mot de passe est le mÃªme (le mot de passe est dÃ©jÃ  cryptÃ©).
      if ($donnees_info['mdp'] == $mdp)
      {
        //Si le compte est confirmÃ©.
        if ($donnees_info['confirmation'] == 1)
        {
          //On modifie la variable qui nous indique que le membre est connectÃ©.
          $_SESSION['logged'] = true;
          $page='cerveau';
        }
      }
    }
  }
}

if ($_SESSION['logged'] == true)
{
  //l'id du membre.
  $id=$_SESSION['id'];

  //Fonction destinÃ©e Ã  l'administration
  if (isset($_POST['UnAct']) &amp;&amp; $id==12)
  {
    actionAdmin();
  }

  $sql_info = mysql_query(
    "SELECT timestamp, coeur, bouche, amour, jambes, smack, baiser, pelle, tech1, tech2, tech3, tech4, dent, langue, bloque, soupe, oeil"
    ." FROM membres WHERE id='".$id."'"
  );
  $donnees_info = mysql_fetch_assoc($sql_info);
  //On rÃ©cupÃ¨re le nombre de points d'amour.
  $amour = $donnees_info['amour'];
?&gt;

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /&gt; 
  &lt;link rel="stylesheet" media="screen" type="text/css" title="bisouStyle2" href="includes/bisouStyle2.css" /&gt; 
  &lt;link rel="shorcut icon" href="http://bisouland.piwai.info/favicon.ico"/&gt;
  &lt;meta http-equiv="Content-Language" content="fr" /&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="speedbarre"&gt;
  &lt;?php if ($_SESSION['logged'] == true)
    {?&gt;
      &lt;?php echo formaterNombre(floor($amour)); ?&gt;
    &lt;?php
    }
    else
    {
    ?&gt;
    &lt;a href="connexion.html"&gt;Connexion&lt;/a&gt;
    &lt;?php } ?&gt;
  &lt;/div&gt;

  &lt;div id="corps"&gt;
    &lt;?php
    include('phpincludes/pages.php');
    if (isset($array_pages[$page]))
    {
      include('phpincludes/'.$array_pages[$page]);
    }
    else
    {
      include('phpincludes/erreur404.php');
    }
    ?&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>ğŸ˜µ</p>

<p>In addition to the spaghetti code, we can immediately spot security issues.
But we cannot fix anything until we can manually test the website,
so how do we get it to run?</p>

<h2 id="containerisation">Containerisation</h2>

<p>Back in 2005, the most common versions of the LAMP stack were:</p>

<ul>
<li>Apache: 2</li>
<li>MySQL: MySQL 4.0 - 5.0</li>
<li>PHP 4.3 - 5.1</li>
</ul>

<p>Applications written for MySQL 4.0 and PHP 4.3 can be run up to MySQL 5.7
and PHP 5.6. Some deprecation notices would be issued, but in terms of backward
compatibility that's how far we can stretch things.</p>

<p>So let's create a <code>Dockerfile</code> that will have Apache 2, PHP 5.6 and MySQL 5.7:</p>

<pre><code># syntax=docker/dockerfile:1

FROM php:5.6-apache

# Update sources.list to use archive repositories for Debian Stretch
RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list \
    &amp;&amp; sed -i 's/security.debian.org/archive.debian.org/g' /etc/apt/sources.list \
    &amp;&amp; sed -i '/stretch-updates/d' /etc/apt/sources.list

# Install system dependencies and PHP extensions in single layer
RUN docker-php-ext-install mysql \
    &amp;&amp; a2enmod rewrite

# Set working directory
WORKDIR /var/www/html

# Copy application files with proper ownership
COPY --chown=www-data:www-data web/ /var/www/html/
</code></pre>

<p>With the following <code>compose.yaml</code>, we'll set up the Apache and MySQL servers:</p>

<pre><code class="yaml">name: skyswoon-monolith

services:
  web:
    build: .
    ports:
      - "8080:80"
    volumes:
      - ./web:/var/www/html
    depends_on:
      - db
    environment:
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_NAME: ${DATABASE_NAME}
    restart: unless-stopped

  db:
    image: mysql:5.7
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DATABASE_NAME}
      MYSQL_USER: ${DATABASE_USER}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "127.0.0.1:3306:3306"
    restart: unless-stopped

volumes:
  mysql_data:
</code></pre>

<p>You might notice that I've mentioned some environment variables,
to configure the database. These will need to be set in a <code>.env</code> file:</p>

<pre><code># Database
DATABASE_HOST=db
DATABASE_USER=database_user
DATABASE_PASSWORD=database_password
DATABASE_NAME=database_name
# MySQL root password (for Docker)
MYSQL_ROOT_PASSWORD=mysql_root_password
</code></pre>

<p>When the <code>docker compose up</code> is run,
Docker Composer automatically reads from <code>.env</code> and sets the environment variable,
then PHP will copy these into the <code>$_ENV</code> array super global,
so we can get the values like so in <code>web/phpincludes/bd.php</code>:</p>

<pre><code class="php">&lt;?php

function bd_connect()
{
    mysql_pconnect(
        $_ENV['DATABASE_HOST'],
        $_ENV['DATABASE_USER'],
        $_ENV['DATABASE_PASSWORD'],
    );
    mysql_select_db($_ENV['DATABASE_NAME']);
}
</code></pre>

<p>Last but not least, I'm adding a <code>Makefile</code>, to avoid having to type long
<code>docker compose build; docker compose up</code> commands: <a href="https://github.com/pyricau/bisouland/blob/b31597c47a49e0dd2b87fbd55bd608530f81efec/Makefile">see file in github</a>.</p>

<blockquote>
  <p><strong>Super Secret Tip</strong>:
  I've written about <a href="/2025/08/06/my-symfony-dockerfile.html">My Symfony Dockerfile</a>,
  and <a href="/2025/08/06/my-symfony-makefile.html">My Symfony Makefile</a>.</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<blockquote>
  <p>ğŸ’» <strong>Source code</strong>:</p>
  
  <ul>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.0">Before our changes</a></li>
  <li><a href="https://github.com/pyricau/bisouland/tree/4.0.5">After containerisation</a></li>
  </ul>
</blockquote>

<p><img alt="BisouLand screenshot" src="/images/xl-1-bisouland-screenshot.png" width="100%" /></p>

<p>And we did it! now by typing:</p>

<pre><code class="console">make build; make up
</code></pre>

<p>We get BisouLand running live, 20 years after its conception.</p>

<p>You can visit it there: http://localhost:8080/accueil.html.</p>

<blockquote>
  <p>â‰ï¸ <em>What do you mean, "it doesn't work"?? It works on my machine!</em></p>
</blockquote>
]]></content>
        </entry>
    </feed>