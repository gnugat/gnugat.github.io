---
layout: post
title: "eXtreme Legacy 6: PHP 8"
tags:
    - extreme-legacy
---

> ğŸ¤˜ The Migration Warlord breaks the rusted shackles of PHP 5.6,
> leading the great exodus through the valleys of breaking changes,
> into the promised land of PHP 8.4 where type hints and constructor property promotion await in glory! ğŸ”¥

In this series, we're dealing with BisouLand, an eXtreme Legacy application
(2005 LAMP spaghetti code base). So far, we have:

1. [ğŸ‹ got it to run in a local container](/2025/09/10/xl-1-dockerizing-2005-lamp-app.html)
2. [ğŸ’¨ written Smoke Tests](/2025/09/17/xl-2-smoke-tests.html)
3. [ğŸ¯ written End to End Tests](/2025/09/24/xl-3-end-to-end-tests.html)
4. [ğŸ§¹ created and applied Coding Standards](/2025/10/01/xl-4-coding-standards.html)
5. [â›ƒ migrated to PDO](/2025/10/22/xl-5-pdo.html)

This means we can run it locally (http://localhost:43000/),
and have some level of automated tests.

But it's still stuck in the past with PHP 5.6,
so let's upgrade it to PHP 8.4!

* [Docker](#docker)
* [Rector](#rector)
* [PHP CS Fixer](#php-cs-fixer)
* [Conclusion](#conclusion)

## Docker

With the migration from the deprecated MySQL extension to PDO,
BisouLand's codebase is technically compatible with the latest PHP version.

Upgrading it is as simple as modifying the monolith's Dockerfile:

```diff
- # Uses PHP 5.6 with PDO MySQL driver
+ # Uses PHP 8.4 with PDO MySQL driver

- FROM php:5.6-apache
- 
- # Update sources.list to use archive repositories for Debian Stretch
- RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list \
-     && sed -i 's/security.debian.org/archive.debian.org/g' /etc/apt/sources.list \
-     && sed -i '/stretch-updates/d' /etc/apt/sources.list
+ FROM php:8.4-apache
```

We can now build the new image:

```console
cd apps/monolith
make app-init # docker down, docker build, docker up 
```

And that's it!

## Rector

Your eXtreme Legacy application might not be as lucky as BisouLand,
and might require more work for an upgrade.

## PHP CS Fixer

With the latest version of PHP, we can 

## Conclusion

With a modern version of PHP, not only do we get security patches,
exciting new feature (typed code, constructor property promotion, readonly final classes, etc),
as well as access to many modern tools and libraries (composer, Symfony components, etc),
but we also get a boost in performance.

Let's back up that last claim by running some vanity benchmarks as follow:

1. start a fresh Monolith container
2. sign up and log in a temporary account
3. test load the homepage, as a visitor (not logged in)
4. test load the Brain page (logged in)

```console
# Start fresh
cd apps/monolith
make app-init

BENCH_USER="BisouTest_bench"
BENCH_PASS="SuperSecret123"

# Sign up
curl -X POST 'http://localhost:43000/inscription.html' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "Ipseudo=${BENCH_USER}&Imdp=${BENCH_PASS}&Imdp2=${BENCH_PASS}&inscription=S%27inscrire"

# Log in
BENCH_COOKIE=$(curl -X POST 'http://localhost:43000/redirect.php' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d "pseudo=${BENCH_USER}&mdp=${BENCH_PASS}&connexion=Se+connecter" \
  -i -s | grep -i 'set-cookie: PHPSESSID' | sed 's/.*PHPSESSID=\([^;]*\).*/\1/' | tr -d '\r')

# Test load homepage (not signed in)
ab -l -q -k -c 50 -n 10000 http://localhost:43000/ \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"

# Test load Brain page (signed in)
ab -l -q -k -c 50 -n 10000 -C "PHPSESSID=$BENCH_COOKIE" http://localhost:43000/cerveau.html \
    | grep -E "Complete requests|Failed requests|Exception|Requests per second|Time per request.*across"
```

On my MacBook M4 (with Docker), the results are as follow:

* Homepage: `+8.9%` improvement
    * Requests per second (mean):
      from `545.67` to `594.49`
    * Time per request (ms, mean, across all concurrent requests):
      from `1.833` to `1.682`
* Brain Page: `+30.2%` improvement
    * Requests per second (mean):
      from `313.88` to `408.78`
    * Time per request (ms, mean, across all concurrent requests):
      from `3.186` to `2.446`

Surely with such almighty gains we won't need to rewrite BisouLand in go / rust.

> â‰ï¸ What do you mean, "the code is still unrefactorable"?
